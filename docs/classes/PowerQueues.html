<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>PowerQueues | power-queues API Docs - v2.0.16</title><meta name="description" content="Documentation for power-queues API Docs"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">power-queues API Docs - v2.0.16</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="" aria-current="page">PowerQueues</a></li></ul><h1>Class PowerQueues</h1></div><section class="tsd-panel tsd-comment"><div class="tsd-comment tsd-typography"><p>High-level Redis Streams worker built on top of PowerRedis.</p>
<p><code>PowerQueues</code> turns a Redis Stream into a <strong>reliable background queue</strong>
with batching, retry logic, dead-letter queue (DLQ), and optional
idempotent processing.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks">Remarks<a href="#remarks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>This class is designed to be <strong>extended</strong> in your application code.
You typically:</p>
<ol>
<li>Subclass <code>PowerQueues</code>.</li>
<li>Override lifecycle hooks such as:
<ul>
<li><a href="#onexecute" class="tsd-kind-method">onExecute</a> - main job handler.</li>
<li><a href="#onsuccess" class="tsd-kind-method">onSuccess</a> - called on successful execution.</li>
<li><a href="#onerror" class="tsd-kind-method">onError</a> - called on failure.</li>
<li><a href="#onretry" class="tsd-kind-method">onRetry</a> - called when a retry is scheduled.</li>
<li><a href="#onbatcherror" class="tsd-kind-method">onBatchError</a> - batch-level error handler.</li>
</ul>
</li>
<li>Configure <code>stream</code>, <code>group</code>, and <code>consumerHost</code> to match your queue name and worker identity.</li>
<li>Call <a href="#runqueue" class="tsd-kind-method">runQueue</a> to start the consumer loop.</li>
</ol>
<p>Under the hood it:</p>
<ul>
<li>Uses Redis <strong>Streams + Consumer Groups</strong> for message delivery.</li>
<li>Stores tasks in batches via a Lua script (<code>XAddBulk</code>) for high throughput.</li>
<li>Automatically <strong>claims stuck</strong> messages using <code>XAUTOCLAIM</code> (see <code>SelectStuck</code> script).</li>
<li>Supports <strong>idempotent execution</strong> using a <code>done/lock/start</code> key pattern in Redis:
<ul>
<li>Avoids duplicate execution when the same idempotency key is seen again.</li>
<li>Uses a short-lived lock and heartbeat to coordinate multiple workers.</li>
</ul>
</li>
<li>Tracks <strong>attempt counts</strong> per message and pushes failed tasks to a <code>:dlq</code> stream
when <code>workerMaxRetries</code> is reached.</li>
</ul>
<p>The public readonly properties (like <code>addingBatchTasksCount</code>, <code>workerBatchTasksCount</code>,
<code>workerExecuteLockTimeoutMs</code>, etc.) define core behaviour:</p>
<ul>
<li><strong>Batching / insertion</strong>
<ul>
<li><code>addingBatchTasksCount</code> / <code>addingBatchKeysLimit</code> control how many tasks
are grouped into a single Redis call when using <a href="#addtasks" class="tsd-kind-method">addTasks</a>.</li>
</ul>
</li>
<li><strong>Worker behaviour</strong>
<ul>
<li><code>workerBatchTasksCount</code> limits how many messages are read/claimed per loop.</li>
<li><code>workerLoopIntervalMs</code> and <code>workerSelectionTimeoutMs</code> control how often the
worker checks for new or stuck tasks.</li>
<li><code>workerMaxRetries</code> and <code>workerClearAttemptsTimeoutMs</code> define retry strategy
and how long attempt counters are kept.</li>
</ul>
</li>
<li><strong>Idempotency / status tracking</strong>
<ul>
<li><code>workerExecuteLockTimeoutMs</code> and <code>workerCacheTaskTimeoutMs</code> control lock and
completion marker TTLs for idempotent jobs.</li>
<li><code>executeJobStatus</code> and <code>executeJobStatusTtlMs</code> enable simple per-job metrics
(<code>ok</code>, <code>err</code>, <code>ready</code> counters stored in Redis).</li>
</ul>
</li>
<li><strong>Cleanup / deletion</strong>
<ul>
<li><code>removeOnExecuted</code> and <code>approveBatchTasksCount</code> control how processed
messages are acknowledged and optionally deleted from the stream.</li>
</ul>
</li>
</ul>
<p>The main entrypoints you will commonly use are:</p>
<ul>
<li><a href="#addtasks" class="tsd-kind-method">addTasks</a> - enqueue tasks into a Redis Stream
(with optional idempotency and basic status keys).</li>
<li><a href="#runqueue" class="tsd-kind-method">runQueue</a> - create consumer group (if needed)
and start the long-running consumer loop.</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example">Example<a href="#example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-5">PowerQueues</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&#39;power-queues&#39;</span><span class="hl-1">;</span><br/><span class="hl-6">import</span><span class="hl-1"> </span><span class="hl-6">type</span><span class="hl-1"> { </span><span class="hl-5">IORedisLike</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&#39;power-redis&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-8">EmailQueue</span><span class="hl-1"> </span><span class="hl-3">extends</span><span class="hl-1"> </span><span class="hl-8">PowerQueues</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-5">redis</span><span class="hl-1">: </span><span class="hl-8">IORedisLike</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-5">stream</span><span class="hl-1"> = </span><span class="hl-2">&#39;queue:emails&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-5">group</span><span class="hl-1"> = </span><span class="hl-2">&#39;email-workers&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-3">readonly</span><span class="hl-1"> </span><span class="hl-5">consumerHost</span><span class="hl-1"> = </span><span class="hl-2">&#39;worker-1&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-3">constructor</span><span class="hl-1">(</span><span class="hl-5">redis</span><span class="hl-1">: </span><span class="hl-8">IORedisLike</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">super</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">redis</span><span class="hl-1"> = </span><span class="hl-5">redis</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// Main handler: process a single task payload</span><br/><span class="hl-1">  </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">onExecute</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-8">any</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-8">number</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">idemKey</span><span class="hl-1">: </span><span class="hl-8">string</span><span class="hl-1"> | </span><span class="hl-8">undefined</span><span class="hl-1">,</span><br/><span class="hl-1">  ) {</span><br/><span class="hl-1">    </span><span class="hl-9">// Your business logic here, e.g. send an email</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-9">// Usage example:</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">queue</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">EmailQueue</span><span class="hl-1">(</span><span class="hl-5">redisClient</span><span class="hl-1">);</span><br/><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">runQueue</span><span class="hl-1">(); </span><span class="hl-9">// start consuming</span><br/><br/><span class="hl-9">// Later, enqueue tasks:</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">addTasks</span><span class="hl-1">(</span><span class="hl-2">&#39;queue:emails&#39;</span><span class="hl-1">, [</span><br/><span class="hl-1">  { </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">to:</span><span class="hl-1"> </span><span class="hl-2">&#39;user@example.com&#39;</span><span class="hl-1">, </span><span class="hl-5">subject:</span><span class="hl-1"> </span><span class="hl-2">&#39;Hello&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">]);</span>
</code><button type="button">Copy</button></pre>

</div></div></section><section class="tsd-panel tsd-hierarchy" data-refl="1"><h4>Hierarchy</h4><ul class="tsd-hierarchy"><li class="tsd-hierarchy-item"><span class="tsd-signature-type external">PowerRedis</span><ul class="tsd-hierarchy"><li class="tsd-hierarchy-item"><span class="tsd-hierarchy-target">PowerQueues</span></li></ul></li></ul></section><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L133">PowerQueues.ts:133</a></li></ul></aside><section class="tsd-panel-group tsd-index-group"><section class="tsd-panel tsd-index-panel"><details class="tsd-index-content tsd-accordion" open><summary class="tsd-accordion-summary tsd-index-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h5 class="tsd-index-heading uppercase">Index</h5></summary><div class="tsd-accordion-details"><section class="tsd-index-section"><h3 class="tsd-index-heading">Constructors</h3><div class="tsd-index-list"><a href="#constructor" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Constructor"><use href="../assets/icons.svg#icon-512"></use></svg><span>constructor</span></a>
</div></section><section class="tsd-index-section"><h3 class="tsd-index-heading">Properties</h3><div class="tsd-index-list"><a href="#abort" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>abort</span></a>
<a href="#addingbatchkeyslimit" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>adding<wbr/>Batch<wbr/>Keys<wbr/>Limit</span></a>
<a href="#addingbatchtaskscount" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>adding<wbr/>Batch<wbr/>Tasks<wbr/>Count</span></a>
<a href="#approvebatchtaskscount" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>approve<wbr/>Batch<wbr/>Tasks<wbr/>Count</span></a>
<a href="#consumerhost" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>consumer<wbr/>Host</span></a>
<a href="#executebatchatonce" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>execute<wbr/>Batch<wbr/>At<wbr/>Once</span></a>
<a href="#executejobstatus" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>execute<wbr/>Job<wbr/>Status</span></a>
<a href="#executejobstatusttlms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>execute<wbr/>Job<wbr/>Status<wbr/>Ttl<wbr/>Ms</span></a>
<a href="#group" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>group</span></a>
<a href="#recoverystucktaskstimeoutms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>recovery<wbr/>Stuck<wbr/>Tasks<wbr/>Timeout<wbr/>Ms</span></a>
<a href="#redis" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>redis</span></a>
<a href="#removeonexecuted" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>remove<wbr/>On<wbr/>Executed</span></a>
<a href="#scripts" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>scripts</span></a>
<a href="#stream" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>stream</span></a>
<a href="#workerbatchtaskscount" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Batch<wbr/>Tasks<wbr/>Count</span></a>
<a href="#workercachetasktimeoutms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Cache<wbr/>Task<wbr/>Timeout<wbr/>Ms</span></a>
<a href="#workerclearattemptstimeoutms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Clear<wbr/>Attempts<wbr/>Timeout<wbr/>Ms</span></a>
<a href="#workerexecutelocktimeoutms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Execute<wbr/>Lock<wbr/>Timeout<wbr/>Ms</span></a>
<a href="#workerloopintervalms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Loop<wbr/>Interval<wbr/>Ms</span></a>
<a href="#workermaxretries" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Max<wbr/>Retries</span></a>
<a href="#workerselectiontimeoutms" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Selection<wbr/>Timeout<wbr/>Ms</span></a>
</div></section><section class="tsd-index-section"><h3 class="tsd-index-heading">Methods</h3><div class="tsd-index-list"><a href="#addtasks" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>add<wbr/>Tasks</span></a>
<a href="#approve" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>approve</span></a>
<a href="#attempt" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>attempt</span></a>
<a href="#attemptskey" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>attempts<wbr/>Key</span></a>
<a href="#batcherror" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>batch<wbr/>Error</span></a>
<a href="#buildbatches" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>build<wbr/>Batches</span></a>
<a href="#clearattempts" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>clear<wbr/>Attempts</span></a>
<a href="#consumer" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>consumer</span></a>
<a href="#consumerloop" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>consumer<wbr/>Loop</span></a>
<a href="#creategroup" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>create<wbr/>Group</span></a>
<a href="#error" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>error</span></a>
<a href="#execute" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>execute</span></a>
<a href="#executeprocess" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>execute<wbr/>Process</span></a>
<a href="#getattempts" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>get<wbr/>Attempts</span></a>
<a href="#heartbeat" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>heartbeat</span></a>
<a href="#idempotency" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency</span></a>
<a href="#idempotencyallow" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Allow</span></a>
<a href="#idempotencydone" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Done</span></a>
<a href="#idempotencyfree" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Free</span></a>
<a href="#idempotencykeys" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Keys</span></a>
<a href="#idempotencystart" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Start</span></a>
<a href="#incrattempts" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>incr<wbr/>Attempts</span></a>
<a href="#keyslength" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>keys<wbr/>Length</span></a>
<a href="#loadscript" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>load<wbr/>Script</span></a>
<a href="#loadscripts" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>load<wbr/>Scripts</span></a>
<a href="#normalizeentries" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>normalize<wbr/>Entries</span></a>
<a href="#onbatcherror" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Batch<wbr/>Error</span></a>
<a href="#onerror" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Error</span></a>
<a href="#onexecute" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Execute</span></a>
<a href="#onready" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Ready</span></a>
<a href="#onretry" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Retry</span></a>
<a href="#onselected" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Selected</span></a>
<a href="#onsuccess" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Success</span></a>
<a href="#payload" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>payload</span></a>
<a href="#payloadbatch" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>payload<wbr/>Batch</span></a>
<a href="#runqueue" class="tsd-index-link"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>run<wbr/>Queue</span></a>
<a href="#runscript" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>run<wbr/>Script</span></a>
<a href="#savescript" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>save<wbr/>Script</span></a>
<a href="#select" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>select</span></a>
<a href="#selectfresh" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>select<wbr/>Fresh</span></a>
<a href="#selectstuck" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>select<wbr/>Stuck</span></a>
<a href="#sendheartbeat" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>send<wbr/>Heartbeat</span></a>
<a href="#signal" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>signal</span></a>
<a href="#success" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>success</span></a>
<a href="#values" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>values</span></a>
<a href="#waitabortable" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>wait<wbr/>Abortable</span></a>
<a href="#xaddbatch" class="tsd-index-link tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>xadd<wbr/>Batch</span></a>
</div></section></div></details></section></section><details class="tsd-panel-group tsd-member-group tsd-accordion" open><summary class="tsd-accordion-summary" data-key="section-Constructors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h2>Constructors</h2></summary><section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="constructor"><span>constructor</span><a href="#constructor" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="constructorpowerqueues"><span class="tsd-signature-keyword">new</span> <span class="tsd-kind-constructor-signature">PowerQueues</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <a href="" class="tsd-signature-type tsd-kind-class">PowerQueues</a><a href="#constructorpowerqueues" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><h4 class="tsd-returns-title">Returns <a href="" class="tsd-signature-type tsd-kind-class">PowerQueues</a></h4><aside class="tsd-sources"><p>Inherited from PowerRedis.constructor</p></aside></div></li></ul></section></section></details><details class="tsd-panel-group tsd-member-group tsd-accordion" open><summary class="tsd-accordion-summary" data-key="section-Properties"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h2>Properties</h2></summary><section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="abort"><span>abort</span><a href="#abort" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">abort</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">AbortController</span><span class="tsd-signature-symbol"> = ...</span></div><div class="tsd-comment tsd-typography"><p>A controller used to manage cancellation signals inside the queue worker.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-1">Remarks<a href="#remarks-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>PowerQueues uses an internal AbortController to safely stop
long-running operations (such as waiting, heartbeats, or worker loops)
without forcing the process to crash.</p>
<p>When <code>abort()</code> is triggered:</p>
<ul>
<li>all functions that listen to <code>abort.signal</code> will stop as soon as possible</li>
<li>pending delays (in <code>waitAbortable</code>) are cleared</li>
<li>background loops (like <code>consumerLoop</code>) exit gracefully</li>
</ul>
<p>This provides a clean and predictable shutdown mechanism for the worker.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-1">Example<a href="#example-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Stop the queue worker from outside</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">abort</span><span class="hl-1">.</span><span class="hl-0">abort</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-tag-see"><h4 class="tsd-anchor-link" id="see">See<a href="#see" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li>AbortController</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController">https://developer.mozilla.org/en-US/docs/Web/API/AbortController</a></li>
</ul>
</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L162">PowerQueues.ts:162</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="addingbatchkeyslimit"><code class="tsd-tag">Readonly</code><span>adding<wbr/>Batch<wbr/>Keys<wbr/>Limit</span><a href="#addingbatchkeyslimit" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">addingBatchKeysLimit</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 10000</span></div><div class="tsd-comment tsd-typography"><p>Maximum total number of Redis field/value pairs allowed in a single batch.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-2">Remarks<a href="#remarks-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When PowerQueues builds XADD batches, it must ensure that the final Redis
command does not become too large. Every task contributes multiple
field/value pairs (for example: <code>payload</code>, <code>createdAt</code>, <code>job</code>, <code>idemKey</code>, etc.).</p>
<p><code>addingBatchKeysLimit</code> defines the <strong>hard limit</strong> for how many
total key/value tokens may be included in one batch before the batch
is split into smaller ones.</p>
<p>This prevents:</p>
<ul>
<li>oversized XADD commands,</li>
<li>excessive memory usage,</li>
<li>Redis &quot;argument list too long&quot; / &quot;command too large&quot; issues,</li>
<li>network frame fragmentation.</li>
</ul>
<p>Combined with <a href="#addingbatchtaskscount" class="tsd-kind-property">addingBatchTasksCount</a>, this creates a dual safety
mechanism: limit by number of tasks <strong>and</strong> limit by number of fields.</p>
<p>Default value <code>10000</code> is optimized for:</p>
<ul>
<li>stable high-throughput ingestion,</li>
<li>minimal risk of large-packet bottlenecks,</li>
<li>predictable batch sizing under varied payloads.</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-2">Example<a href="#example-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Reduce batch size for very large payloads</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">addingBatchKeysLimit</span><span class="hl-1"> = </span><span class="hl-7">3000</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L293">PowerQueues.ts:293</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="addingbatchtaskscount"><code class="tsd-tag">Readonly</code><span>adding<wbr/>Batch<wbr/>Tasks<wbr/>Count</span><a href="#addingbatchtaskscount" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">addingBatchTasksCount</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 800</span></div><div class="tsd-comment tsd-typography"><p>Maximum number of tasks allowed in a single XADD batch.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-3">Remarks<a href="#remarks-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When adding many tasks at once, PowerQueues groups them into batches
before sending them to Redis. This improves throughput and reduces
network overhead while preventing oversized Redis commands.</p>
<p><code>addingBatchTasksCount</code> defines the <strong>upper limit</strong> of how many tasks
can be bundled into one batch during <code>addTasks()</code> → <code>xaddBatch()</code> calls.</p>
<p>A lower value = safer for memory and network stability.<br>
A higher value = fewer XADD calls, higher throughput, but larger payloads.</p>
<p>Default value <code>800</code> is tuned for:</p>
<ul>
<li>high-performance ingestion</li>
<li>safe XADD command size</li>
<li>good balance between speed and memory usage</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-3">Example<a href="#example-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Allow larger batches when inserting many tasks at once</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">addingBatchTasksCount</span><span class="hl-1"> = </span><span class="hl-7">2000</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L256">PowerQueues.ts:256</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="approvebatchtaskscount"><code class="tsd-tag">Readonly</code><span>approve<wbr/>Batch<wbr/>Tasks<wbr/>Count</span><a href="#approvebatchtaskscount" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">approveBatchTasksCount</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 2000</span></div><div class="tsd-comment tsd-typography"><p>Maximum number of task IDs acknowledged (XACK) in a single approval batch.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-4">Remarks<a href="#remarks-4" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>After tasks are processed successfully, PowerQueues must acknowledge them
in Redis using <code>XACK</code>, and optionally delete them via <code>XDEL</code>.</p>
<p>To avoid sending extremely large XACK/XDEL commands, the IDs are processed
in batches. <code>approveBatchTasksCount</code> defines the maximum number of IDs
included in one batch when calling <a href="#approve" class="tsd-kind-method">approve</a>.</p>
<p>Why batching matters:</p>
<ul>
<li>prevents Redis from receiving oversized argument lists</li>
<li>improves throughput when approving many tasks at once</li>
<li>reduces memory spikes in the Redis command parser</li>
</ul>
<p>Internally, the value is clamped to:</p>
<ul>
<li><strong>minimum:</strong> 500</li>
<li><strong>maximum:</strong> 4000</li>
</ul>
<p>This ensures safe, stable performance even if the user sets unusual values.</p>
<p>Default value <code>2000</code> provides:</p>
<ul>
<li>fast acknowledgements</li>
<li>safe command sizes</li>
<li>good balance for high-volume queues</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-4">Example<a href="#example-4" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// For very large task flows, increase the approval batch size</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">approveBatchTasksCount</span><span class="hl-1"> = </span><span class="hl-7">3500</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L398">PowerQueues.ts:398</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="consumerhost"><code class="tsd-tag">Readonly</code><span>consumer<wbr/>Host</span><a href="#consumerhost" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">consumerHost</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol"> = &#39;host&#39;</span></div><div class="tsd-comment tsd-typography"><p>Logical identifier of the machine or environment running this consumer.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-5">Remarks<a href="#remarks-5" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>PowerQueues includes the consumer identity in the Redis consumer name,
which is formatted as:</p>
<pre><code><span class="hl-1">{</span><span class="hl-5">consumerHost</span><span class="hl-1">}:{process.</span><span class="hl-5">pid</span><span class="hl-1">}</span>
</code><button>Copy</button></pre>

<p>This helps distinguish between different workers in Redis Stream groups,
especially when multiple machines or Docker containers process the same queue.</p>
<p><code>consumerHost</code> does <strong>not</strong> need to be the real hostname.<br>
It can be any identifier meaningful to your infrastructure:</p>
<ul>
<li><code>'api-server-1'</code></li>
<li><code>'worker-eu-west'</code></li>
<li><code>'node-A'</code></li>
<li><code>process.env.HOSTNAME</code></li>
</ul>
<p>A good value improves:</p>
<ul>
<li>debugging (which worker processed what)</li>
<li>monitoring of worker activity</li>
<li>load-balancing visibility</li>
</ul>
<p>Default value <code>'host'</code> ensures a valid fallback, but in production you
should override it with an actual machine/service identifier.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-5">Example<a href="#example-5" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">consumerHost</span><span class="hl-1"> = </span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-4">HOSTNAME</span><span class="hl-1"> || </span><span class="hl-2">&#39;worker-1&#39;</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L596">PowerQueues.ts:596</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="executebatchatonce"><code class="tsd-tag">Readonly</code><span>execute<wbr/>Batch<wbr/>At<wbr/>Once</span><a href="#executebatchatonce" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">executeBatchAtOnce</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol"> = false</span></div><div class="tsd-comment tsd-typography"><p>Enables parallel (batched) execution of tasks instead of processing them one-by-one.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-6">Remarks<a href="#remarks-6" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>By default, PowerQueues processes tasks <strong>sequentially</strong> inside <code>execute()</code>.
This ensures predictable behavior and simpler idempotency handling.</p>
<p>When <code>executeBatchAtOnce</code> is set to <code>true</code>, each task in the batch is executed
<strong>concurrently</strong> using <code>Promise.all</code>, which can significantly increase throughput
for CPU-light or I/O-heavy workloads.</p>
<p><strong>However, enabling this requires caution:</strong></p>
<ul>
<li>Task handlers (<code>onExecute</code>) must be thread-safe and free of shared mutable state.</li>
<li>Heavy concurrency may increase contention during idempotency checks.</li>
<li>Error handling remains per-task, but failures may occur in parallel.</li>
</ul>
<p>Recommended when:</p>
<ul>
<li>workers perform non-blocking async operations (DB queries, HTTP calls, etc.)</li>
<li>your environment benefits from parallelism (Node.js event loop + await)</li>
</ul>
<p>Not recommended when:</p>
<ul>
<li>tasks modify shared external resources</li>
<li>tasks rely on strict ordering</li>
<li>workers perform heavy CPU tasks (event loop stall risk)</li>
</ul>
<p>Default value <code>false</code> ensures:</p>
<ul>
<li>safe and predictable execution flow</li>
<li>simpler debugging</li>
<li>minimal race conditions</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-6">Example<a href="#example-6" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Enable concurrent execution of a batch of tasks</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">executeBatchAtOnce</span><span class="hl-1"> = </span><span class="hl-3">true</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L474">PowerQueues.ts:474</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="executejobstatus"><code class="tsd-tag">Readonly</code><span>execute<wbr/>Job<wbr/>Status</span><a href="#executejobstatus" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">executeJobStatus</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol"> = false</span></div><div class="tsd-comment tsd-typography"><p>Enables storing execution statistics for each job in Redis.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-7">Remarks<a href="#remarks-7" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When this option is <code>true</code>, PowerQueues records simple counters in Redis
that reflect the status of tasks belonging to the same logical job
(identified by the auto-generated <code>job</code> ID added during <code>addTasks()</code>).</p>
<p>These counters are updated during execution:</p>
<ul>
<li><code>ok</code>   → incremented when a task finishes successfully</li>
<li><code>err</code>  → incremented when a task exhausts all retries and fails</li>
<li><code>ready</code> → incremented for every processed task (success or fail)</li>
</ul>
<p>This creates a lightweight job-level progress tracking mechanism.
Counters are automatically expired using <code>executeJobStatusTtlMs</code>.</p>
<p>Useful for:</p>
<ul>
<li>tracking large batch imports</li>
<li>showing job progress in dashboards</li>
<li>monitoring worker throughput</li>
<li>debugging stuck or failing tasks</li>
</ul>
<p>Not recommended when:</p>
<ul>
<li>you do not need job-level metrics</li>
<li>Redis key count must remain minimal</li>
<li>you have extremely high throughput and prefer zero-overhead writes</li>
</ul>
<p>Default value <code>false</code> disables status tracking entirely.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-7">Example<a href="#example-7" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Enable job progress tracking</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">executeJobStatus</span><span class="hl-1"> = </span><span class="hl-3">true</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L515">PowerQueues.ts:515</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="executejobstatusttlms"><code class="tsd-tag">Readonly</code><span>execute<wbr/>Job<wbr/>Status<wbr/>Ttl<wbr/>Ms</span><a href="#executejobstatusttlms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">executeJobStatusTtlMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 300000</span></div><div class="tsd-comment tsd-typography"><p>Time-to-live (in milliseconds) for job-level execution status counters.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-8">Remarks<a href="#remarks-8" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When <a href="#executejobstatus" class="tsd-kind-property">executeJobStatus</a> is enabled, PowerQueues creates small Redis
counters for each job:</p>
<ul>
<li><code>...:ok</code>    - number of successfully executed tasks</li>
<li><code>...:err</code>   - number of tasks that failed after all retries</li>
<li><code>...:ready</code> - number of tasks processed (success + fail)</li>
</ul>
<p>These counters should not stay in Redis forever, so each increment call
also sets a TTL. <code>executeJobStatusTtlMs</code> defines how long the job metrics
remain available before they expire automatically.</p>
<p>Why a TTL?</p>
<ul>
<li>prevents Redis key buildup</li>
<li>keeps monitoring data fresh</li>
<li>avoids manual cleanup</li>
<li>ensures dashboards always reflect recent jobs</li>
</ul>
<p>Default value <code>300000</code> (5 minutes) is suitable for:</p>
<ul>
<li>short-lived jobs</li>
<li>quick diagnostics after ingestion</li>
<li>lightweight progress tracking</li>
</ul>
<p>Increase the TTL if:</p>
<ul>
<li>jobs take longer to complete</li>
<li>you need to inspect job history over time</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-8">Example<a href="#example-8" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Keep job progress data for 30 minutes</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">executeJobStatusTtlMs</span><span class="hl-1"> = </span><span class="hl-7">1800000</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L556">PowerQueues.ts:556</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="group"><code class="tsd-tag">Readonly</code><span>group</span><a href="#group" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">group</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol"> = &#39;group&#39;</span></div><div class="tsd-comment tsd-typography"><p>The Redis consumer group name used by this worker.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-9">Remarks<a href="#remarks-9" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Redis Streams require consumers to join a <em>consumer group</em> in order to use
features like:</p>
<ul>
<li><code>XREADGROUP</code> (reading pending + new messages)</li>
<li><code>XAUTOCLAIM</code> (claiming stuck tasks)</li>
<li><code>XACK</code> (acknowledging processed tasks)</li>
</ul>
<p>The <code>group</code> value defines the name of that consumer group.</p>
<p>All workers that share the same:</p>
<ul>
<li><a href="#stream" class="tsd-kind-property">stream</a></li>
<li><a href="#group" class="tsd-kind-property">group</a></li>
</ul>
<p>will cooperatively process tasks from the same queue, while Redis ensures:</p>
<ul>
<li>no task is delivered to more than one worker at the same time</li>
<li>pending messages can be recovered if a worker dies</li>
</ul>
<p><strong>You must ensure that each queue has a unique group name per stream.</strong></p>
<p>PowerQueues automatically creates the group (via <code>XGROUP CREATE</code>)
during <code>runQueue()</code>, if it does not already exist.</p>
<p>Default value <code>'group'</code> is only a placeholder and should be replaced
with something meaningful in production.</p>
<p>Common naming examples:</p>
<ul>
<li><code>'workers'</code></li>
<li><code>'payments'</code></li>
<li><code>'image-processors'</code></li>
<li><code>'api-service-A'</code></li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-9">Example<a href="#example-9" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1"> = </span><span class="hl-2">&#39;email-workers&#39;</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L677">PowerQueues.ts:677</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="recoverystucktaskstimeoutms"><code class="tsd-tag">Readonly</code><span>recovery<wbr/>Stuck<wbr/>Tasks<wbr/>Timeout<wbr/>Ms</span><a href="#recoverystucktaskstimeoutms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">recoveryStuckTasksTimeoutMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 60000</span></div><div class="tsd-comment tsd-typography"><p>Time (in milliseconds) after which a pending task is considered &quot;stuck&quot;.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-10">Remarks<a href="#remarks-10" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>PowerQueues uses Redis Streams pending entries list (PEL) to detect tasks
that were delivered to a worker but never acknowledged-usually because the
worker crashed, froze, or disconnected.</p>
<p><code>recoveryStuckTasksTimeoutMs</code> defines how long a task must remain idle
(unacknowledged) before it is treated as &quot;stuck&quot; and eligible for recovery
using <code>XAUTOCLAIM</code>.</p>
<p>The logic is handled inside the <a href="../variables/SelectStuck.html" class="tsd-kind-variable">SelectStuck</a> Lua script, where
this value becomes the <code>min-idle-time</code> parameter:</p>
<ul>
<li>If a task's idle time ≥ <code>recoveryStuckTasksTimeoutMs</code>,<br>
PowerQueues attempts to claim it for the current worker.</li>
</ul>
<p>Why this matters:</p>
<ul>
<li>prevents orphaned tasks</li>
<li>ensures reliable failover</li>
<li>avoids task starvation</li>
<li>keeps queues healthy even when workers die unexpectedly</li>
</ul>
<p>Default value <code>60000</code> (60 seconds) is balanced for:</p>
<ul>
<li>typical async worker workloads</li>
<li>ensuring fast recovery without aggressive contention</li>
</ul>
<p>Increase this if:</p>
<ul>
<li>tasks normally run for a long time</li>
<li>slow workers are expected</li>
</ul>
<p>Decrease this if:</p>
<ul>
<li>you want very fast failover</li>
<li>workers are extremely lightweight</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-10">Example<a href="#example-10" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Treat tasks as stuck if not acknowledged for 2 minutes</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">recoveryStuckTasksTimeoutMs</span><span class="hl-1"> = </span><span class="hl-7">120000</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L766">PowerQueues.ts:766</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="redis"><span>redis</span><a href="#redis" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">redis</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IORedisLike</span></div><div class="tsd-comment tsd-typography"><p>The underlying Redis client instance used by PowerQueues.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-11">Remarks<a href="#remarks-11" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>This property must be assigned by the user before running any queue
operations. It provides the low-level Redis commands that all internal
features rely on: XADD, XREADGROUP, XACK, Lua scripts, key operations,
TTL updates, etc.</p>
<p>PowerQueues does <strong>not</strong> create its own Redis connection.<br>
Instead, it expects an external instance (e.g., from <code>ioredis</code>,
<code>@nestjs-labs/nestjs-ioredis</code>, or any custom wrapper) that implements
the IORedisLike interface.</p>
<p>If <code>redis</code> is not set or is disconnected, the queue worker will not be
able to read or write tasks.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-11">Example<a href="#example-11" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">queues</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">MyQueueClass</span><span class="hl-1">();</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">redis</span><span class="hl-1"> = </span><span class="hl-5">redisService</span><span class="hl-1">.</span><span class="hl-0">getClient</span><span class="hl-1">(); </span><span class="hl-9">// must assign before use</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-0">runQueue</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><p>Overrides PowerRedis.redis</p><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L192">PowerQueues.ts:192</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="removeonexecuted"><code class="tsd-tag">Readonly</code><span>remove<wbr/>On<wbr/>Executed</span><a href="#removeonexecuted" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">removeOnExecuted</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol"> = false</span></div><div class="tsd-comment tsd-typography"><p>Whether successfully executed tasks should be removed from the Redis stream.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-12">Remarks<a href="#remarks-12" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>By default, PowerQueues does <strong>not</strong> delete processed tasks from the stream.
Redis Streams can act as an immutable log, which is useful for debugging,
auditing, replaying, or monitoring.</p>
<p>When <code>removeOnExecuted</code> is set to <code>true</code>, PowerQueues will delete each
acknowledged entry using <code>XDEL</code> immediately after <code>XACK</code>.</p>
<p>Benefits of keeping tasks (default: <code>false</code>):</p>
<ul>
<li>historical visibility into what tasks were processed</li>
<li>easier debugging and replay</li>
<li>safer in multi-worker environments</li>
</ul>
<p>Benefits of removing tasks (<code>true</code>):</p>
<ul>
<li>smaller Redis memory footprint</li>
<li>faster XREADGROUP / XAUTCLAIM operations</li>
<li>prevents streams from growing indefinitely</li>
</ul>
<p>This setting affects only <strong>successfully executed</strong> tasks.
Failed tasks may still go to the DLQ depending on retries.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-12">Example<a href="#example-12" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Enable automatic deletion of executed tasks:</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">removeOnExecuted</span><span class="hl-1"> = </span><span class="hl-3">true</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L433">PowerQueues.ts:433</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="scripts"><code class="tsd-tag">Readonly</code><span>scripts</span><a href="#scripts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">scripts</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Record</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <a href="../types/SavedScript.html" class="tsd-signature-type tsd-kind-type-alias">SavedScript</a><span class="tsd-signature-symbol">&gt;</span><span class="tsd-signature-symbol"> = {}</span></div><div class="tsd-comment tsd-typography"><p>In-memory registry of Lua scripts used by PowerQueues.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-13">Remarks<a href="#remarks-13" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>PowerQueues loads its Lua scripts (XAddBulk, Approve, idempotency helpers,
SelectStuck, etc.) into Redis and keeps their metadata in this map.</p>
<p>Each entry is stored under a human-readable key (for example <code>&quot;XAddBulk&quot;</code>)
and contains a <a href="../types/SavedScript.html" class="tsd-kind-type-alias">SavedScript</a> object:</p>
<ul>
<li><code>codeBody</code>  - the original Lua source code</li>
<li><code>codeReady</code> - the SHA1 returned by <code>SCRIPT LOAD</code> (used with <code>EVALSHA</code>)</li>
</ul>
<p>This allows the queue to:</p>
<ul>
<li>load scripts only once per process,</li>
<li>reuse <code>EVALSHA</code> for better performance,</li>
<li>automatically reload scripts if Redis loses them (e.g. after restart).</li>
</ul>
<p>You normally do not modify this map directly.<br>
It is managed internally by methods like <a href="#loadscripts" class="tsd-kind-method">loadScripts</a>,
<a href="#savescript" class="tsd-kind-method">saveScript</a>, and <a href="#runscript" class="tsd-kind-method">runScript</a>.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-13">Example<a href="#example-13" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// After loadScripts() is called:</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">Object</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">(</span><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">scripts</span><span class="hl-1">));</span><br/><span class="hl-9">// -&gt; [&quot;XAddBulk&quot;, &quot;Approve&quot;, &quot;IdempotencyAllow&quot;, ...]</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L226">PowerQueues.ts:226</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="stream"><code class="tsd-tag">Readonly</code><span>stream</span><a href="#stream" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">stream</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol"> = &#39;stream&#39;</span></div><div class="tsd-comment tsd-typography"><p>The Redis Stream key used as the main task queue.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-14">Remarks<a href="#remarks-14" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>All tasks added through <code>addTasks()</code> are ultimately written into this Redis
Stream. Workers read from it using <code>XREADGROUP</code>, <code>XAUTOCLAIM</code>, and other
stream-related commands.</p>
<p>You should treat <code>stream</code> as the &quot;queue name&quot;-it uniquely identifies
where tasks for this worker group are stored in Redis.</p>
<p>Common examples:</p>
<ul>
<li><code>'emails'</code></li>
<li><code>'jobs:process'</code></li>
<li><code>'telemetry:ingest'</code></li>
<li><code>'queue:payments'</code></li>
</ul>
<p>Changing <code>stream</code> changes the entire queue channel for this worker.</p>
<p><strong>Important notes:</strong></p>
<ul>
<li>The stream is created automatically if it does not exist (via <code>MKSTREAM</code>)</li>
<li>Worker groups are associated with this stream via <a href="#group" class="tsd-kind-property">group</a></li>
<li>DLQ (dead-letter queue) is based on <code>stream + ':dlq'</code></li>
</ul>
<p>Default value <code>'stream'</code> is a placeholder and should be replaced
in real applications.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-14">Example<a href="#example-14" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1"> = </span><span class="hl-2">&#39;jobs:image-processing&#39;</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L633">PowerQueues.ts:633</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workerbatchtaskscount"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Batch<wbr/>Tasks<wbr/>Count</span><a href="#workerbatchtaskscount" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerBatchTasksCount</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 200</span></div><div class="tsd-comment tsd-typography"><p>Maximum number of tasks a worker attempts to fetch in a single read cycle.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-15">Remarks<a href="#remarks-15" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>PowerQueues reads tasks from Redis Streams in batches to improve throughput
and reduce the number of network round-trips.<br>
<code>workerBatchTasksCount</code> defines how many tasks the worker tries to pull
from Redis at once using:</p>
<ul>
<li><code>XREADGROUP</code> for fresh tasks</li>
<li><code>XAUTOCLAIM</code> for stuck/pending tasks</li>
</ul>
<p>A higher value increases throughput but may:</p>
<ul>
<li>increase memory usage per iteration</li>
<li>delay acknowledgements for long batches</li>
<li>increase execution latency per task</li>
</ul>
<p>A lower value:</p>
<ul>
<li>decreases memory usage</li>
<li>improves responsiveness</li>
<li>reduces risk of long-running batch execution</li>
</ul>
<p>Default value <code>200</code> is tuned to balance:</p>
<ul>
<li>fast message consumption</li>
<li>low event-loop blocking</li>
<li>efficient recovery of stuck tasks</li>
</ul>
<p>Adjust depending on worker workload:</p>
<ul>
<li><strong>Increase</strong> if your tasks are light or mostly I/O bound</li>
<li><strong>Decrease</strong> if tasks are heavy or your system is resource-limited</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-15">Example<a href="#example-15" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Process up to 500 tasks in each fetch cycle</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">workerBatchTasksCount</span><span class="hl-1"> = </span><span class="hl-7">500</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L719">PowerQueues.ts:719</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workercachetasktimeoutms"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Cache<wbr/>Task<wbr/>Timeout<wbr/>Ms</span><a href="#workercachetasktimeoutms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerCacheTaskTimeoutMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 60000</span></div><div class="tsd-comment tsd-typography"><p>The time (in <strong>milliseconds</strong>) to keep the <em>idempotency completion marker</em> (<code>doneKey</code>)
alive after a task has successfully finished.</p>
<h3 id="what-this-timeout-does" class="tsd-anchor-link">What this timeout does<a href="#what-this-timeout-does" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When a task with an idempotency key finishes, Redis stores a small &quot;done&quot; flag
so that repeated executions of the same task can be skipped immediately.</p>
<p><code>workerCacheTaskTimeoutMs</code> defines <strong>how long this flag remains valid</strong>.</p>
<p>After the timeout expires:</p>
<ul>
<li>the task is considered &quot;not completed&quot; again,</li>
<li>a future worker may reprocess the same idempotency key,</li>
<li>this allows long-running or retried tasks to be re-executed if needed.</li>
</ul>
<h3 id="why-it-exists" class="tsd-anchor-link">Why it exists<a href="#why-it-exists" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In distributed systems multiple workers may attempt to process the same
task. This timeout creates a small <strong>safety cache window</strong> that prevents
duplicate work while still allowing re-execution in controlled scenarios.</p>
<h3 id="best-practices" class="tsd-anchor-link">Best practices<a href="#best-practices" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Use values between <strong>30s-5min</strong> depending on how often retries or
duplicate messages naturally happen in your system.</li>
<li>Too small → might allow premature reprocessing.</li>
<li>Too large → may block legitimate re-execution for too long.</li>
</ul>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-default"><h4 class="tsd-anchor-link" id="default">Default<a href="#default" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-7">60000</span><span class="hl-1"> (</span><span class="hl-7">1</span><span class="hl-1"> </span><span class="hl-5">minute</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L360">PowerQueues.ts:360</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workerclearattemptstimeoutms"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Clear<wbr/>Attempts<wbr/>Timeout<wbr/>Ms</span><a href="#workerclearattemptstimeoutms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerClearAttemptsTimeoutMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 86400000</span></div><div class="tsd-comment tsd-typography"><p>Time-to-live (in milliseconds) for the retry-attempt counter of each task.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-16">Remarks<a href="#remarks-16" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Every time a task fails, PowerQueues stores its retry count in Redis under a
per-task key (generated by <a href="#attemptskey" class="tsd-kind-method">attemptsKey</a>).<br>
This counter allows the worker to determine:</p>
<ul>
<li>how many times the task has already failed</li>
<li>whether it should retry or send the task to the DLQ</li>
</ul>
<p><code>workerClearAttemptsTimeoutMs</code> specifies how long this retry counter should
remain in Redis before it expires automatically.</p>
<p>Why this matters:</p>
<ul>
<li>prevents retry counters from building up indefinitely</li>
<li>ensures memory is cleaned for tasks long after completion</li>
<li>avoids stale retry state affecting future tasks with the same ID</li>
</ul>
<p>Default value <code>86400000</code> (24 hours) works well for most workloads because:</p>
<ul>
<li>it keeps retry info long enough for debugging</li>
<li>it automatically cleans up old state overnight</li>
</ul>
<p>You may want to <strong>reduce</strong> this value if:</p>
<ul>
<li>you process millions of tasks daily</li>
<li>strict memory efficiency is required</li>
</ul>
<p>Or <strong>increase</strong> it if:</p>
<ul>
<li>you run long-lived jobs</li>
<li>you need extended visibility into retry behavior</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-16">Example<a href="#example-16" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Keep retry counters for 6 hours instead of 24</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">workerClearAttemptsTimeoutMs</span><span class="hl-1"> = </span><span class="hl-7">21600000</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L931">PowerQueues.ts:931</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workerexecutelocktimeoutms"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Execute<wbr/>Lock<wbr/>Timeout<wbr/>Ms</span><a href="#workerexecutelocktimeoutms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerExecuteLockTimeoutMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 180000</span></div><div class="tsd-comment tsd-typography"><p>Time (in milliseconds) that an idempotent task lock remains valid.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-17">Remarks<a href="#remarks-17" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When a worker starts executing a task that uses idempotency (<code>idemKey</code>),
PowerQueues creates a short-lived &quot;execution lock&quot; in Redis.<br>
This lock prevents multiple workers from processing the same logical task
at the same time.</p>
<p><code>workerExecuteLockTimeoutMs</code> defines how long this lock stays active
unless refreshed by the heartbeat mechanism.</p>
<p>Internally it is used in:</p>
<ul>
<li><a href="#idempotencyallow" class="tsd-kind-method">idempotencyAllow</a></li>
<li><a href="#idempotencystart" class="tsd-kind-method">idempotencyStart</a></li>
<li><a href="#sendheartbeat" class="tsd-kind-method">sendHeartbeat</a></li>
<li><a href="#heartbeat" class="tsd-kind-method">heartbeat</a></li>
</ul>
<p>If the worker crashes, disconnects, or hangs, the lock expires
automatically, allowing another worker to take over safely.</p>
<p>Default value <code>180000</code> (3 minutes) provides:</p>
<ul>
<li>enough time to complete typical async work,</li>
<li>automatic recovery without manual cleanup,</li>
<li>protection against double-processing.</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-17">Example<a href="#example-17" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// For very long-running jobs (e.g. external API pipelines)</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">workerExecuteLockTimeoutMs</span><span class="hl-1"> = </span><span class="hl-7">600000</span><span class="hl-1">; </span><span class="hl-9">// 10 minutes</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L330">PowerQueues.ts:330</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workerloopintervalms"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Loop<wbr/>Interval<wbr/>Ms</span><a href="#workerloopintervalms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerLoopIntervalMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 5000</span></div><div class="tsd-comment tsd-typography"><p>Delay (in milliseconds) between worker polling cycles when no tasks are available.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-18">Remarks<a href="#remarks-18" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When the worker calls <code>select()</code> and finds <strong>no tasks</strong> (neither stuck nor fresh),
it waits before checking Redis again.<br>
<code>workerLoopIntervalMs</code> defines how long the worker should pause between polls.</p>
<p>This applies only when the queue is idle.<br>
When tasks are available, the loop runs continuously without this delay.</p>
<p>Why this interval exists:</p>
<ul>
<li>reduces unnecessary Redis calls during idle periods</li>
<li>prevents CPU spin-loops</li>
<li>stabilizes load in low-traffic queues</li>
</ul>
<p>Default value <code>5000</code> (5 seconds) provides a good balance between:</p>
<ul>
<li>responsiveness (fast enough to detect new tasks)</li>
<li>efficiency (low overhead during quiet periods)</li>
</ul>
<p>Recommended adjustments:</p>
<ul>
<li><strong>Lower</strong> (500-1500 ms) for real-time or high-frequency task ingestion</li>
<li><strong>Higher</strong> (5-15 seconds) for slow background jobs or cost-sensitive systems</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-18">Example<a href="#example-18" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Make the worker more responsive in a busy system</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">workerLoopIntervalMs</span><span class="hl-1"> = </span><span class="hl-7">1000</span><span class="hl-1">; </span><span class="hl-9">// 1 second</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L801">PowerQueues.ts:801</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workermaxretries"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Max<wbr/>Retries</span><a href="#workermaxretries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerMaxRetries</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 1</span></div><div class="tsd-comment tsd-typography"><p>Maximum number of retry attempts allowed for a failing task.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-19">Remarks<a href="#remarks-19" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When a task throws an error inside <code>onExecute</code>, PowerQueues:</p>
<ol>
<li>increments the task's retry counter using <code>incrAttempts()</code></li>
<li>calls user-defined hooks (<code>onRetry</code>, then <code>onError</code>)</li>
<li>decides whether to retry or send the task to the DLQ</li>
</ol>
<p><code>workerMaxRetries</code> defines how many times a task may be retried before it
is considered permanently failed.</p>
<p>Behaviour summary:</p>
<ul>
<li><code>attempt &lt; workerMaxRetries</code> → task is retried</li>
<li><code>attempt &gt;= workerMaxRetries</code> → task is moved to DLQ</li>
</ul>
<p><strong>Note:</strong><br>
Retries happen immediately within the same worker cycle (no delay),
unless the user chooses to reinsert tasks manually.</p>
<p>Default value <code>1</code> means:</p>
<ul>
<li>one initial attempt</li>
<li>one retry on failure</li>
<li>next failure → DLQ</li>
</ul>
<p>Increase this if:</p>
<ul>
<li>tasks frequently fail due to external API timeouts</li>
<li>retrying often resolves transient issues</li>
</ul>
<p>Decrease this if:</p>
<ul>
<li>retries are expensive</li>
<li>failing fast is more desirable</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-19">Example<a href="#example-19" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Allow tasks to retry up to 5 times before going to DLQ</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">workerMaxRetries</span><span class="hl-1"> = </span><span class="hl-7">5</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L889">PowerQueues.ts:889</a></li></ul></aside></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="workerselectiontimeoutms"><code class="tsd-tag">Readonly</code><span>worker<wbr/>Selection<wbr/>Timeout<wbr/>Ms</span><a href="#workerselectiontimeoutms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><div class="tsd-signature"><span class="tsd-kind-property">workerSelectionTimeoutMs</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol"> = 80</span></div><div class="tsd-comment tsd-typography"><p>Maximum time (in milliseconds) the worker is allowed to spend searching
for stuck tasks during a single recovery cycle.</p>
</div><div class="tsd-comment tsd-typography"><div class="tsd-tag-remarks"><h4 class="tsd-anchor-link" id="remarks-20">Remarks<a href="#remarks-20" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Before reading fresh tasks, PowerQueues first tries to recover &quot;stuck&quot;
tasks using the <a href="../variables/SelectStuck.html" class="tsd-kind-variable">SelectStuck</a> Lua script.<br>
This script scans the pending entries list (PEL) and may perform several
iterations of <code>XAUTOCLAIM</code>.</p>
<p><code>workerSelectionTimeoutMs</code> limits how long this recovery step is allowed
to run before giving up and moving on.</p>
<p>Why this matters:</p>
<ul>
<li>prevents long blocking calls during heavy recovery situations</li>
<li>ensures the worker stays responsive even with large queues</li>
<li>avoids event-loop stalls caused by large PEL scans</li>
</ul>
<p>The timeout is soft: the Lua script checks elapsed time and
voluntarily exits when this limit is reached.</p>
<p>Default value <code>80</code> ms is tuned to:</p>
<ul>
<li>allow enough time to reclaim stuck messages</li>
<li>prevent noticeable delays in normal task processing</li>
</ul>
<p>Increase this if:</p>
<ul>
<li>you expect many stuck tasks (unstable workers)</li>
<li>your Redis instance handles large streams</li>
</ul>
<p>Decrease this if:</p>
<ul>
<li>minimal latency is critical</li>
<li>your environment is extremely CPU-sensitive</li>
</ul>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-20">Example<a href="#example-20" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Allow up to 150 ms for stuck-task recovery</span><br/><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">workerSelectionTimeoutMs</span><span class="hl-1"> = </span><span class="hl-7">150</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L845">PowerQueues.ts:845</a></li></ul></aside></section></section></details><details class="tsd-panel-group tsd-member-group tsd-accordion" open><summary class="tsd-accordion-summary" data-key="section-Methods"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h2>Methods</h2></summary><section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="addtasks"><span>add<wbr/>Tasks</span><a href="#addtasks" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="addtasks-1"><span class="tsd-kind-call-signature">addTasks</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">queueName</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">data</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">opts</span><span class="tsd-signature-symbol">?:</span> <a href="../types/AddTasksOptions.html" class="tsd-signature-type tsd-kind-type-alias">AddTasksOptions</a><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#addtasks-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Adds a list of tasks to a Redis Stream in <strong>batches</strong>, using the <code>XAddBulk</code> Lua script.</p>
<p>This is the main entry point for <strong>producing</strong> tasks into the queue.
It:</p>
<ul>
<li>wraps raw items into internal <code>Task</code> structures,</li>
<li>splits them into batches based on:
<ul>
<li><code>addingBatchTasksCount</code> (max tasks per batch),</li>
<li><code>addingBatchKeysLimit</code> (max total field/value pairs per batch),</li>
</ul>
</li>
<li>sends each batch to Redis with a single <code>EVALSHA XAddBulk ...</code> call,</li>
<li>returns all created Stream IDs in the <strong>same order</strong> as input <code>data</code>.</li>
</ul>
<h3 id="input-data-format" class="tsd-anchor-link">Input data format<a href="#input-data-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each item in <code>data</code> is treated as a <code>Task</code>:</p>
<ul>
<li>
<p><strong>Object payload (most common case)</strong></p>
<pre><code class="ts"><span class="hl-1">{ </span><span class="hl-10">payload</span><span class="hl-1">: { ...</span><span class="hl-5">businessFields</span><span class="hl-1"> } }</span>
</code><button type="button">Copy</button></pre>

<p>Internally it becomes:</p>
<ul>
<li><code>payload</code> is <strong>JSON-serialized</strong> and stored under <code>&quot;payload&quot;</code> field,</li>
<li><code>createdAt</code> (ms) is added,</li>
<li><code>job</code> (batch ID) is added,</li>
<li><code>idemKey</code> is added if <code>opts.idem === true</code>.</li>
</ul>
</li>
<li>
<p><strong>Flat array of field/value pairs</strong></p>
<pre><code class="ts"><span class="hl-1">{ </span><span class="hl-10">flat</span><span class="hl-1">: [</span><span class="hl-2">&#39;field1&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;value1&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;field2&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;value2&#39;</span><span class="hl-1">, ...] }</span>
</code><button type="button">Copy</button></pre>

<p>Internally it appends:</p>
<ul>
<li><code>&quot;createdAt&quot;</code>, <code>&quot;job&quot;</code>,</li>
<li><code>&quot;idemKey&quot;</code> if <code>opts.idem === true</code>.</li>
</ul>
</li>
</ul>
<p>If neither <code>payload</code> nor <code>flat</code> is present, an error is thrown.</p>
<h3 id="trimming-stream-options-" class="tsd-anchor-link">Trimming &amp; stream options (<code>opts</code>)<a href="#trimming-stream-options-" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>These options are passed to the Lua <code>XAddBulk</code> script:</p>
<ul>
<li><code>maxlen?: number</code> - soft or exact limit for stream length:
<ul>
<li>combined with <code>approx</code> / <code>exact</code> to build <code>XADD ... MAXLEN [~|=] &lt;maxlen&gt;</code>.</li>
</ul>
</li>
<li><code>approx?: boolean</code> - use approximate trimming (<code>~</code>, default if <code>exact</code> is not set).</li>
<li><code>exact?: boolean</code> - use exact trimming (<code>=</code>). If <code>true</code>, <code>approx</code> is ignored.</li>
<li><code>trimLimit?: number</code> - optional <code>LIMIT &lt;n&gt;</code> for trimming.</li>
<li><code>nomkstream?: boolean</code> - if <code>true</code>, adds <code>NOMKSTREAM</code> so the stream
is <strong>not</strong> created automatically when it does not exist.</li>
<li><code>minidWindowMs?: number</code> - use <code>MINID</code> trimming instead of <code>MAXLEN</code>:
<ul>
<li>compute <code>now - minidWindowMs</code> and trim entries older than that ID.</li>
</ul>
</li>
<li><code>minidExact?: boolean</code> - when using <code>MINID</code>, choose exact (<code>=</code>) vs approx (<code>~</code>) mode.</li>
</ul>
<h3 id="status-tracking-" class="tsd-anchor-link">Status tracking (<code>opts.status</code>)<a href="#status-tracking-" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>opts.status === true</code>:</p>
<ul>
<li>a unique <code>job</code> ID is generated (UUID),</li>
<li>a Redis key <code>&lt;queueName&gt;:&lt;job&gt;:total</code> is set to <code>data.length</code>,</li>
<li>TTL for this key is <code>opts.statusTimeoutMs</code> (default <code>300000</code> ms = 5 minutes).</li>
</ul>
<p>This allows external systems to track:</p>
<ul>
<li>how many tasks were enqueued for this job,</li>
<li>how many were later processed (via job-level counters in <code>success()</code>).</li>
</ul>
<h3 id="idempotency-helper-" class="tsd-anchor-link">Idempotency helper (<code>opts.idem</code>)<a href="#idempotency-helper-" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When <code>opts.idem === true</code>:</p>
<ul>
<li>each task gets an <code>idemKey</code> field if not already set:
<ul>
<li>either using <code>entry.idemKey</code> or a generated UUID,</li>
</ul>
</li>
<li>this key is later used in the worker's idempotency flow.</li>
</ul>
<p>Validation &amp; Errors:</p>
<ul>
<li>If <code>data</code> is empty, it throws: <code>&quot;Tasks is not filled.&quot;</code>.</li>
<li>If <code>queueName</code> is empty, it throws: <code>&quot;Queue name is required.&quot;</code>.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">queueName</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Name of the Redis Stream (queue) to push tasks into.</p>
</div></li><li><span><span class="tsd-kind-parameter">data</span>: <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Array of task-like objects:</p>
<ul>
<li><code>{ payload: object }</code> or <code>{ flat: JsonPrimitiveOrUndefined[] }</code>.</li>
</ul>
</div></li><li><span><span class="tsd-kind-parameter">opts</span>: <a href="../types/AddTasksOptions.html" class="tsd-signature-type tsd-kind-type-alias">AddTasksOptions</a><span class="tsd-signature-symbol"> = {}</span></span><div class="tsd-comment tsd-typography"><p>Additional options for stream trimming, status tracking and idempotency.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><p>Promise that resolves to an array of Stream entry IDs (<code>XADD</code> IDs),
in the same order as the input <code>data</code> array.</p>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-21">Example<a href="#example-21" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example 1: push simple JSON payloads</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">addTasks</span><span class="hl-1">(</span><span class="hl-2">&#39;events:email&#39;</span><span class="hl-1">, [</span><br/><span class="hl-1">  { </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;welcome&#39;</span><span class="hl-1">, </span><span class="hl-5">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u1&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">  { </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;password_reset&#39;</span><span class="hl-1">, </span><span class="hl-5">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u2&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">]);</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-22">Example<a href="#example-22" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example 2: enable job status tracking and idempotency</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">ids</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">addTasks</span><span class="hl-1">(</span><span class="hl-2">&#39;billing:charges&#39;</span><span class="hl-1">, [</span><br/><span class="hl-1">  { </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u1&#39;</span><span class="hl-1">, </span><span class="hl-5">amount:</span><span class="hl-1"> </span><span class="hl-7">100</span><span class="hl-1"> } },</span><br/><span class="hl-1">  { </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">userId:</span><span class="hl-1"> </span><span class="hl-2">&#39;u2&#39;</span><span class="hl-1">, </span><span class="hl-5">amount:</span><span class="hl-1"> </span><span class="hl-7">250</span><span class="hl-1"> } },</span><br/><span class="hl-1">], {</span><br/><span class="hl-1">  </span><span class="hl-5">status:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,          </span><span class="hl-9">// set &lt;queueName&gt;:&lt;job&gt;:total</span><br/><span class="hl-1">  </span><span class="hl-5">statusTimeoutMs:</span><span class="hl-1"> </span><span class="hl-7">600000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">idem:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,            </span><span class="hl-9">// auto attach idemKey to each task</span><br/><span class="hl-1">  </span><span class="hl-5">maxlen:</span><span class="hl-1"> </span><span class="hl-7">1_000_000</span><span class="hl-1">,     </span><span class="hl-9">// keep last 1M entries</span><br/><span class="hl-1">  </span><span class="hl-5">approx:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,          </span><span class="hl-9">// use MAXLEN ~</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-9">// &quot;ids&quot; now contains the Redis stream IDs for each enqueued task</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1664">PowerQueues.ts:1664</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="approve"><code class="tsd-tag">Private</code><span>approve</span><a href="#approve" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="approve-1"><span class="tsd-kind-call-signature">approve</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">ids</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">&gt;</span><a href="#approve-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Approve a list of <strong>successfully processed stream entries</strong> and
optionally <strong>deletes</strong> them from the Redis stream.</p>
<p>This method is the final step of the worker pipeline:
it takes IDs returned by <a href="#execute" class="tsd-kind-method">execute</a>, calls the <code>Approve</code> Lua script,
and performs batched <code>XACK</code> (and optionally <code>XDEL</code>) operations.</p>
<hr>
<h2 id="what-this-method-does" class="tsd-anchor-link">What this method does<a href="#what-this-method-does" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ol>
<li>
<p>Validates input:</p>
<ul>
<li>If <code>ids</code> is not an array or is empty → returns <code>0</code> immediately.</li>
</ul>
</li>
<li>
<p>Computes a safe batch size:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">approveBatchTasksCount</span><span class="hl-1"> =</span><br/><span class="hl-1">  </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">max</span><span class="hl-1">(</span><span class="hl-7">500</span><span class="hl-1">, </span><span class="hl-5">Math</span><span class="hl-1">.</span><span class="hl-0">min</span><span class="hl-1">(</span><span class="hl-7">4000</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">approveBatchTasksCount</span><span class="hl-1">));</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>Ensures the effective batch size is always <strong>between 500 and 4000</strong>.</li>
<li>This keeps a good balance between:
<ul>
<li>fewer round-trips to Redis, and</li>
<li>not sending excessively large argument lists.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Splits <code>ids</code> into slices (<code>part</code>) of at most <code>approveBatchTasksCount</code>
items and, for each slice, calls the <code>Approve</code> Lua script via <a href="#runscript" class="tsd-kind-method">runScript</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">approved</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">runScript</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;Approve&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  [ </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1"> ],</span><br/><span class="hl-1">  [ </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">removeOnExecuted</span><span class="hl-1"> ? </span><span class="hl-2">&#39;1&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;0&#39;</span><span class="hl-1">, ...</span><span class="hl-5">part</span><span class="hl-1"> ],</span><br/><span class="hl-1">  </span><span class="hl-5">Approve</span><span class="hl-1">,</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Inside the script (<code>Approve</code>):</p>
<ul>
<li><code>XACK</code> is executed for all IDs,</li>
<li>if <code>removeOnExecuted</code> is <code>true</code>, it also attempts to <code>XDEL</code> them
(delete entries from the stream).</li>
</ul>
</li>
<li>
<p>Sums up how many messages were acknowledged:</p>
<pre><code class="ts"><span class="hl-5">total</span><span class="hl-1"> += </span><span class="hl-0">Number</span><span class="hl-1">(</span><span class="hl-5">approved</span><span class="hl-1"> || </span><span class="hl-7">0</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p><code>approved</code> is the numeric result returned by <code>XACK</code> (how many entries
were actually acknowledged in Redis).</p>
</li>
<li>
<p>Returns the <strong>total number of entries acknowledged</strong> across all batches.</p>
</li>
</ol>
<hr>
<h2 id="behaviour" class="tsd-anchor-link"><code>removeOnExecuted</code> behaviour<a href="#behaviour" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The boolean flag <a href="#removeonexecuted" class="tsd-kind-property">removeOnExecuted</a> controls whether entries are
deleted from the stream after being acknowledged:</p>
<ul>
<li>
<p><code>removeOnExecuted === false</code> (default):</p>
<ul>
<li>Only <code>XACK</code> is performed.</li>
<li>The entries remain in the stream history but are no longer pending
for this consumer group.</li>
</ul>
</li>
<li>
<p><code>removeOnExecuted === true</code>:</p>
<ul>
<li><code>XACK</code> is called,</li>
<li>then the script tries <code>XDEL</code> (best-effort, falls back to per-ID loop
if bulk deletion command fails).</li>
</ul>
</li>
</ul>
<hr>
<h2 id="error-handling" class="tsd-anchor-link">Error handling<a href="#error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Any internal Redis/script errors are thrown by <a href="#runscript" class="tsd-kind-method">runScript</a> and
handled by the caller (usually the worker loop).</li>
<li>The Lua script itself is defensive: if bulk <code>XDEL</code> fails, it falls back
to deleting IDs one by one.</li>
</ul>
<hr>
<h2 id="when-it-is-used" class="tsd-anchor-link">When it is used<a href="#when-it-is-used" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Called from <a href="#consumerloop" class="tsd-kind-method">consumerLoop</a> after a batch of tasks has been processed:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">ids</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(...);</span><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-0">isArrFilled</span><span class="hl-1">(</span><span class="hl-5">ids</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">approve</span><span class="hl-1">(</span><span class="hl-5">ids</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>As a library user, you usually don't call <code>approve()</code> directly - the
queue worker handles it for you.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">ids</span>: <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Array of Redis stream entry IDs that were successfully
processed and should be acknowledged (and maybe deleted).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">&gt;</span></h4><p>The total number of entries acknowledged by <code>XACK</code>.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3494">PowerQueues.ts:3494</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="attempt"><code class="tsd-tag">Private</code><span>attempt</span><a href="#attempt" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="attempt-1"><span class="tsd-kind-call-signature">attempt</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">err</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">attempt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#attempt-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Notifies user code that a <strong>retry attempt</strong> is happening for a failed task.</p>
<p>This method is a thin wrapper around the <a href="#onretry" class="tsd-kind-method">onRetry</a> hook.
It does not contain business logic itself - it only forwards all
necessary context so you can implement custom behaviour on retries.</p>
<hr>
<h2 id="when-this-method-is-called" class="tsd-anchor-link">When this method is called<a href="#when-this-method-is-called" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>It is invoked inside <a href="#executeprocess" class="tsd-kind-method">executeProcess</a> (and the idempotent path) <strong>after</strong>:</p>
<ol>
<li>The task has thrown an error in <code>onExecute</code>.</li>
<li>The retry counter has been incremented by <a href="#incrattempts" class="tsd-kind-method">incrAttempts</a>.</li>
</ol>
<p>At this point:</p>
<ul>
<li>The task is considered <strong>failed but retryable</strong>.</li>
<li><code>attempt</code> already reflects the new attempt number (1 = first retry).</li>
</ul>
<hr>
<h2 id="what-you-can-do-in" class="tsd-anchor-link">What you can do in <code>onRetry</code><a href="#what-you-can-do-in" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>You usually <strong>override <code>onRetry</code></strong> in a subclass to:</p>
<ul>
<li>log retry attempts with structured data;</li>
<li>send metrics (e.g., to Prometheus, Datadog, etc.);</li>
<li>trigger alerts when attempts exceed some threshold;</li>
<li>apply custom backoff logic (combined with your own scheduling).</li>
</ul>
<p>Example override:</p>
<pre><code class="ts"><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onRetry</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">, </span><span class="hl-5">attempt</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">logger</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&#39;Retrying task&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-5">id</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">job</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">attempt</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">error:</span><span class="hl-1"> </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">?.</span><span class="hl-5">message</span><span class="hl-1"> || </span><span class="hl-5">err</span><span class="hl-1">),</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Note: <code>attempt()</code> itself <strong>does not</strong> change scheduling or delay - it only
calls <code>onRetry</code>. Actual retry timing is handled by the queue worker and
the consumer loop.</p>
<hr>
<h2 id="parameters" class="tsd-anchor-link">Parameters<a href="#parameters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><code>err</code>       - The error thrown by your <code>onExecute</code> handler.</li>
<li><code>id</code>        - Redis stream entry ID for this task (e.g. <code>&quot;1700000000000-0&quot;</code>).</li>
<li><code>payload</code>   - Task payload (already decoded if it was JSON).</li>
<li><code>createdAt</code> - Task creation timestamp in milliseconds.</li>
<li><code>job</code>       - Job/batch ID that groups related tasks.</li>
<li><code>key</code>       - Idempotency key for this task (may be an empty string).</li>
<li><code>attempt</code>   - Current retry attempt number (1 for first retry, 2 for second, etc.).</li>
</ul>
<p>As a library user, you rarely call this method directly - instead you implement
<code>onRetry</code> and let the queue call it for you.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">err</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Error that caused the retry.</p>
</div></li><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis entry ID of the failed task.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Parsed task payload.</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation timestamp (ms).</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job/batch identifier.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key or empty string.</p>
</div></li><li><span><span class="tsd-kind-parameter">attempt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Current retry attempt count for this task.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3054">PowerQueues.ts:3054</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="attemptskey"><code class="tsd-tag">Private</code><span>attempts<wbr/>Key</span><a href="#attemptskey" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="attemptskey-1"><span class="tsd-kind-call-signature">attemptsKey</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><a href="#attemptskey-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Builds a <strong>Redis key</strong> used to track how many times a specific message
(stream entry) has been retried by the worker.</p>
<p>The key format is:</p>
<pre><code class="text">q:&lt;sanitized-stream-name&gt;:attempts:&lt;sanitized-id&gt;
</code><button type="button">Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>&lt;sanitized-stream-name&gt;</code> is <code>this.stream</code> with all characters
except letters, digits, <code>_</code>, <code>:</code>, and <code>-</code> replaced by <code>_</code>.</li>
<li><code>&lt;sanitized-id&gt;</code> is the Redis entry ID (e.g. <code>1700000000000-0</code>)
sanitized in the same way.</li>
</ul>
<p>Sanitizing ensures:</p>
<ul>
<li>the key is always a <strong>safe Redis key</strong> (no spaces, weird symbols, etc.);</li>
<li>all attempt counters follow a predictable pattern that can be inspected
or cleaned up manually if needed.</li>
</ul>
<p>This helper is used internally by:</p>
<ul>
<li><a href="#incrattempts" class="tsd-kind-method">incrAttempts</a> - to increment the retry counter;</li>
<li><a href="#getattempts" class="tsd-kind-method">getAttempts</a> - to read the current retry counter;</li>
<li><a href="#clearattempts" class="tsd-kind-method">clearAttempts</a> - to remove the counter once the task is done or dead-lettered.</li>
</ul>
<h3 id="example-key" class="tsd-anchor-link">Example key<a href="#example-key" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If:</p>
<pre><code class="ts"><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1"> = </span><span class="hl-2">&#39;queues:payments&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">id</span><span class="hl-1">          = </span><span class="hl-2">&#39;1700000000000-0&#39;</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>Then:</p>
<pre><code class="ts"><span class="hl-0">attemptsKey</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">) === </span><span class="hl-2">&#39;q:queues:payments:attempts:1700000000000-0&#39;</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID for which we track retry attempts.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">string</span></h4><p>A namespaced, sanitized Redis key string for the attempts counter.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2517">PowerQueues.ts:2517</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="batcherror"><code class="tsd-tag">Private</code><span>batch<wbr/>Error</span><a href="#batcherror" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="batcherror-1"><span class="tsd-kind-call-signature">batchError</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">err</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">tasks</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#batcherror-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Handles <strong>batch-level errors</strong> by forwarding them to the user hook
<a href="#onbatcherror" class="tsd-kind-method">onBatchError</a>.</p>
<p>This method is used when something goes wrong at the <strong>&quot;batch&quot; level</strong>,
not at the level of a single task.<br>
For example:</p>
<ul>
<li>An unhandled error is thrown inside the main consumer loop:
<ul>
<li>network issues,</li>
<li>invalid data structure returned from Redis,</li>
<li>unexpected error in <code>select()</code> or <code>execute()</code>.</li>
</ul>
</li>
<li>An error happens while processing a group of tasks together
(e.g. inside <code>execute()</code> when using <code>executeBatchAtOnce</code>).</li>
</ul>
<p>In these situations, we:</p>
<ol>
<li><strong>Do not</strong> try to decide per-task what to do.</li>
<li>Simply call the user-provided hook:<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">onBatchError</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">tasks</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
</ol>
<p>This gives you a single place to:</p>
<ul>
<li>log severe errors,</li>
<li>push alerts to monitoring systems,</li>
<li>perform diagnostics on the whole batch,</li>
<li>decide if some external recovery or throttling is needed.</li>
</ul>
<h3 id="parameters-1" class="tsd-anchor-link">Parameters<a href="#parameters-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>
<p><code>err</code> - The error object that was thrown.<br>
Can be anything (<code>Error</code>, string, custom object, etc.).</p>
</li>
<li>
<p><code>tasks</code> - Optional array of tasks that were being processed as a batch
when the error occurred. The structure of each item is:</p>
<pre><code class="ts"><span class="hl-1">[ </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">idemKey</span><span class="hl-1"> ]</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><code>id: string</code>        - Redis stream entry ID</li>
<li><code>payload: any[]</code>    - normalized key/value list for the task</li>
<li><code>createdAt: number</code> - timestamp (ms)</li>
<li><code>job: string</code>       - job/batch ID</li>
<li><code>idemKey: string</code>   - idempotency key (may be empty string)</li>
</ul>
<p><code>tasks</code> may be <code>undefined</code> if the error happened <strong>before</strong> we had a list
of tasks (for example, in <code>select()</code>).</p>
</li>
</ul>
<h3 id="typical-usage-override-example" class="tsd-anchor-link">Typical usage (override example)<a href="#typical-usage-override-example" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onBatchError</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">tasks</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">logger</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&#39;Batch failure&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-5">error:</span><span class="hl-1"> </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">?.</span><span class="hl-5">message</span><span class="hl-1"> || </span><span class="hl-5">err</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-5">count:</span><span class="hl-1"> </span><span class="hl-5">tasks</span><span class="hl-1">?.</span><span class="hl-5">length</span><span class="hl-1"> ?? </span><span class="hl-7">0</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>As a user of <code>PowerQueues</code>, you usually override <a href="#onbatcherror" class="tsd-kind-method">onBatchError</a>
instead of calling this method directly.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">err</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>The error that occurred during batch processing.</p>
</div></li><li><span><code class="tsd-tag">Optional</code><span class="tsd-kind-parameter">tasks</span>: <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Optional list of tasks being processed when the error happened.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2878">PowerQueues.ts:2878</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="buildbatches"><code class="tsd-tag">Private</code><span>build<wbr/>Batches</span><a href="#buildbatches" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="buildbatches-1"><span class="tsd-kind-call-signature">buildBatches</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">tasks</span><span class="tsd-signature-symbol">:</span> <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-kind-parameter">idem</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">[]</span><a href="#buildbatches-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Splits an array of logical tasks into <strong>batches</strong> that are safe to send to Redis
in a single <code>XADD</code> bulk call.</p>
<p>It also <strong>normalizes</strong> each task by:</p>
<ul>
<li>injecting <code>createdAt</code> (if missing),</li>
<li>injecting <code>job</code> (the shared job/batch ID),</li>
<li>optionally injecting <code>idemKey</code> for idempotency.</li>
</ul>
<p>The output is a 2D array: <code>Task[][]</code>, where each inner array is a batch.
These batches are later passed to <a href="#payloadbatch" class="tsd-kind-method">payloadBatch</a> and <a href="#xaddbatch" class="tsd-kind-method">xaddBatch</a>.</p>
<h3 id="why-batching-is-needed" class="tsd-anchor-link">Why batching is needed<a href="#why-batching-is-needed" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>We want to:</p>
<ul>
<li>avoid sending too many tasks in a single Lua execution;</li>
<li>avoid hitting Redis protocol / command argument limits;</li>
<li>keep each batch <strong>reasonably small</strong>, both in number of tasks and number of fields.</li>
</ul>
<p>This method uses two internal limits:</p>
<ul>
<li><a href="#addingbatchtaskscount" class="tsd-kind-property">addingBatchTasksCount</a> - max number of tasks per batch;</li>
<li><a href="#addingbatchkeyslimit" class="tsd-kind-property">addingBatchKeysLimit</a>  - max total number of field/value tokens per batch.</li>
</ul>
<p>Once either limit would be exceeded by adding the next task, a <strong>new batch</strong> is started.</p>
<h3 id="what-this-method-does-to-each-task" class="tsd-anchor-link">What this method does to each task<a href="#what-this-method-does-to-each-task" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For every input <code>task</code>:</p>
<ol>
<li>
<p>Ensures <code>createdAt</code>:</p>
<ul>
<li>If <code>task.createdAt</code> is present, it is used as-is.</li>
<li>Otherwise, <code>Date.now()</code> is used.</li>
</ul>
</li>
<li>
<p>Wraps object payloads:</p>
<ul>
<li>If <code>task.payload</code> is a plain object (<code>isObj(entry.payload)</code>):<pre><code class="ts"><span class="hl-5">entry</span><span class="hl-1"> = {</span><br/><span class="hl-1">  ...</span><span class="hl-5">task</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">payload:</span><span class="hl-1"> </span><span class="hl-4">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-5">task</span><span class="hl-1">.</span><span class="hl-5">payload</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-5">createdAt</span><span class="hl-1">,        </span><span class="hl-9">// number (ms)</span><br/><span class="hl-1">    </span><span class="hl-5">job</span><span class="hl-1">,              </span><span class="hl-9">// string (shared job ID)</span><br/><span class="hl-1">    idemKey?</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-9">// only if idem === true</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

</li>
<li>This means Redis always stores a small envelope with:
<ul>
<li><code>payload</code>  - original payload serialized as JSON string;</li>
<li><code>createdAt</code> - timestamp in ms;</li>
<li><code>job</code> - job ID;</li>
<li><code>idemKey</code> - optional idempotency key when <code>idem</code> is <code>true</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Extends flat payloads:</p>
<ul>
<li>If <code>task.flat</code> is an array:<pre><code class="ts"><span class="hl-5">entry</span><span class="hl-1">.</span><span class="hl-5">flat</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&#39;createdAt&#39;</span><span class="hl-1">, </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">createdAt</span><span class="hl-1">));</span><br/><span class="hl-5">entry</span><span class="hl-1">.</span><span class="hl-5">flat</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&#39;job&#39;</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">);</span><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">idem</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">entry</span><span class="hl-1">.</span><span class="hl-5">flat</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-2">&#39;idemKey&#39;</span><span class="hl-1">, </span><span class="hl-5">entry</span><span class="hl-1">.</span><span class="hl-5">idemKey</span><span class="hl-1"> || </span><span class="hl-0">uuid</span><span class="hl-1">());</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</li>
<li>Here we directly append new field/value pairs to the existing flat structure.</li>
</ul>
</li>
<li>
<p>If <code>idem</code> (idempotency) is enabled:</p>
<ul>
<li>For object payloads, a new <code>idemKey</code> field is added to <code>payload</code>:
<ul>
<li>Uses <code>task.idemKey</code> if provided,</li>
<li>otherwise generates one via <code>uuid()</code>.</li>
</ul>
</li>
<li>For flat payloads, <code>idemKey</code> is appended to <code>flat</code> similarly.</li>
<li>This key is later used by idempotency logic in <a href="#idempotency" class="tsd-kind-method">idempotency</a>.</li>
</ul>
</li>
</ol>
<h3 id="batch-splitting-logic" class="tsd-anchor-link">Batch splitting logic<a href="#batch-splitting-logic" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For each normalized <code>entry</code>:</p>
<ol>
<li>
<p>Calculate how many tokens (field/value + meta) this task will consume using <a href="#keyslength" class="tsd-kind-method">keysLength</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">reqKeysLength</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">keysLength</span><span class="hl-1">(</span><span class="hl-5">entry</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p>If there is already at least one task in the current <code>batch</code>, we check:</p>
<ul>
<li><code>batch.length &gt;= this.addingBatchTasksCount</code>, <strong>or</strong></li>
<li><code>realKeysLength + reqKeysLength &gt; this.addingBatchKeysLimit</code></li>
</ul>
<p>If either is true:</p>
<ul>
<li>push the current batch to <code>batches</code>,</li>
<li>start a new batch,</li>
<li>reset <code>realKeysLength</code>.</li>
</ul>
</li>
<li>
<p>Push the current <code>entry</code> into the (possibly new) <code>batch</code> and update <code>realKeysLength</code>.</p>
</li>
<li>
<p>After the loop finishes, if the last <code>batch</code> is non-empty, it is also pushed into <code>batches</code>.</p>
</li>
</ol>
<h3 id="return-value" class="tsd-anchor-link">Return value<a href="#return-value" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Returns an array of batches:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  [ </span><span class="hl-5">entry1</span><span class="hl-1">, </span><span class="hl-5">entry2</span><span class="hl-1">, ... ], </span><span class="hl-9">// batch #1</span><br/><span class="hl-1">  [ </span><span class="hl-5">entryX</span><span class="hl-1">, </span><span class="hl-5">entryY</span><span class="hl-1">, ... ], </span><span class="hl-9">// batch #2</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>Each <code>entry</code> is a <code>Task</code>-like object, but with <code>payload</code>/<code>flat</code> enriched
with <code>createdAt</code>, <code>job</code> and optionally <code>idemKey</code>.</p>
<h3 id="when-to-use" class="tsd-anchor-link">When to use<a href="#when-to-use" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>This method is used internally by <a href="#addtasks" class="tsd-kind-method">addTasks</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">job</span><span class="hl-1"> = </span><span class="hl-0">uuid</span><span class="hl-1">();</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">batches</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">buildBatches</span><span class="hl-1">(</span><span class="hl-5">data</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">.</span><span class="hl-5">idem</span><span class="hl-1">);</span><br/><span class="hl-6">for</span><span class="hl-1"> (</span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">batch</span><span class="hl-1"> </span><span class="hl-3">of</span><span class="hl-1"> </span><span class="hl-5">batches</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">argv</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">payloadBatch</span><span class="hl-1">(</span><span class="hl-5">batch</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">xaddBatch</span><span class="hl-1">(</span><span class="hl-5">queueName</span><span class="hl-1">, ...</span><span class="hl-5">argv</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>As a user of <code>PowerQueues</code>, you usually <strong>do not call this directly</strong>,
but understanding it helps to reason about:</p>
<ul>
<li>how many tasks go into one Redis script call,</li>
<li>how <code>createdAt</code>, <code>job</code>, and <code>idemKey</code> appear inside stream entries.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">tasks</span>: <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Original list of tasks that should be added to the stream.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Shared job/batch ID used to tag all tasks in this operation.</p>
</div></li><li><span><code class="tsd-tag">Optional</code><span class="tsd-kind-parameter">idem</span>: <span class="tsd-signature-type">boolean</span></span><div class="tsd-comment tsd-typography"><p>If <code>true</code>, generate/use <code>idemKey</code> for idempotent processing.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">[]</span></h4><p>An array of task batches, respecting <code>addingBatchTasksCount</code>
and <code>addingBatchKeysLimit</code>.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2324">PowerQueues.ts:2324</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="clearattempts"><code class="tsd-tag">Private</code><span>clear<wbr/>Attempts</span><a href="#clearattempts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="clearattempts-1"><span class="tsd-kind-call-signature">clearAttempts</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#clearattempts-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Deletes the <strong>retry-attempt counter</strong> for a specific task.</p>
<p>This method is called when:</p>
<ul>
<li>a task <strong>succeeds</strong> and should no longer carry retry history;</li>
<li>a task <strong>reaches max retries</strong> and is sent to the DLQ (dead-letter queue);</li>
<li>idempotent execution completes and the attempt counter should be reset.</li>
</ul>
<p>Clearing the attempts key ensures that:</p>
<ul>
<li>Redis does not accumulate stale counter keys,</li>
<li>a future task with the same entry ID (rare but possible in tests)
starts with a clean retry count,</li>
<li>monitoring systems do not misinterpret old failures as new ones.</li>
</ul>
<h3 id="how-it-works" class="tsd-anchor-link">How it works<a href="#how-it-works" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>Builds the Redis key from the stream and ID using <a href="#attemptskey" class="tsd-kind-method">attemptsKey</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">attemptsKey</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p>Executes:</p>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">redis</span><span class="hl-1">.</span><span class="hl-0">del</span><span class="hl-1">(</span><span class="hl-5">key</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
</ol>
<p>The method is fully safe:</p>
<ul>
<li>If the key does not exist → no error.</li>
<li>If Redis throws (e.g., transient connection issue) → the error is swallowed.
This prevents a cleanup failure from breaking the queue worker.</li>
</ul>
<h3 id="when-it-is-invoked" class="tsd-anchor-link">When it is invoked<a href="#when-it-is-invoked" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>After a successful execution in <a href="#executeprocess" class="tsd-kind-method">executeProcess</a>.</li>
<li>After moving a task to the DLQ.</li>
<li>After idempotency paths that finish with an irreversible result.</li>
</ul>
<h3 id="example-23" class="tsd-anchor-link">Example<a href="#example-23" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">clearAttempts</span><span class="hl-1">(</span><span class="hl-2">&quot;1700000000000-0&quot;</span><span class="hl-1">);</span><br/><span class="hl-9">// The task now has no retry history.</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID whose retry counter should be cleared.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2707">PowerQueues.ts:2707</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="consumer"><code class="tsd-tag">Private</code><span>consumer</span><a href="#consumer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="consumer-1"><span class="tsd-kind-call-signature">consumer</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><a href="#consumer-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Generates a unique <strong>consumer identifier</strong> for this worker instance.</p>
<p>Redis consumer groups require each worker to supply a <code>consumer</code> name
when reading from a stream via <code>XREADGROUP</code>. This method returns a
predictable, unique identifier for the current process.</p>
<h3 id="format" class="tsd-anchor-link">Format<a href="#format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The returned string has the form:</p>
<pre><code><span class="hl-1">{</span><span class="hl-5">host</span><span class="hl-1">}:{</span><span class="hl-5">pid</span><span class="hl-1">}</span>
</code><button>Copy</button></pre>

<ul>
<li><code>{host}</code> - taken from <code>this.consumerHost</code><br>
(defaults to <code>&quot;host&quot;</code> unless overridden in your subclass or instance)</li>
<li><code>{pid}</code> - the current Node.js process ID (<code>process.pid</code>)</li>
</ul>
<p>Example:</p>
<pre><code><span class="hl-2">&quot;worker-1:48210&quot;</span><br/><span class="hl-2">&quot;prod-api:10933&quot;</span>
</code><button>Copy</button></pre>

<h3 id="why-this-matters" class="tsd-anchor-link">Why this matters<a href="#why-this-matters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Each consumer in a Redis consumer group must have a <strong>unique name</strong>.</li>
<li>Names are used for:
<ul>
<li>Pending-entry tracking,</li>
<li>Idle time measurement,</li>
<li>Worker crash detection,</li>
<li>Task claiming (<code>XAUTOCLAIM</code>),</li>
<li>Monitoring via <code>XPENDING</code>.</li>
</ul>
</li>
<li>Using <code>{host}:{pid}</code> makes it very unlikely for two workers on the same
machine to collide, and completely avoids collisions across machines.</li>
</ul>
<h3 id="how-it-is-used" class="tsd-anchor-link">How it is used<a href="#how-it-is-used" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>When reading messages:</li>
</ul>
<pre><code class="ts"><span class="hl-0">xreadgroup</span><span class="hl-1">(</span><span class="hl-2">&#39;GROUP&#39;</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">consumer</span><span class="hl-1">(), ...)</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>When recovering stuck messages:</li>
</ul>
<pre><code class="ts"><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">runScript</span><span class="hl-1">(</span><span class="hl-2">&#39;SelectStuck&#39;</span><span class="hl-1">, [</span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1">], [</span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">consumer</span><span class="hl-1">(), ...])</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>When generating idempotency tokens (part of the idempotency lock logic):</li>
</ul>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">token</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-3">this</span><span class="hl-11">.</span><span class="hl-0">consumer</span><span class="hl-11">()</span><span class="hl-3">}</span><span class="hl-2">:</span><span class="hl-3">${</span><span class="hl-5">Date</span><span class="hl-11">.</span><span class="hl-0">now</span><span class="hl-11">().</span><span class="hl-0">toString</span><span class="hl-11">(</span><span class="hl-7">36</span><span class="hl-11">)</span><span class="hl-3">}</span><span class="hl-2">:</span><span class="hl-3">${</span><span class="hl-5">Math</span><span class="hl-11">.</span><span class="hl-0">random</span><span class="hl-11">().</span><span class="hl-0">toString</span><span class="hl-11">(</span><span class="hl-7">36</span><span class="hl-11">).</span><span class="hl-0">slice</span><span class="hl-11">(</span><span class="hl-7">2</span><span class="hl-11">)</span><span class="hl-3">}</span><span class="hl-2">`</span>
</code><button type="button">Copy</button></pre>

<h3 id="customization" class="tsd-anchor-link">Customization<a href="#customization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You may override <code>this.consumerHost</code> in a subclass or via constructor
configuration to give meaningful names such as:</p>
<pre><code><span class="hl-2">&quot;api-queue-worker&quot;</span><br/><span class="hl-2">&quot;batch-service&quot;</span><br/><span class="hl-2">&quot;worker-eu-central-1&quot;</span>
</code><button>Copy</button></pre>

</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">string</span></h4><p>A string uniquely identifying this worker instance in Redis.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L5063">PowerQueues.ts:5063</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="consumerloop"><span>consumer<wbr/>Loop</span><a href="#consumerloop" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="consumerloop-1"><span class="tsd-kind-call-signature">consumerLoop</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#consumerloop-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Main infinite worker loop responsible for:</p>
<ul>
<li>selecting tasks from Redis,</li>
<li>running all lifecycle hooks,</li>
<li>executing tasks with retry/idempotency,</li>
<li>acknowledging completed messages.</li>
</ul>
<p>This loop continues running <strong>until the worker is aborted</strong>
via <code>this.abort.abort()</code>.</p>
<p>Execution Flow (per iteration):</p>
<ol>
<li>
<p><strong>Check abort signal</strong><br>
If the worker has been stopped, exit the loop gracefully.</p>
</li>
<li>
<p><strong>Select tasks</strong> via <code>select()</code></p>
<ul>
<li>First tries to claim <em>stuck</em> tasks (<code>selectStuck()</code>),</li>
<li>Otherwise reads fresh messages (<code>selectFresh()</code>),</li>
<li>Normalizes entries into tuples:
<code>[id, payload, createdAt, job, idemKey]</code>.</li>
</ul>
</li>
<li>
<p><strong>onSelected() hook</strong><br>
Allows filtering, reordering, or modifying the selected tasks.</p>
<ul>
<li>If it returns a non-empty array → use that one.</li>
<li>Otherwise → use the original tasks.</li>
</ul>
</li>
<li>
<p><strong>Execute tasks</strong> via <code>execute()</code><br>
Handles:</p>
<ul>
<li>retries,</li>
<li>DLQ logic,</li>
<li>idempotency flow,</li>
<li>onExecute / onRetry / onError / onSuccess,</li>
<li>batching execution behavior.</li>
</ul>
</li>
<li>
<p><strong>ACK completed tasks</strong></p>
<ul>
<li>Uses Lua script <code>Approve</code> to XACK (+ optionally XDEL).</li>
<li>Runs in batches for high throughput.</li>
</ul>
</li>
<li>
<p><strong>Error handling</strong><br>
If anything inside the loop throws:</p>
<ul>
<li>error is passed to <code>onBatchError()</code>,</li>
<li>worker waits briefly and continues.</li>
</ul>
</li>
</ol>
<p>Behavior:</p>
<ul>
<li>The loop uses very small waits (<code>wait(600)</code> ms) when no tasks are available.</li>
<li>Designed to be <strong>lightweight</strong>, <strong>efficient</strong>, and <strong>fault-tolerant</strong>.</li>
<li>Does not block the event loop thanks to async/await.</li>
</ul>
<p>Stopping the loop:</p>
<ul>
<li>Call <code>this.abort.abort()</code>.</li>
<li>The loop checks for <code>signal.aborted</code> on each iteration and stops cleanly.</li>
</ul>
<p>Notes:</p>
<ul>
<li>You normally never override this method.<br>
Use hooks (<code>onSelected</code>, <code>onExecute</code>, <code>onReady</code>, etc.) instead.</li>
<li>If the queue encounters unexpected Redis failures,
the loop will continue after logging via <code>onBatchError()</code>.</li>
<li>Safe to run in process managers (PM2, Docker, Kubernetes) as a long-running worker.</li>
</ul>
</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-24">Example<a href="#example-24" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Typical worker startup</span><br/><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">start</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">worker</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">MyQueue</span><span class="hl-1">(</span><span class="hl-5">redis</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-5">worker</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1"> = </span><span class="hl-2">&#39;orders&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">worker</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1"> = </span><span class="hl-2">&#39;billing&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">worker</span><span class="hl-1">.</span><span class="hl-0">runQueue</span><span class="hl-1">(); </span><span class="hl-9">// begins consumerLoop()</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1540">PowerQueues.ts:1540</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="creategroup"><code class="tsd-tag">Private</code><span>create<wbr/>Group</span><a href="#creategroup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="creategroup-1"><span class="tsd-kind-call-signature">createGroup</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">from</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">&quot;$&quot;</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">&quot;0-0&quot;</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#creategroup-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Ensures that a Redis <strong>consumer group</strong> exists for the current stream.</p>
<p>This helper wraps the <code>XGROUP CREATE</code> command and is used by the worker
loop before reading tasks with <code>XREADGROUP</code> or claiming pending entries.</p>
<p>If the group already exists, Redis returns a <code>BUSYGROUP</code> error.<br>
In that case the error is <strong>silently ignored</strong>, because it simply means
that another worker has already created the group. Any other error is
rethrown so that configuration / connection issues are not hidden.</p>
<p>Internally it executes:</p>
<pre><code class="bash"><span class="hl-0">XGROUP</span><span class="hl-1"> </span><span class="hl-2">CREATE</span><span class="hl-1"> </span><span class="hl-2">{stream}</span><span class="hl-1"> </span><span class="hl-2">{group}</span><span class="hl-1"> </span><span class="hl-2">{from}</span><span class="hl-1"> </span><span class="hl-2">MKSTREAM</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><code>MKSTREAM</code> tells Redis to create the stream automatically if it does not
exist yet. This makes startup more robust when the stream is empty.</li>
<li><code>{from}</code> defines <strong>where the group starts reading</strong>:
<ul>
<li><code>'0-0'</code> → the group will see <strong>all past entries</strong> from the beginning.</li>
<li><code>'$'</code>   → the group will only see <strong>new entries</strong> added after creation.</li>
</ul>
</li>
</ul>
<h3 id="where-it-is-used" class="tsd-anchor-link">Where it is used<a href="#where-it-is-used" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Called by <a href="#runqueue" class="tsd-kind-method">runQueue</a> / <a href="#consumerloop" class="tsd-kind-method">consumerLoop</a> to make sure the group is ready.</li>
<li>Also used by <a href="#selectstuck" class="tsd-kind-method">selectStuck</a> and <a href="#selectfresh" class="tsd-kind-method">selectFresh</a> when they detect
a <code>NOGROUP</code> error from Redis.</li>
</ul>
<p>This method is <strong>idempotent</strong>: calling it many times is safe, because
the <code>BUSYGROUP</code> error is treated as a &quot;group already exists&quot; signal.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">from</span>: <span class="tsd-signature-type">&quot;$&quot;</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">&quot;0-0&quot;</span><span class="tsd-signature-symbol"> = &#39;$&#39;</span></span><div class="tsd-comment tsd-typography"><p>Starting ID for the consumer group:</p>
<ul>
<li><code>'0-0'</code> - consume the entire history of the stream.</li>
<li><code>'$'</code>   - start from the latest message only (default).</li>
</ul>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise that resolves when the group is successfully created
or already exists. Rejects only on unexpected Redis errors.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4022">PowerQueues.ts:4022</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="error"><code class="tsd-tag">Private</code><span>error</span><a href="#error" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="error-1"><span class="tsd-kind-call-signature">error</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">err</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">attempt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#error-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Handles <strong>task-level execution errors</strong> by updating job status (optional),
invoking retry/error hooks, and performing error-side effects that should
happen when a single task fails.</p>
<p>This method is called when:</p>
<ul>
<li><code>onExecute()</code> throws an error, <strong>and</strong></li>
<li>the task is <em>not</em> using idempotency (idempotent tasks use a separate error path).</li>
</ul>
<p>It is part of the normal retry flow inside <a href="#executeprocess" class="tsd-kind-method">executeProcess</a>.</p>
<hr>
<h2 id="what-this-method-does-1" class="tsd-anchor-link">What this method does<a href="#what-this-method-does-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="1-updates-execution-status-counters-optional" class="tsd-anchor-link">1. Updates execution-status counters (optional)<a href="#1-updates-execution-status-counters-optional" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Only when <strong>all retries are exhausted</strong> (i.e., <code>attempt &gt;= workerMaxRetries</code>)
and <a href="#executejobstatus" class="tsd-kind-property">executeJobStatus</a> is enabled:</p>
<ul>
<li>
<p><code>&lt;stream&gt;:&lt;job&gt;:err</code><br>
→ total number of tasks that ultimately failed.</p>
</li>
<li>
<p><code>&lt;stream&gt;:&lt;job&gt;:ready</code><br>
→ number of tasks that finished (success or final failure).</p>
</li>
</ul>
<p>These ephemeral counters (TTL = <a href="#executejobstatusttlms" class="tsd-kind-property">executeJobStatusTtlMs</a>) help track:</p>
<ul>
<li>job progress,</li>
<li>failure rates,</li>
<li>stuck jobs.</li>
</ul>
<h3 id="2-forwards-the-error-to-the-user-hook-onerror" class="tsd-anchor-link">2. Forwards the error to the user hook <a href="#onerror" class="tsd-kind-method">onError</a><a href="#2-forwards-the-error-to-the-user-hook-onerror" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">onError</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This allows the user to:</p>
<ul>
<li>log errors,</li>
<li>notify monitoring systems,</li>
<li>inspect failed payloads,</li>
<li>perform per-task cleanups.</li>
</ul>
<h3 id="3-earlier-in-the-flow-the-retry-counter-has-already-been-incremented" class="tsd-anchor-link">3. (Earlier in the flow) the retry counter has already been incremented<a href="#3-earlier-in-the-flow-the-retry-counter-has-already-been-incremented" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>This method <strong>does not increment retries</strong> itself - that is done by:</p>
<ul>
<li><a href="#incrattempts" class="tsd-kind-method">incrAttempts</a></li>
</ul>
<p>By the time <code>error()</code> is invoked, we already know the final <code>attempt</code> number.</p>
<hr>
<h2 id="error-behaviour" class="tsd-anchor-link">Error behaviour<a href="#error-behaviour" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Any exception inside the user hook <code>onError</code> is caught upstream by callers.</li>
<li>This method <strong>never throws</strong> by design - task cleanup must not break the worker.</li>
</ul>
<hr>
<h2 id="relation-to-other-methods" class="tsd-anchor-link">Relation to other methods<a href="#relation-to-other-methods" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Called inside <a href="#executeprocess" class="tsd-kind-method">executeProcess</a> when non-idempotent task execution fails.</li>
<li>For idempotent tasks, error handling is implemented separately inside <a href="#idempotency" class="tsd-kind-method">idempotency</a>.</li>
</ul>
<hr>
<h2 id="parameters-2" class="tsd-anchor-link">Parameters<a href="#parameters-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><code>err</code>        - the thrown error (can be any type)</li>
<li><code>id</code>         - Redis stream entry ID (e.g., <code>&quot;1700000000000-0&quot;</code>)</li>
<li><code>payload</code>    - parsed task payload</li>
<li><code>createdAt</code>  - timestamp extracted from the entry</li>
<li><code>job</code>        - job/batch ID assigned in <a href="#addtasks" class="tsd-kind-method">addTasks</a></li>
<li><code>key</code>        - idempotency key (empty string for non-idempotent tasks)</li>
<li><code>attempt</code>    - current retry number (1 = first failure)</li>
</ul>
<hr>
<h2 id="example-override" class="tsd-anchor-link">Example override<a href="#example-override" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onError</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">logger</span><span class="hl-1">.</span><span class="hl-0">warn</span><span class="hl-1">(</span><span class="hl-2">&#39;Task failed:&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-5">id</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">?.</span><span class="hl-5">message</span><span class="hl-1"> || </span><span class="hl-5">err</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-5">createdAt</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">err</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Error thrown during task execution.</p>
</div></li><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis entry ID of the failed task.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Parsed payload object.</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation timestamp (ms).</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job/batch identifier.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key or empty string.</p>
</div></li><li><span><span class="tsd-kind-parameter">attempt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Current retry attempt count for this task.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2976">PowerQueues.ts:2976</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="execute"><code class="tsd-tag">Private</code><span>execute</span><a href="#execute" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="execute-1"><span class="tsd-kind-call-signature">execute</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">tasks</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#execute-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Executes a batch of <strong>already-selected tasks</strong> and returns the list of IDs
that were successfully processed and should be <strong>acknowledged</strong> (XACK).</p>
<p>This is the main worker-side &quot;runner&quot; that:</p>
<ul>
<li>calls <a href="#executeprocess" class="tsd-kind-method">executeProcess</a> for each task;</li>
<li>optionally runs tasks <strong>in parallel</strong> (see <a href="#executebatchatonce" class="tsd-kind-property">executeBatchAtOnce</a>);</li>
<li>tracks &quot;contended&quot; tasks (idempotency lock contention);</li>
<li>triggers the <a href="#onready" class="tsd-kind-method">onReady</a> hook after the batch is processed;</li>
<li>applies a small backoff when most tasks are contended;</li>
<li>on unexpected errors, forwards everything to <a href="#batcherror" class="tsd-kind-method">batchError</a>.</li>
</ul>
<hr>
<h2 id="input-format" class="tsd-anchor-link">Input format<a href="#input-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Each item in <code>tasks</code> is a tuple:</p>
<pre><code class="ts"><span class="hl-1">[ </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">idemKey</span><span class="hl-1"> ]</span>
</code><button type="button">Copy</button></pre>

<p>Where:</p>
<ul>
<li><code>id: string</code>        - Redis stream entry ID (e.g. <code>&quot;1700000000000-0&quot;</code>);</li>
<li><code>payload: any</code>      - decoded payload object (from the stream);</li>
<li><code>createdAt: number</code> - timestamp in ms (added when the task was enqueued);</li>
<li><code>job: string</code>       - job/batch identifier (same for all tasks of one job);</li>
<li><code>idemKey: string</code>   - idempotency key (empty string if not used).</li>
</ul>
<p>This format comes from <a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a>.</p>
<hr>
<h2 id="execution-strategy" class="tsd-anchor-link">Execution strategy<a href="#execution-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>For each task, <code>execute()</code> calls <a href="#executeprocess" class="tsd-kind-method">executeProcess</a>, which:</p>
<ul>
<li>runs user code via <a href="#onexecute" class="tsd-kind-method">onExecute</a>;</li>
<li>handles retries, DLQ, and idempotency;</li>
<li>returns an object like:
<ul>
<li><code>{ id: string }</code>       - task processed successfully (should be acked);</li>
<li><code>{ contended: true }</code>  - idempotency contention, task will be retried later;</li>
<li><code>{}</code> / other           - nothing to ack right now.</li>
</ul>
</li>
</ul>
<p>Depending on <a href="#executebatchatonce" class="tsd-kind-property">executeBatchAtOnce</a>:</p>
<ul>
<li>
<p><code>executeBatchAtOnce === false</code> (default)<br>
→ tasks are processed <strong>sequentially</strong>, one after another.</p>
</li>
<li>
<p><code>executeBatchAtOnce === true</code><br>
→ tasks are processed <strong>in parallel</strong>:</p>
<ul>
<li>each call to <code>executeProcess</code> is wrapped in a small async function;</li>
<li>promises are collected into an array;</li>
<li>after the loop, <code>Promise.all</code> waits for all of them.</li>
</ul>
</li>
</ul>
<p>In both modes:</p>
<ul>
<li>Successful tasks add their <code>id</code> to <code>result</code>.</li>
<li>Contended tasks increment a local <code>contended</code> counter.</li>
</ul>
<hr>
<h2 id="after-per-task-execution" class="tsd-anchor-link">After per-task execution<a href="#after-per-task-execution" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>After all tasks have been passed to <code>executeProcess</code>:</p>
<ol>
<li>
<p>If <code>executeBatchAtOnce</code> is <code>true</code> and there are promises,
<code>Promise.all(promises)</code> is awaited to ensure all tasks finished.</p>
</li>
<li>
<p><a href="#onready" class="tsd-kind-method">onReady</a> is called:</p>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">onReady</span><span class="hl-1">(</span><span class="hl-5">tasks</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This hook runs <strong>after</strong> the batch has been processed.<br>
Typical use cases:</p>
<ul>
<li>logging,</li>
<li>metrics / tracing,</li>
<li>emitting &quot;batch processed&quot; events.</li>
</ul>
</li>
<li>
<p><strong>Backoff on contention</strong>:
If:</p>
<ul>
<li>no tasks succeeded (<code>result</code> is empty),</li>
<li>more than half of the tasks were contended,
then the worker will wait a short, randomized delay:</li>
</ul>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">waitAbortable</span><span class="hl-1">(</span><span class="hl-5">dynamicDelayMs</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This helps in situations where many workers fight over the same
idempotency keys: we back off to reduce hot contention.</p>
</li>
</ol>
<hr>
<h2 id="error-handling-1" class="tsd-anchor-link">Error handling<a href="#error-handling-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Any error thrown inside:</p>
<ul>
<li><code>Promise.all(promises)</code> (parallel mode),</li>
<li><code>onReady(tasks)</code>,</li>
<li><code>waitAbortable(...)</code>,</li>
</ul>
<p>is caught and passed to <a href="#batcherror" class="tsd-kind-method">batchError</a>:</p>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">batchError</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">tasks</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This keeps the worker loop resilient:</p>
<ul>
<li>a failure in post-processing does <strong>not</strong> crash the whole consumer;</li>
<li>you get a single place (<code>onBatchError</code>) to inspect and log such failures.</li>
</ul>
<hr>
<h2 id="return-value-1" class="tsd-anchor-link">Return value<a href="#return-value-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The method returns an array of IDs:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">idsToAck</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-5">tasks</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>These are the tasks that:</p>
<ul>
<li>finished successfully (including DLQ finalization),</li>
<li>are safe to ACK via <a href="#approve" class="tsd-kind-method">approve</a>.</li>
</ul>
<p>Tasks that were contended or still in retry flow will <strong>not</strong> appear here.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">tasks</span>: <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Batch of normalized tasks to execute, in the form
<code>[id, payload, createdAt, job, idemKey]</code>.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A list of stream entry IDs that should be acknowledged.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3182">PowerQueues.ts:3182</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="executeprocess"><code class="tsd-tag">Private</code><span>execute<wbr/>Process</span><a href="#executeprocess" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="executeprocess-1"><span class="tsd-kind-call-signature">executeProcess</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">&gt;</span><a href="#executeprocess-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Executes a <strong>single task</strong> and decides what should happen with it:</p>
<ul>
<li>run normally,</li>
<li>retry later,</li>
<li>or send to DLQ (dead-letter queue).</li>
</ul>
<p>This is the core per-task runner used by <a href="#execute" class="tsd-kind-method">execute</a>.<br>
It hides all the details of:</p>
<ul>
<li>idempotent vs non-idempotent execution,</li>
<li>retries and attempt counters,</li>
<li>DLQ routing,
and returns a small result object that tells the caller if the task
can be safely acknowledged (XACK) or not.</li>
</ul>
<hr>
<h2 id="control-flow" class="tsd-anchor-link">Control flow<a href="#control-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="1-idempotent-path-when-is-non-empty" class="tsd-anchor-link">1. Idempotent path (when <code>key</code> is non-empty)<a href="#1-idempotent-path-when-is-non-empty" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If <code>key</code> (idemKey) is provided:</p>
<pre><code class="ts"><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">key</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotency</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The whole execution is delegated to <a href="#idempotency" class="tsd-kind-method">idempotency</a>, which:</p>
<ul>
<li>coordinates execution between multiple workers using locks,</li>
<li>ensures the same logical task is processed only once,</li>
<li>may return:
<ul>
<li><code>{ id }</code>          → task finished (success or DLQ), safe to ACK;</li>
<li><code>{ contended: true }</code> → another worker is currently handling it,
do <strong>not</strong> ACK, retry later;</li>
<li><code>{}</code>              → nothing to do / give up for now.</li>
</ul>
</li>
</ul>
<p>The exact semantics are documented in <a href="#idempotency" class="tsd-kind-method">idempotency</a>.</p>
<h3 id="2-non-idempotent-path-when-is-empty" class="tsd-anchor-link">2. Non-idempotent path (when <code>key</code> is empty)<a href="#2-non-idempotent-path-when-is-empty" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If there is <strong>no idempotency key</strong>, the method runs a simpler flow:</p>
<pre><code class="ts"><span class="hl-6">try</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">onExecute</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">, </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">getAttempts</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">));</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">success</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">id</span><span class="hl-1"> };</span><br/><span class="hl-1">}</span><br/><span class="hl-6">catch</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-9">// handle failure, retries, DLQ</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Steps:</p>
<ol>
<li>Reads the current attempt count via <a href="#getattempts" class="tsd-kind-method">getAttempts</a>.</li>
<li>Calls the user hook <a href="#onexecute" class="tsd-kind-method">onExecute</a> with all context:
<ul>
<li>this is where your business logic lives.</li>
</ul>
</li>
<li>If <code>onExecute</code> finishes without throwing:
<ul>
<li>calls <a href="#success" class="tsd-kind-method">success</a> to update job status &amp; fire <code>onSuccess</code>,</li>
<li>returns <code>{ id }</code> → caller will ACK this task.</li>
</ul>
</li>
</ol>
<p>If <code>onExecute</code> <strong>throws</strong>, we enter the <code>catch</code> block:</p>
<ol>
<li>
<p>Increment the retry counter via <a href="#incrattempts" class="tsd-kind-method">incrAttempts</a> → <code>attempt</code>.</p>
</li>
<li>
<p>Notify user code about the retry via <a href="#attempt" class="tsd-kind-method">attempt</a> (calls <code>onRetry</code>).</p>
</li>
<li>
<p>Call <a href="#error" class="tsd-kind-method">error</a> (calls <code>onError</code> and optionally updates job status).</p>
</li>
<li>
<p>If <code>attempt &gt;= workerMaxRetries</code>:</p>
<ul>
<li>
<p>the task is considered <strong>permanently failed</strong>,</p>
</li>
<li>
<p>it is moved to a <strong>DLQ stream</strong>:</p>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">addTasks</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-3">this</span><span class="hl-11">.</span><span class="hl-5">stream</span><span class="hl-3">}</span><span class="hl-2">:dlq`</span><span class="hl-1">, [{</span><br/><span class="hl-1">  </span><span class="hl-5">payload:</span><span class="hl-1"> {</span><br/><span class="hl-1">    ...</span><span class="hl-5">payload</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">error:</span><span class="hl-1"> </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">?.</span><span class="hl-5">message</span><span class="hl-1"> || </span><span class="hl-5">err</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-5">createdAt</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">job</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">id</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">attempt</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">}]);</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p>the attempt counter is cleared via <a href="#clearattempts" class="tsd-kind-method">clearAttempts</a>,</p>
</li>
<li>
<p>the method returns <code>{ id }</code> → task can be ACKed (we &quot;finished&quot; it by
sending to DLQ).</p>
</li>
</ul>
</li>
<li>
<p>If <code>attempt &lt; workerMaxRetries</code>:</p>
<ul>
<li>the method falls through to the final <code>return {}</code>:
<ul>
<li>no <code>{ id }</code> is returned,</li>
<li>caller will <strong>not</strong> ACK this task,</li>
<li>Redis will keep it as pending so it can be retried later.</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h2 id="return-value-2" class="tsd-anchor-link">Return value<a href="#return-value-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The returned object is intentionally very small:</p>
<ul>
<li>
<p><code>{ id: string }</code><br>
→ task is <strong>done</strong> (success or DLQ) and should be acknowledged.</p>
</li>
<li>
<p><code>{ contended: true }</code><br>
→ (idempotent path only) another worker is handling this logical task;
do <strong>not</strong> ACK, worker should back off / retry later.</p>
</li>
<li>
<p><code>{}</code><br>
→ nothing to ACK right now (e.g. failed but still under retry limit).</p>
</li>
</ul>
<p><a href="#execute" class="tsd-kind-method">execute</a> uses this shape to build the <code>ids</code> array passed to
<a href="#approve" class="tsd-kind-method">approve</a> (which actually performs <code>XACK</code> / <code>XDEL</code>).</p>
<hr>
<h2 id="parameters-3" class="tsd-anchor-link">Parameters<a href="#parameters-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><code>id</code>        - Redis stream entry ID (e.g. <code>&quot;1700000000000-0&quot;</code>).</li>
<li><code>payload</code>   - decoded payload of the task (object or primitive).</li>
<li><code>createdAt</code> - timestamp in ms when the task was enqueued.</li>
<li><code>job</code>       - job/batch ID shared across related tasks.</li>
<li><code>key</code>       - idempotency key; empty string means &quot;no idempotency&quot;.</li>
</ul>
<p>As a user, you typically do <strong>not</strong> call <code>executeProcess</code> directly -
you override hooks like <code>onExecute</code>, <code>onRetry</code>, <code>onError</code>, <code>onSuccess</code>
and let the worker handle the flow.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Stream entry ID for the task.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Task payload, already normalized/decoded.</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation time in milliseconds.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job/batch identifier of this task.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key (non-empty for idempotent tasks).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">&gt;</span></h4><p>An object describing the outcome: <code>{ id }</code>, <code>{ contended: true }</code>, or <code>{}</code>.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3360">PowerQueues.ts:3360</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="getattempts"><code class="tsd-tag">Private</code><span>get<wbr/>Attempts</span><a href="#getattempts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="getattempts-1"><span class="tsd-kind-call-signature">getAttempts</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">&gt;</span><a href="#getattempts-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Reads the current <strong>retry-attempt counter</strong> for a given task.</p>
<p>This method is the counterpart of <a href="#incrattempts" class="tsd-kind-method">incrAttempts</a>.<br>
It is used before executing a task to know how many times it has already failed.</p>
<h3 id="how-it-works-1" class="tsd-anchor-link">How it works<a href="#how-it-works-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>Builds the Redis key via <a href="#attemptskey" class="tsd-kind-method">attemptsKey</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">attemptsKey</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p>Performs a simple <code>GET</code>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">v</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">redis</span><span class="hl-1">.</span><span class="hl-0">get</span><span class="hl-1">(</span><span class="hl-5">key</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p>Converts the result to a number:</p>
<ul>
<li>If the key does not exist, returns <code>0</code>.</li>
<li>If the value exists but is not a number, <code>Number(v || 0)</code> still returns <code>0</code>.</li>
</ul>
</li>
</ol>
<h3 id="when-it-is-used-1" class="tsd-anchor-link">When it is used<a href="#when-it-is-used-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>
<p>Inside <a href="#executeprocess" class="tsd-kind-method">executeProcess</a> and <a href="#idempotency" class="tsd-kind-method">idempotency</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">attempt</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">getAttempts</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This tells the queue worker whether the task is on its:</p>
<ul>
<li>0th attempt (first execution),</li>
<li>1st retry,</li>
<li>2nd retry,</li>
<li>etc.</li>
</ul>
</li>
<li>
<p>It is also useful for logging, metrics, or custom retry logic if you override hooks like:</p>
<ul>
<li><a href="#onexecute" class="tsd-kind-method">onExecute</a></li>
<li><a href="#onretry" class="tsd-kind-method">onRetry</a></li>
<li><a href="#onerror" class="tsd-kind-method">onError</a></li>
</ul>
</li>
</ul>
<h3 id="error-behaviour-1" class="tsd-anchor-link">Error behaviour<a href="#error-behaviour-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><code>GET</code> can return <code>null</code> → method returns <code>0</code>.</li>
<li>All values are safely coerced using <code>Number(...)</code>.</li>
<li>This method does <strong>not</strong> throw.</li>
</ul>
<h3 id="example-25" class="tsd-anchor-link">Example<a href="#example-25" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">n</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">getAttempts</span><span class="hl-1">(</span><span class="hl-2">&quot;1700000000000-0&quot;</span><span class="hl-1">);</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">n</span><span class="hl-1">); </span><span class="hl-9">// 0, 1, 2, 3...</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID whose retry counter should be retrieved.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">&gt;</span></h4><p>The current retry-attempt count (defaults to <code>0</code>).</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2655">PowerQueues.ts:2655</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="heartbeat"><code class="tsd-tag">Private</code><span>heartbeat</span><a href="#heartbeat" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="heartbeat-1"><span class="tsd-kind-call-signature">heartbeat</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> (<span class="tsd-signature-symbol">()</span> <span class="tsd-signature-symbol">=&gt;</span> <span class="tsd-signature-type">void</span>) <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">undefined</span><a href="#heartbeat-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Starts a <strong>periodic heartbeat loop</strong> for an idempotent task and returns a
function to stop it.</p>
<p>This method is used inside <a href="#idempotency" class="tsd-kind-method">idempotency</a> after the worker has
successfully acquired the idempotency lock (via <a href="#idempotencystart" class="tsd-kind-method">idempotencyStart</a>).
It repeatedly calls <a href="#sendheartbeat" class="tsd-kind-method">sendHeartbeat</a> to refresh the TTL of the lock
and start keys while the task is running.</p>
<blockquote>
<p>If <code>workerExecuteLockTimeoutMs &lt;= 0</code>, heartbeats are disabled and this
method returns <code>undefined</code>.</p>
</blockquote>
<h3 id="how-it-works-2" class="tsd-anchor-link">How it works<a href="#how-it-works-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>It calculates a heartbeat interval:</p>
<ul>
<li><code>workerHeartbeatTimeoutMs = max(1000, floor(max(5000, workerExecuteLockTimeoutMs) / 4))</code></li>
<li>So:
<ul>
<li>The interval is <strong>at least 1 second</strong>.</li>
<li>For larger <code>workerExecuteLockTimeoutMs</code>, heartbeats are sent roughly
every 1/4 of that value, but never less frequent than every 5s/4.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>It subscribes to the current abort signal (from <a href="#signal" class="tsd-kind-method">signal</a>):</p>
<ul>
<li>If the signal is aborted, it stops the heartbeat loop.</li>
</ul>
</li>
<li>
<p>It schedules a <code>tick</code> function with <code>setTimeout</code>:</p>
<ul>
<li>On each tick it calls <a href="#sendheartbeat" class="tsd-kind-method">(keys)</a>.</li>
<li>If the heartbeat succeeds:
<ul>
<li><code>hbFails</code> is reset to <code>0</code>.</li>
</ul>
</li>
<li>If the heartbeat fails or throws:
<ul>
<li><code>hbFails</code> is incremented.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Failure thresholds:</p>
<ul>
<li>If <strong>3 consecutive logical failures</strong> occur (<code>hbFails &gt;= 3</code> after a
successful call), an error <code>&quot;Heartbeat lost.&quot;</code> is thrown in order to
trigger the catch block and increment <code>hbFails</code> again.</li>
<li>In the <code>catch</code> block:
<ul>
<li><code>hbFails</code> is incremented again.</li>
<li>If <code>hbFails &gt;= 6</code>, the loop is <strong>stopped permanently</strong>:
<ul>
<li>No more heartbeats are sent.</li>
<li>The lock may eventually expire and be taken by another worker.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>After each tick (if still alive), the next tick is scheduled with the
same <code>workerHeartbeatTimeoutMs</code>. The timeout handle is <code>unref()</code>-ed so
it does not keep the Node.js process alive by itself.</p>
</li>
</ol>
<h3 id="returned-function" class="tsd-anchor-link">Returned function<a href="#returned-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If heartbeats are enabled, this method returns a <strong>stop function</strong>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">stopHeartbeat</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">heartbeat</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><br/><span class="hl-9">// later, when the job is done or the worker is shutting down:</span><br/><span class="hl-0">stopHeartbeat</span><span class="hl-1">?.();</span>
</code><button type="button">Copy</button></pre>

<p>Calling this function:</p>
<ul>
<li>Removes the abort listener from the signal,</li>
<li>Clears any pending heartbeat timeout,</li>
<li>Prevents further heartbeat attempts.</li>
</ul>
<p>The caller (e.g. <a href="#idempotency" class="tsd-kind-method">idempotency</a>) usually gets this function and calls
it in a <code>finally</code> block to guarantee cleanup:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">heartbeat</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">heartbeat</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><span class="hl-6">try</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-9">// run handler</span><br/><span class="hl-1">} </span><span class="hl-6">finally</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">heartbeat</span><span class="hl-1">?.();</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type external">IdempotencyKeys</span></span><div class="tsd-comment tsd-typography"><p>A set of idempotency keys produced by <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>. These keys
are passed to <a href="#sendheartbeat" class="tsd-kind-method">sendHeartbeat</a> to refresh their TTL regularly.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns (<span class="tsd-signature-symbol">()</span> <span class="tsd-signature-symbol">=&gt;</span> <span class="tsd-signature-type">void</span>) <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">undefined</span></h4><ul>
<li>A <strong>stop function</strong> that cancels the heartbeat loop and removes internal
listeners, or</li>
<li><code>undefined</code> if heartbeats are disabled (<code>workerExecuteLockTimeoutMs &lt;= 0</code>).</li>
</ul>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4582">PowerQueues.ts:4582</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="idempotency"><code class="tsd-tag">Private</code><span>idempotency</span><a href="#idempotency" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="idempotency-1"><span class="tsd-kind-call-signature">idempotency</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><br/>    <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-symbol">{</span> <span class="tsd-kind-property">contended</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">undefined</span><span class="tsd-signature-symbol">;</span> <span class="tsd-kind-property">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span> <span class="tsd-signature-symbol">}</span><br/>    <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-symbol">{</span> <span class="tsd-kind-property">contended</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">;</span> <span class="tsd-kind-property">id</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">undefined</span> <span class="tsd-signature-symbol">}</span><br/>    <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">undefined</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">&gt;</span><a href="#idempotency-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Ensures <strong>idempotent execution</strong> of a task for a given idempotency key.</p>
<p>This method is called internally from <a href="#executeprocess" class="tsd-kind-method">executeProcess</a> whenever a task
has a non-empty <code>key</code> (idempotency key). It coordinates multiple workers so
that <strong>only one worker actually executes</strong> the task logic for a given key,
while all other workers either:</p>
<ul>
<li><strong>return immediately</strong> if the task was already completed, or</li>
<li><strong>back off and retry later</strong> if another worker is currently processing it.</li>
</ul>
<h3 id="high-level-flow" class="tsd-anchor-link">High-level flow<a href="#high-level-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>Build Redis idempotency keys via <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>:
<ul>
<li><code>doneKey</code>  - marks that the task for this key has been fully processed.</li>
<li><code>lockKey</code>  - a short-lived lock that identifies the &quot;owner&quot; worker.</li>
<li><code>startKey</code> - indicates that processing has started and holds a TTL.</li>
</ul>
</li>
<li>Call <a href="#idempotencyallow" class="tsd-kind-method">idempotencyAllow</a> (Lua <code>IdempotencyAllow</code> script):
<ul>
<li>Returns <code>1</code> → <code>doneKey</code> exists -&gt; task already processed → <code>{ id }</code>.</li>
<li>Returns <code>0</code> → another worker is processing this key:
<ul>
<li>Read TTL of <code>startKey</code> (<code>PTTL</code>) and wait via <a href="#waitabortable" class="tsd-kind-method">waitAbortable</a>.</li>
<li>Return <code>{ contended: true }</code> so the caller can treat it as a soft conflict.</li>
</ul>
</li>
<li>Returns <code>2</code> → current worker is allowed to become the owner.</li>
</ul>
</li>
<li>If allowed, try to become the owner via <a href="#idempotencystart" class="tsd-kind-method">idempotencyStart</a>
(Lua <code>IdempotencyStart</code> script). If this fails, another worker won the race:
<ul>
<li>Return <code>{ contended: true }</code>.</li>
</ul>
</li>
<li>When the worker becomes the owner:
<ul>
<li>Start a <strong>heartbeat</strong> via <a href="#heartbeat" class="tsd-kind-method">heartbeat</a> which periodically extends
<code>lockKey</code> and <code>startKey</code> TTL using <a href="#sendheartbeat" class="tsd-kind-method">sendHeartbeat</a>. This protects
long-running jobs from being stolen by other workers while still alive.</li>
<li>Execute the user handler <a href="#onexecute" class="tsd-kind-method">onExecute</a> with the task data.</li>
<li>On success:
<ul>
<li>Mark completion through <a href="#idempotencydone" class="tsd-kind-method">idempotencyDone</a> (<code>doneKey</code> + TTL).</li>
<li>Call <a href="#success" class="tsd-kind-method">success</a> to update job status counters and hooks.</li>
<li>Return <code>{ id }</code>.</li>
</ul>
</li>
<li>On failure:
<ul>
<li>Increment attempts with <a href="#incrattempts" class="tsd-kind-method">incrAttempts</a>.</li>
<li>Call <a href="#attempt" class="tsd-kind-method">attempt</a> (retry hook) and <a href="#error" class="tsd-kind-method">error</a> (error hook).</li>
<li>If <code>attempt &gt;= workerMaxRetries</code>:
<ul>
<li>Push the task into a <strong>dead-letter queue</strong> <code>${stream}:dlq</code> with error info.</li>
<li>Clear attempts via <a href="#clearattempts" class="tsd-kind-method">clearAttempts</a>.</li>
<li>Release the idempotency lock via <a href="#idempotencyfree" class="tsd-kind-method">idempotencyFree</a>.</li>
<li>Return <code>{ id }</code> (task is considered finished, but failed).</li>
</ul>
</li>
<li>If <code>attempt &lt; workerMaxRetries</code>:
<ul>
<li>Only release the lock via <a href="#idempotencyfree" class="tsd-kind-method">idempotencyFree</a>.</li>
<li>The task will be retried later by the queue logic.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Finally, stop the heartbeat so that no more TTL refreshes are sent.</li>
</ol>
<h3 id="when-to-use-1" class="tsd-anchor-link">When to use<a href="#when-to-use-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>This method is not meant to be called directly in user code.</li>
<li>Instead, pass an <code>idemKey</code> in your task payload and let the queue internals
route execution here. For the same <code>idemKey</code>, only one successful execution
is allowed; all other workers will either return immediately or back off.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID of the task.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Parsed task payload (usually the value previously encoded in <code>payload</code>).</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Unix timestamp (ms) when the task was created.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Batch/job identifier used for grouping metrics and status keys.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p><strong>Idempotency key</strong>. All tasks sharing this key are treated as the
same logical unit of work (e.g. &quot;sendEmail:user:123&quot;).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><br/>    <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-symbol">{</span> <span class="tsd-kind-property">contended</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">undefined</span><span class="tsd-signature-symbol">;</span> <span class="tsd-kind-property">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span> <span class="tsd-signature-symbol">}</span><br/>    <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-symbol">{</span> <span class="tsd-kind-property">contended</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">;</span> <span class="tsd-kind-property">id</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">undefined</span> <span class="tsd-signature-symbol">}</span><br/>    <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">undefined</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise resolving to:</p>
<ul>
<li><code>{ id }</code> when the task is considered <strong>done</strong> for this worker (either because
it executed successfully, was already done, or permanently failed and moved to DLQ).</li>
<li><code>{ contended: true }</code> when another worker is currently processing the same key
and this worker should treat the task as a soft conflict / backoff.</li>
<li><code>{}</code> in rare internal fall-through cases (should normally not happen).</li>
</ul>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3578">PowerQueues.ts:3578</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="idempotencyallow"><code class="tsd-tag">Private</code><span>idempotency<wbr/>Allow</span><a href="#idempotencyallow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="idempotencyallow-1"><span class="tsd-kind-call-signature">idempotencyAllow</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">0</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">1</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">2</span><span class="tsd-signature-symbol">&gt;</span><a href="#idempotencyallow-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Runs the <strong>first step</strong> of the idempotency workflow and decides what this
worker is allowed to do for a given idempotency key.</p>
<p>Internally this calls the Lua script <a href="../variables/IdempotencyAllow.html" class="tsd-kind-variable">IdempotencyAllow</a> via
<a href="#runscript" class="tsd-kind-method">runScript</a>. The script checks three main things:</p>
<ol>
<li>
<p><strong>Is the task already done?</strong></p>
<ul>
<li>If <code>doneKey</code> exists, the script returns <code>1</code>.
→ This means some worker has <strong>already finished</strong> the work for this key.
→ The caller should treat the task as completed and skip execution.</li>
</ul>
</li>
<li>
<p><strong>Can this worker acquire the lock?</strong></p>
<ul>
<li>If <code>doneKey</code> does not exist, the script tries to set <code>lockKey</code> with a TTL
using <code>SET lockKey token NX PX ttlMs</code>.</li>
<li>If the lock is successfully set, the script may also set <code>startKey</code> with
the same TTL (to mark the beginning of execution) and returns <code>2</code>.
→ This means <strong>this worker becomes the owner</strong> and is allowed to execute.</li>
</ul>
</li>
<li>
<p><strong>Is another worker already processing this key?</strong></p>
<ul>
<li>If <code>lockKey</code> already exists (owned by another worker), the script
returns <code>0</code>.
→ This means someone else is either executing or has recently started
handling the same work unit, so this worker should <strong>back off</strong>.</li>
</ul>
</li>
</ol>
<h3 id="return-codes" class="tsd-anchor-link">Return codes<a href="#return-codes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The result is normalized to a small numeric union:</p>
<ul>
<li>
<p><code>1</code> - Task is <strong>already completed</strong> (the <code>doneKey</code> exists).</p>
<ul>
<li>The caller (see <a href="#idempotency" class="tsd-kind-method">idempotency</a>) should return <code>{ id }</code> immediately
without executing the user handler again.</li>
</ul>
</li>
<li>
<p><code>2</code> - This worker <strong>successfully acquired</strong> the idempotency lock.</p>
<ul>
<li>The caller should continue with <a href="#idempotencystart" class="tsd-kind-method">idempotencyStart</a>, start heartbeat,
and execute the actual business logic.</li>
</ul>
</li>
<li>
<p><code>0</code> - Another worker is currently processing (or recently processed) this key.</p>
<ul>
<li>The caller should typically:
<ul>
<li>Read <code>PTTL</code> of <code>startKey</code>,</li>
<li>Wait a small amount via <a href="#waitabortable" class="tsd-kind-method">waitAbortable</a>,</li>
<li>Return <code>{ contended: true }</code> so the queue can treat this as a soft conflict.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="example-usage-simplified" class="tsd-anchor-link">Example usage (simplified)<a href="#example-usage-simplified" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">keys</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyKeys</span><span class="hl-1">(</span><span class="hl-5">idemKey</span><span class="hl-1">);</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">allow</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyAllow</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">allow</span><span class="hl-1"> === </span><span class="hl-7">1</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-9">// Work already done → nothing to do</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">id</span><span class="hl-1"> };</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">allow</span><span class="hl-1"> === </span><span class="hl-7">0</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-9">// Another worker is processing → back off</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">waitAbortable</span><span class="hl-1">(</span><span class="hl-5">ttl</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">contended:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1"> };</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-9">// allow === 2 → current worker can proceed as owner</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type external">IdempotencyKeys</span></span><div class="tsd-comment tsd-typography"><p>A precomputed IdempotencyKeys object created by <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>.
It contains the <code>doneKey</code>, <code>lockKey</code>, <code>startKey</code>, and <code>token</code> that the Lua
script needs to make a decision.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">0</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">1</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">2</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise resolving to:</p>
<ul>
<li><code>1</code> if the job for this key is <strong>already fully processed</strong>.</li>
<li><code>2</code> if this worker <strong>acquired the lock</strong> and is allowed to process.</li>
<li><code>0</code> if <strong>another worker owns the lock</strong> and this worker should back off.</li>
</ul>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3783">PowerQueues.ts:3783</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="idempotencydone"><code class="tsd-tag">Private</code><span>idempotency<wbr/>Done</span><a href="#idempotencydone" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="idempotencydone-1"><span class="tsd-kind-call-signature">idempotencyDone</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#idempotencydone-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Marks an idempotent operation as <strong>successfully completed</strong> and clears
any related lock keys in Redis.</p>
<p>This is called <strong>after</strong> the user handler (<code>onExecute</code>) has finished
without throwing, as part of the idempotency workflow in <a href="#idempotency" class="tsd-kind-method">idempotency</a>.</p>
<p>Internally it executes the Lua script <a href="../variables/IdempotencyDone.html" class="tsd-kind-variable">IdempotencyDone</a> via
<a href="#runscript" class="tsd-kind-method">runScript</a>. The script performs three main actions:</p>
<ol>
<li>
<p><strong>Mark as done</strong></p>
<ul>
<li>Sets <code>doneKey</code> to <code>1</code> (no special meaning for the value, the presence
of the key is what matters).</li>
<li>Applies a TTL (in <strong>seconds</strong>) based on <code>workerCacheTaskTimeoutMs</code>:
<ul>
<li>If <code>workerCacheTaskTimeoutMs &gt; 0</code>, it calls <code>EXPIRE doneKey ttlSec</code>.</li>
<li>This creates a short-lived cache entry used by <a href="#idempotencyallow" class="tsd-kind-method">idempotencyAllow</a>
to immediately short-circuit repeated tasks with the same idempotency key.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Clear lock (if still owned by this worker)</strong></p>
<ul>
<li>Reads <code>lockKey</code> and compares it with the <code>token</code> of the current worker.</li>
<li>If the value matches, it deletes <code>lockKey</code>.</li>
</ul>
</li>
<li>
<p><strong>Clear start marker</strong></p>
<ul>
<li>If the lock is still owned by the current worker and <code>startKey</code> is defined,
it deletes <code>startKey</code> as well.</li>
</ul>
</li>
</ol>
<p>Together, these steps:</p>
<ul>
<li>Tell other workers that the operation is <strong>finished</strong> (<code>doneKey</code> exists),</li>
<li>Release the lock so no one else treats this worker as the active owner,</li>
<li>Clean up temporary keys used for coordination and waiting.</li>
</ul>
<blockquote>
<p>Note:
The TTL value passed to the script is <code>workerCacheTaskTimeoutMs</code>, but the Lua
script interprets it as <strong>seconds</strong> (via <code>EXPIRE</code>). Make sure this property
is configured accordingly at the class level.</p>
</blockquote>
<h3 id="typical-call-site-inside-idempotency" class="tsd-anchor-link">Typical call site (inside <a href="#idempotency" class="tsd-kind-method">idempotency</a>)<a href="#typical-call-site-inside-idempotency" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">keys</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyKeys</span><span class="hl-1">(</span><span class="hl-5">idemKey</span><span class="hl-1">);</span><br/><br/><span class="hl-9">// ... run onExecute without error ...</span><br/><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyDone</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">success</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type external">IdempotencyKeys</span></span><div class="tsd-comment tsd-typography"><p>A set of Redis key names and token generated by <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>.
Includes <code>doneKey</code>, <code>lockKey</code>, and <code>startKey</code> which the Lua script uses
to mark completion and release the idempotency lock.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3914">PowerQueues.ts:3914</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="idempotencyfree"><code class="tsd-tag">Private</code><span>idempotency<wbr/>Free</span><a href="#idempotencyfree" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="idempotencyfree-1"><span class="tsd-kind-call-signature">idempotencyFree</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#idempotencyfree-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Releases the <strong>idempotency lock</strong> for a given key without marking
the operation as completed.</p>
<p>This is used when the current worker <strong>should stop owning</strong> the lock,
but the task is <strong>not considered done</strong> yet. Typical cases:</p>
<ul>
<li>The handler (<code>onExecute</code>) failed but there are retries left.</li>
<li>An error happened while handling an idempotent task and we want to give
other workers a chance to pick it up later.</li>
</ul>
<p>Internally it runs the Lua script <a href="../variables/IdempotencyFree.html" class="tsd-kind-variable">IdempotencyFree</a> via <a href="#runscript" class="tsd-kind-method">runScript</a>.</p>
<h3 id="what-the-lua-script-does" class="tsd-anchor-link">What the Lua script does<a href="#what-the-lua-script-does" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The script receives:</p>
<ul>
<li><code>lockKey</code>, <code>startKey</code> as <code>KEYS</code></li>
<li><code>token</code> as <code>ARGV[1]</code></li>
</ul>
<p>Steps:</p>
<ol>
<li>Reads <code>lockKey</code> and checks if its value equals the provided <code>token</code>.
<ul>
<li>If it does <strong>not</strong> match, it returns <code>0</code> and does nothing
(another worker owns the lock or it expired).</li>
</ul>
</li>
<li>If the token matches:
<ul>
<li>Deletes <code>lockKey</code>.</li>
<li>Deletes <code>startKey</code> (if it is provided / non-empty).</li>
<li>Returns <code>1</code> to indicate that the lock was successfully released.</li>
</ul>
</li>
</ol>
<p>This ensures that <strong>only the worker that owns the lock</strong> (same <code>token</code>)
can release it, preventing other workers from accidentally removing locks
they do not control.</p>
<h3 id="difference-from-idempotencydone" class="tsd-anchor-link">Difference from <a href="#idempotencydone" class="tsd-kind-method">idempotencyDone</a><a href="#difference-from-idempotencydone" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><code>idempotencyDone</code>:
<ul>
<li>Sets <code>doneKey</code> to mark the operation as <strong>fully completed</strong>.</li>
<li>Clears the lock and start keys.</li>
</ul>
</li>
<li><code>idempotencyFree</code>:
<ul>
<li>Only removes the lock/start keys if owned by this worker.</li>
<li>Does <strong>not</strong> set <code>doneKey</code>, so the operation can still be retried later.</li>
</ul>
</li>
</ul>
<h3 id="typical-usage-inside-idempotency" class="tsd-anchor-link">Typical usage (inside <a href="#idempotency" class="tsd-kind-method">idempotency</a>)<a href="#typical-usage-inside-idempotency" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-9">// inside the catch branch for idempotent tasks</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">attempt</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">incrAttempts</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">);</span><br/><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">attempt</span><span class="hl-1"> &gt;= </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">workerMaxRetries</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-9">// move to DLQ, clear attempts and free lock permanently</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyFree</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">id</span><span class="hl-1"> };</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-9">// still have retries → free lock so another worker can try later</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyFree</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">contended:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1"> };</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type external">IdempotencyKeys</span></span><div class="tsd-comment tsd-typography"><p>A set of Redis key names and token created by <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>.
Only if <code>keys.token</code> matches the current <code>lockKey</code> value will the lock
and its <code>startKey</code> marker be removed.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3979">PowerQueues.ts:3979</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="idempotencykeys"><code class="tsd-tag">Private</code><span>idempotency<wbr/>Keys</span><a href="#idempotencykeys" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="idempotencykeys-1"><span class="tsd-kind-call-signature">idempotencyKeys</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><a href="#idempotencykeys-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Builds a <strong>stable set of Redis keys</strong> used to coordinate idempotent execution
for a single logical operation (idempotency key).</p>
<p>This helper does not touch Redis itself. It only <strong>generates key names</strong> and
a unique token that are later used by the idempotency Lua scripts:</p>
<ul>
<li><a href="../variables/IdempotencyAllow.html" class="tsd-kind-variable">IdempotencyAllow</a> (via <a href="#idempotencyallow" class="tsd-kind-method">idempotencyAllow</a>)</li>
<li><a href="../variables/IdempotencyStart.html" class="tsd-kind-variable">IdempotencyStart</a> (via <a href="#idempotencystart" class="tsd-kind-method">idempotencyStart</a>)</li>
<li><a href="../variables/IdempotencyDone.html" class="tsd-kind-variable">IdempotencyDone</a> (via <a href="#idempotencydone" class="tsd-kind-method">idempotencyDone</a>)</li>
<li><a href="../variables/IdempotencyFree.html" class="tsd-kind-variable">IdempotencyFree</a> (via <a href="#idempotencyfree" class="tsd-kind-method">idempotencyFree</a>)</li>
</ul>
<h3 id="what-it-generates" class="tsd-anchor-link">What it generates<a href="#what-it-generates" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For a given idempotency key and the current queue (<code>this.stream</code>), it returns:</p>
<ul>
<li><code>prefix</code>   - common prefix for all idempotency keys of this stream:
<code>q:{safeStream}:</code></li>
<li><code>doneKey</code>  - marks that the operation for this key has been <strong>fully processed</strong>:
<code>q:{safeStream}:done:{safeKey}</code></li>
<li><code>lockKey</code>  - short-lived <strong>lock owner marker</strong> used to decide which worker
is allowed to execute the task:
<code>q:{safeStream}:lock:{safeKey}</code></li>
<li><code>startKey</code> - indicates that processing has <strong>started</strong>, also used to store
TTL for waiting workers:
<code>q:{safeStream}:start:{safeKey}</code></li>
<li><code>token</code>    - unique random token identifying the current worker instance.
It is stored in <code>lockKey</code> and passed to scripts so that only the owner
can refresh or release the lock.</li>
</ul>
<p>Both <code>this.stream</code> and the provided <code>key</code> are <strong>sanitized</strong>:
any character that is not a word, colon, or dash (<code>[^\w:\-]</code>) is replaced
with an underscore. This makes keys safe and predictable even if the original
names contain spaces or special characters.</p>
<h3 id="example-key-layout" class="tsd-anchor-link">Example key layout<a href="#example-key-layout" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>For:</p>
<ul>
<li><code>this.stream = 'orders:new'</code></li>
<li><code>key = 'user:42#email'</code></li>
</ul>
<p>The resulting keys will look like:</p>
<ul>
<li><code>prefix</code>   → <code>q:orders:new:</code></li>
<li><code>doneKey</code>  → <code>q:orders:new:done:user:42_email</code></li>
<li><code>lockKey</code>  → <code>q:orders:new:lock:user:42_email</code></li>
<li><code>startKey</code> → <code>q:orders:new:start:user:42_email</code></li>
<li><code>token</code>    → something like <code>host:pid:kq3m9f...</code> (unique per call)</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key that represents the logical operation
(for example: <code>&quot;sendEmail:user:123&quot;</code>). Tasks that share the same idempotency key
are treated as the <strong>same work unit</strong>, even if they arrive multiple times.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type external">IdempotencyKeys</span></h4><p>An IdempotencyKeys object containing:
<code>prefix</code>, <code>doneKey</code>, <code>lockKey</code>, <code>startKey</code>, and a unique <code>token</code>
used by the idempotency workflow.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3694">PowerQueues.ts:3694</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="idempotencystart"><code class="tsd-tag">Private</code><span>idempotency<wbr/>Start</span><a href="#idempotencystart" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="idempotencystart-1"><span class="tsd-kind-call-signature">idempotencyStart</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">&gt;</span><a href="#idempotencystart-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Performs the <strong>second step</strong> of the idempotency handshake and confirms
that this worker still owns the lock before running the actual job logic.</p>
<p>Internally this calls the Lua script <a href="../variables/IdempotencyStart.html" class="tsd-kind-variable">IdempotencyStart</a> via
<a href="#runscript" class="tsd-kind-method">runScript</a>. It is used right after <a href="#idempotencyallow" class="tsd-kind-method">idempotencyAllow</a> returns <code>2</code>
(meaning &quot;you are allowed to become the owner&quot;).</p>
<h3 id="what-the-script-does" class="tsd-anchor-link">What the script does<a href="#what-the-script-does" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>IdempotencyStart</code> Lua script receives:</p>
<ul>
<li><code>lockKey</code> and <code>startKey</code> as <code>KEYS</code></li>
<li><code>token</code> and <code>ttlMs</code> as <code>ARGV</code></li>
</ul>
<p>And then:</p>
<ol>
<li>Reads <code>lockKey</code> value and checks if it is <strong>equal to</strong> <code>token</code>.
<ul>
<li>If this check fails, it returns <code>0</code>.
→ Some other worker may have taken over or the lock expired.</li>
</ul>
</li>
<li>If the token matches, it:
<ul>
<li>Sets <code>startKey</code> to <code>1</code> with a TTL (<code>PX ttlMs</code>) if <code>ttlMs &gt; 0</code>,
otherwise sets it without expiry.</li>
<li>Refreshes the TTL of <code>lockKey</code> (using <code>PEXPIRE</code>) if <code>ttlMs &gt; 0</code>.</li>
<li>Returns <code>1</code> to indicate that this worker is now the <strong>active owner</strong>.</li>
</ul>
</li>
</ol>
<h3 id="why-this-step-exists" class="tsd-anchor-link">Why this step exists<a href="#why-this-step-exists" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>This function is a safety check between:</p>
<ul>
<li>Step 1: <a href="#idempotencyallow" class="tsd-kind-method">idempotencyAllow</a> → tries to create <code>lockKey</code> and decides if
the worker may proceed (<code>2</code>), skip (<code>1</code>), or back off (<code>0</code>).</li>
<li>Step 2: <a href="#idempotencystart" class="tsd-kind-method">idempotencyStart</a> → verifies that the lock is <strong>still valid</strong>
and owned by this worker's <code>token</code> before doing any real work.</li>
</ul>
<p>It protects against edge cases where:</p>
<ul>
<li>The lock was granted but expired very quickly.</li>
<li>Another worker managed to overwrite the lock in between operations.</li>
</ul>
<p>Only if this function returns <code>true</code> will the caller:</p>
<ul>
<li>Start the heartbeat via <a href="#heartbeat" class="tsd-kind-method">heartbeat</a>,</li>
<li>Execute the user handler <a href="#onexecute" class="tsd-kind-method">onExecute</a>,</li>
<li>And later mark completion via <a href="#idempotencydone" class="tsd-kind-method">idempotencyDone</a>.</li>
</ul>
<h3 id="typical-usage-inside-idempotency-1" class="tsd-anchor-link">Typical usage (inside <a href="#idempotency" class="tsd-kind-method">idempotency</a>)<a href="#typical-usage-inside-idempotency-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">keys</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyKeys</span><span class="hl-1">(</span><span class="hl-5">idemKey</span><span class="hl-1">);</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">allow</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyAllow</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">allow</span><span class="hl-1"> === </span><span class="hl-7">2</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">started</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">idempotencyStart</span><span class="hl-1">(</span><span class="hl-5">keys</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-5">started</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-9">// Lost the race - another worker owns the lock now</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">contended:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1"> };</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// Now safe to run the handler and heartbeat</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type external">IdempotencyKeys</span></span><div class="tsd-comment tsd-typography"><p>A precomputed IdempotencyKeys object (from <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>)
containing <code>lockKey</code>, <code>startKey</code>, and <code>token</code>. The token must match the value
stored in <code>lockKey</code> for this method to succeed.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">&gt;</span></h4><ul>
<li><code>true</code> if this worker successfully confirmed ownership and refreshed TTLs.</li>
<li><code>false</code> if the lock is no longer owned by this worker (or does not match its token),
meaning another worker should handle this idempotency key.</li>
</ul>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L3856">PowerQueues.ts:3856</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="incrattempts"><code class="tsd-tag">Private</code><span>incr<wbr/>Attempts</span><a href="#incrattempts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="incrattempts-1"><span class="tsd-kind-call-signature">incrAttempts</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">&gt;</span><a href="#incrattempts-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Increments the <strong>retry-attempt counter</strong> for a specific task and returns
the updated value.</p>
<p>This method is used inside the worker's execution flow to track how many
times a task has failed and been retried. Once a task exceeds
<code>workerMaxRetries</code>, it is moved to the DLQ (dead-letter queue).</p>
<h3 id="what-this-method-does-2" class="tsd-anchor-link">What this method does<a href="#what-this-method-does-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>Builds the counter key using <a href="#attemptskey" class="tsd-kind-method">attemptsKey</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">key</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">attemptsKey</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</li>
<li>
<p>Calls <code>INCR</code> on that Redis key:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">attempts</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">redis</span><span class="hl-1">.</span><span class="hl-0">incr</span><span class="hl-1">(</span><span class="hl-5">key</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This yields:</p>
<ul>
<li><code>1</code> for the first failure,</li>
<li><code>2</code> for the second,</li>
<li>...and so on.</li>
</ul>
</li>
<li>
<p>Sets a TTL (in milliseconds) on the counter via <code>PEXPIRE</code>:</p>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">redis</span><span class="hl-1">.</span><span class="hl-0">pexpire</span><span class="hl-1">(</span><span class="hl-5">key</span><span class="hl-1">, </span><span class="hl-5">workerClearAttemptsTimeoutMs</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This ensures attempt counters <strong>automatically expire</strong> and do not
accumulate forever in Redis.</p>
<p>The default is:</p>
<ul>
<li><code>workerClearAttemptsTimeoutMs = 86400000</code> (24 hours)</li>
</ul>
</li>
<li>
<p>Returns the incremented value.</p>
</li>
</ol>
<h3 id="error-behaviour-2" class="tsd-anchor-link">Error behaviour<a href="#error-behaviour-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>If Redis throws an error (rare), the error is swallowed and the method
returns <code>0</code> (meaning &quot;no attempt information available&quot;).</li>
<li>This prevents a Redis hiccup from crashing the worker.</li>
</ul>
<h3 id="when-it-is-used-2" class="tsd-anchor-link">When it is used<a href="#when-it-is-used-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Each time <a href="#onexecute" class="tsd-kind-method">onExecute</a> throws an error.</li>
<li>Each time idempotent task processing fails inside <a href="#idempotency" class="tsd-kind-method">idempotency</a>.</li>
<li>Used together with:
<ul>
<li><a href="#getattempts" class="tsd-kind-method">getAttempts</a> - to check the number before executing;</li>
<li><a href="#clearattempts" class="tsd-kind-method">clearAttempts</a> - to reset after DLQ or success.</li>
</ul>
</li>
</ul>
<h3 id="example-26" class="tsd-anchor-link">Example<a href="#example-26" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">attempt</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">incrAttempts</span><span class="hl-1">(</span><span class="hl-2">&quot;1700000000000-0&quot;</span><span class="hl-1">);</span><br/><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-5">attempt</span><span class="hl-1">); </span><span class="hl-9">// 1, 2, 3...</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID whose retry attempts must be incremented.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">&gt;</span></h4><p>The updated attempt count, or <code>0</code> if something went wrong.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2586">PowerQueues.ts:2586</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="keyslength"><code class="tsd-tag">Private</code><span>keys<wbr/>Length</span><a href="#keyslength" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="keyslength-1"><span class="tsd-kind-call-signature">keysLength</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">task</span><span class="tsd-signature-symbol">:</span> <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><a href="#keyslength-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Calculates how many <strong>tokens</strong> (strings) a task will contribute to a Redis
<code>XADD</code> command when encoded by <a href="#payloadbatch" class="tsd-kind-method">payloadBatch</a>.</p>
<p>A <em>token</em> is any string argument that will eventually be sent to Redis:</p>
<ul>
<li>the entry ID,</li>
<li>the number of field/value pairs,</li>
<li>each field name,</li>
<li>each field value.</li>
</ul>
<p>This method provides a rough but safe estimate used by <a href="#buildbatches" class="tsd-kind-method">buildBatches</a>
to ensure that a batch does not exceed <a href="#addingbatchkeyslimit" class="tsd-kind-property">addingBatchKeysLimit</a>.</p>
<h3 id="how-the-count-is-computed" class="tsd-anchor-link">How the count is computed<a href="#how-the-count-is-computed" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The structure of every encoded task in <code>payloadBatch</code> is:</p>
<pre><code><span class="hl-1">[ </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">num_pairs</span><span class="hl-1">, </span><span class="hl-5">field1</span><span class="hl-1">, </span><span class="hl-5">value1</span><span class="hl-1">, </span><span class="hl-5">field2</span><span class="hl-1">, </span><span class="hl-5">value2</span><span class="hl-1">, ... ]</span><br/><span class="hl-1">  ↑    ↑</span><br/><span class="hl-1">  │    └── </span><span class="hl-5">token</span><span class="hl-1"> #</span><span class="hl-7">2</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1"> </span><span class="hl-3">of</span><span class="hl-1"> </span><span class="hl-0">pairs</span><span class="hl-1"> (</span><span class="hl-6">as</span><span class="hl-1"> </span><span class="hl-8">string</span><span class="hl-1">)</span><br/><span class="hl-1">  └── </span><span class="hl-5">token</span><span class="hl-1"> #</span><span class="hl-7">1</span><span class="hl-1">: </span><span class="hl-5">entry</span><span class="hl-1"> </span><span class="hl-4">ID</span>
</code><button>Copy</button></pre>

<p>After these two tokens, each <strong>field/value</strong> pair contributes exactly <strong>2 tokens</strong>.</p>
<p>So the final count is:</p>
<pre><code><span class="hl-7">2</span><span class="hl-1"> + (</span><span class="hl-5">field_count</span><span class="hl-1"> × </span><span class="hl-7">2</span><span class="hl-1">)</span>
</code><button>Copy</button></pre>

<p>Where:</p>
<ul>
<li>The first <code>2</code> are: <code>id</code> + <code>num_pairs</code></li>
<li>For object payloads, <code>field_count</code> is the number of keys in the payload object.</li>
<li>For flat payloads, <code>field_count</code> is <code>flat.length / 2</code>.</li>
</ul>
<h3 id="what-this-method-inspects" class="tsd-anchor-link">What this method inspects<a href="#what-this-method-inspects" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>It checks the task in the following order:</p>
<ol>
<li>
<p><strong>Flat payload form</strong> (<code>task.flat</code> exists and is non-empty):</p>
<ul>
<li><code>flat.length</code> already contains <em>both</em> fields and values.</li>
<li>Field count = <code>flat.length</code>.</li>
<li>But since each logical pair is 2 elements, the token count becomes:<pre><code class="ts"><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">2</span><span class="hl-1"> + </span><span class="hl-5">task</span><span class="hl-1">.</span><span class="hl-5">flat</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</li>
</ul>
</li>
<li>
<p><strong>Object payload form</strong> (<code>task.payload</code> is a plain object):</p>
<ul>
<li>Field count = number of object keys.</li>
<li>Token count = <code>2 + Object.keys(payload).length * 2</code></li>
</ul>
</li>
<li>
<p><strong>Fallback</strong> - rarely used:</p>
<ul>
<li>If neither <code>flat</code> nor valid <code>payload</code> exists, fall back to:<pre><code class="ts"><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">2</span><span class="hl-1"> + </span><span class="hl-5">Object</span><span class="hl-1">.</span><span class="hl-0">keys</span><span class="hl-1">(</span><span class="hl-5">task</span><span class="hl-1"> </span><span class="hl-6">as</span><span class="hl-1"> </span><span class="hl-8">any</span><span class="hl-1">).</span><span class="hl-5">length</span><span class="hl-1"> * </span><span class="hl-7">2</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</li>
<li>This is mainly defensive code and should rarely trigger.</li>
</ul>
</li>
</ol>
<h3 id="why-this-matters-1" class="tsd-anchor-link">Why this matters<a href="#why-this-matters-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>keysLength</code> is used internally by <a href="#buildbatches" class="tsd-kind-method">buildBatches</a> to ensure that:</p>
<ul>
<li>one batch will never send too many tokens to Redis at once,</li>
<li>bulk operations remain performant and safe,</li>
<li>we avoid hitting the Redis protocol argument limits or lua stack limits.</li>
</ul>
<p>Because each task has a different payload size, this dynamic calculation
helps build balanced batches.</p>
<h3 id="example-27" class="tsd-anchor-link">Example<a href="#example-27" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">task</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-5">payload:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">to:</span><span class="hl-1"> </span><span class="hl-2">&#39;user@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">subject:</span><span class="hl-1"> </span><span class="hl-2">&#39;Hello&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">createdAt:</span><span class="hl-1"> </span><span class="hl-7">1700000000000</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">job:</span><span class="hl-1"> </span><span class="hl-2">&#39;abc123&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-9">// Object payload has 4 fields → 4 × 2 = 8 tokens</span><br/><span class="hl-9">// Plus 2 header tokens → total = 10</span><br/><span class="hl-0">keysLength</span><span class="hl-1">(</span><span class="hl-5">task</span><span class="hl-1">) === </span><span class="hl-7">10</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">task</span>: <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a></span><div class="tsd-comment tsd-typography"><p>A normalized task from <a href="#buildbatches" class="tsd-kind-method">buildBatches</a>. Can use either
<code>payload</code> (object form) or <code>flat</code> (array form).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">number</span></h4><p>The total number of string tokens this task will produce during encoding.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2465">PowerQueues.ts:2465</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="loadscript"><code class="tsd-tag">Private</code><span>load<wbr/>Script</span><a href="#loadscript" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="loadscript-1"><span class="tsd-kind-call-signature">loadScript</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">code</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">&gt;</span><a href="#loadscript-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Loads a <strong>single Lua script</strong> into Redis using <code>SCRIPT LOAD</code> with small
built-in retry logic, and returns its SHA1 hash.</p>
<p>This is a low-level helper used by <code>loadScripts()</code>:</p>
<ul>
<li>It sends the raw Lua <code>code</code> to Redis.</li>
<li>Redis compiles and stores the script.</li>
<li>Redis returns a SHA1 hash string.</li>
<li>That SHA is later used with <code>EVALSHA</code> for fast execution.</li>
</ul>
<p>Retry behaviour:</p>
<ul>
<li>The method will try up to <strong>3 times</strong>:
<ol>
<li>First attempt.</li>
<li>If it fails, waits a short random delay (10-50 ms) and tries again.</li>
<li>If it fails again, waits another short random delay and tries a third time.</li>
</ol>
</li>
<li>If the <strong>3rd attempt also fails</strong>, the error is rethrown.</li>
</ul>
<p>This makes script loading more robust against:</p>
<ul>
<li>short connectivity glitches,</li>
<li>Redis restarts,</li>
<li>slow network during startup.</li>
</ul>
<p>Important:</p>
<ul>
<li><code>this.redis</code> must support the <code>script('LOAD', code)</code> command
(ioredis compatible interface).</li>
<li>This method <strong>does not</strong> store the SHA anywhere by itself:
<ul>
<li>it just returns the string,</li>
<li>caller (e.g. <code>loadScripts()</code> / <code>saveScript()</code>) is responsible for
caching the SHA in <code>this.scripts[name].codeReady</code>.</li>
</ul>
</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">code</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Raw Lua script source to load into Redis.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">&gt;</span></h4><p>Promise that resolves to the SHA1 hash string returned by Redis.</p>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-throws"><h4 class="tsd-anchor-link" id="throws">Throws<a href="#throws" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Error if all 3 attempts to load the script fail.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-28">Example<a href="#example-28" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Typical usage (simplified):</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">sha</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">loadScript</span><span class="hl-1">(</span><span class="hl-5">XAddBulk</span><span class="hl-1">);</span><br/><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">scripts</span><span class="hl-1">[</span><span class="hl-2">&#39;XAddBulk&#39;</span><span class="hl-1">] = { </span><span class="hl-5">codeBody:</span><span class="hl-1"> </span><span class="hl-5">XAddBulk</span><span class="hl-1">, </span><span class="hl-5">codeReady:</span><span class="hl-1"> </span><span class="hl-5">sha</span><span class="hl-1"> };</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1828">PowerQueues.ts:1828</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="loadscripts"><span>load<wbr/>Scripts</span><a href="#loadscripts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="loadscripts-1"><span class="tsd-kind-call-signature">loadScripts</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">full</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#loadscripts-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Preloads Lua scripts into Redis and caches their SHA1 hashes for later use.</p>
<p>This method should be called <strong>before you start using the queue</strong>, usually
during application startup or worker initialization.</p>
<p>Behaviour:</p>
<ul>
<li>Converts each script name + body into an internal <code>SavedScript</code> entry
via <code>saveScript(name, code)</code>.</li>
<li>Sends the script body to Redis using <code>SCRIPT LOAD</code> inside <code>loadScript(...)</code>.</li>
<li>Stores the returned SHA1 hash in <code>scripts[name].codeReady</code>.</li>
<li>Later, all queue operations call scripts by SHA using <code>EVALSHA</code>, which is
faster and more efficient.</li>
</ul>
<p>Scripts loaded:</p>
<ul>
<li>
<p>When <code>full === false</code> (default):</p>
<ul>
<li>Loads only:
<ul>
<li><code>&quot;XAddBulk&quot;</code> - high-throughput bulk <code>XADD</code> with trimming options (<code>MAXLEN</code>, <code>MINID</code>, etc.).</li>
</ul>
</li>
<li>This is enough if you only use <code>addTasks()</code> as a <strong>producer</strong> and do not
run workers in this process.</li>
</ul>
</li>
<li>
<p>When <code>full === true</code>:</p>
<ul>
<li>Loads all queue-related scripts:
<ul>
<li><code>&quot;XAddBulk&quot;</code> - bulk enqueue of tasks to a stream.</li>
<li><code>&quot;Approve&quot;</code> - ACK + optional delete logic for processed entries.</li>
<li><code>&quot;IdempotencyAllow&quot;</code> - checks if a task with the same idempotency key
can start, based on done/lock/start keys.</li>
<li><code>&quot;IdempotencyStart&quot;</code> - marks a task as started and refreshes lock TTL.</li>
<li><code>&quot;IdempotencyDone&quot;</code> - marks a task as done and clears idempotency lock.</li>
<li><code>&quot;IdempotencyFree&quot;</code> - releases idempotency lock without marking as done.</li>
<li><code>&quot;SelectStuck&quot;</code> - finds and claims &quot;stuck&quot; tasks using <code>XAUTOCLAIM</code>
with a time budget and fallback to <code>XREADGROUP</code>.</li>
</ul>
</li>
<li>Use this in <strong>worker processes</strong> that execute tasks.</li>
</ul>
</li>
</ul>
<p>Idempotency and safety:</p>
<ul>
<li>Safe to call multiple times: scripts are cached in <code>this.scripts</code> and Redis
will return the same SHA for identical script bodies.</li>
<li>If Redis is temporarily unavailable, <code>loadScript()</code> retries a few times
before throwing.</li>
</ul>
<p>Requirements:</p>
<ul>
<li><code>this.redis</code> must be a connected Redis client that supports:
<ul>
<li><code>SCRIPT LOAD</code></li>
<li><code>EVALSHA</code></li>
</ul>
</li>
<li>Call this method <strong>before</strong> you start calling operations that use scripts:
<ul>
<li><code>addTasks()</code> → <code>XAddBulk</code></li>
<li>worker internals → <code>Approve</code>, <code>Idempotency*</code>, <code>SelectStuck</code></li>
</ul>
</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">full</span>: <span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol"> = false</span></span><div class="tsd-comment tsd-typography"><p>If <code>true</code>, loads <strong>all</strong> Lua scripts used by the queue
(producer + worker). If <code>false</code>, loads only <code>XAddBulk</code>.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-29">Example<a href="#example-29" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Producer-only service (just enqueues tasks)</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">loadScripts</span><span class="hl-1">(</span><span class="hl-3">false</span><span class="hl-1">); </span><span class="hl-9">// or simply: await queue.loadScripts();</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-30">Example<a href="#example-30" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Full worker service (enqueues + processes tasks)</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">loadScripts</span><span class="hl-1">(</span><span class="hl-3">true</span><span class="hl-1">);</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">runQueue</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1769">PowerQueues.ts:1769</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="normalizeentries"><code class="tsd-tag">Private</code><span>normalize<wbr/>Entries</span><a href="#normalizeentries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="normalizeentries-1"><span class="tsd-kind-call-signature">normalizeEntries</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">raw</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><a href="#normalizeentries-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Converts raw Redis stream entries into a <strong>normalized, strongly-typed</strong> format
used by the worker pipeline.</p>
<p>Redis returns stream entries from <code>XREADGROUP</code>, <code>XAUTOCLAIM</code>, or Lua scripts
in a very loose structure:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  [ </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1"> | </span><span class="hl-5">Buffer</span><span class="hl-1">, [ </span><span class="hl-5">field1</span><span class="hl-1">, </span><span class="hl-5">value1</span><span class="hl-1">, </span><span class="hl-5">field2</span><span class="hl-1">, </span><span class="hl-5">value2</span><span class="hl-1">, ... ] ],</span><br/><span class="hl-1">  [ ... ],</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>This method transforms each entry into a clean tuple:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">[],</span><br/><span class="hl-1">  </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">idemKey</span><span class="hl-1">: </span><span class="hl-5">string</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>The resulting structure is much easier to work with inside the worker,
especially for:</p>
<ul>
<li><a href="#execute" class="tsd-kind-method">execute</a></li>
<li><a href="#idempotency" class="tsd-kind-method">idempotency</a></li>
<li><a href="#onexecute" class="tsd-kind-method">onExecute</a></li>
<li><a href="#onselected" class="tsd-kind-method">onSelected</a></li>
<li><a href="#onready" class="tsd-kind-method">onReady</a></li>
</ul>
<hr>
<h3 id="steps-performed" class="tsd-anchor-link">Steps performed<a href="#steps-performed" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p><strong>Validate input</strong></p>
<ul>
<li>If <code>raw</code> is not an array, return <code>[]</code>.</li>
</ul>
</li>
<li>
<p><strong>Convert Buffers → strings</strong></p>
<ul>
<li>Redis clients may return IDs and field names/values as Node.js Buffers.</li>
<li>This converts them to strings to avoid later type issues.</li>
</ul>
</li>
<li>
<p><strong>Filter invalid entries</strong></p>
<ul>
<li>Entries without an ID or with a malformed key/value array are skipped.</li>
<li>A valid entry must have an even number of KV items.</li>
</ul>
</li>
<li>
<p><strong>Extract metadata</strong></p>
<ul>
<li>
<p>Reads all KV pairs into a JS object using <a href="#values" class="tsd-kind-method">values</a>.</p>
</li>
<li>
<p>Extracts:</p>
<ul>
<li><code>job</code></li>
<li><code>createdAt</code></li>
<li><code>payload</code></li>
<li><code>idemKey</code></li>
</ul>
</li>
<li>
<p><code>payload</code> is further decoded using <a href="#payload" class="tsd-kind-method">payload</a>, which:</p>
<ul>
<li>Tries to JSON-decode it,</li>
<li>Returns raw data if decoding fails.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Produce normalized tuple</strong></p>
<ul>
<li>Ensures a consistent structure for each entry.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="example-transformation" class="tsd-anchor-link">Example transformation<a href="#example-transformation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Raw Redis entry:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;1700000000-0&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  [</span><span class="hl-2">&quot;payload&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;{</span><span class="hl-12">\&quot;</span><span class="hl-2">x</span><span class="hl-12">\&quot;</span><span class="hl-2">:1}&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;createdAt&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;1700000000000&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;job&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;abc&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;idemKey&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;u1&quot;</span><span class="hl-1">]</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>Normalized:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;1700000000-0&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  { </span><span class="hl-5">x:</span><span class="hl-1"> </span><span class="hl-7">1</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-7">1700000000000</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;abc&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&quot;u1&quot;</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<hr>
<h3 id="why-this-method-exists" class="tsd-anchor-link">Why this method exists<a href="#why-this-method-exists" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Redis stream APIs return very low-level arrays. Normalizing them:</p>
<ul>
<li>Removes Buffer/string inconsistencies,</li>
<li>Extracts metadata reliably,</li>
<li>Ensures workers always receive well-formed task entries,</li>
<li>Makes downstream code significantly simpler and safer.</li>
</ul>
<hr>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">raw</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Raw Redis entries returned by <code>XREADGROUP</code>, Lua <code>XAUTOCLAIM</code>, or the
<code>SelectStuck</code> script. Can be <code>null</code>, malformed, or empty.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span></h4><p>Array of normalized task tuples:</p>
<pre><code class="ts"><span class="hl-1">[ </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">idemKey</span><span class="hl-1"> ][]</span>
</code><button type="button">Copy</button></pre>

<p>or an empty array if no usable entries are found.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4750">PowerQueues.ts:4750</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onbatcherror"><span>on<wbr/>Batch<wbr/>Error</span><a href="#onbatcherror" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onbatcherror-1"><span class="tsd-kind-call-signature">onBatchError</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">err</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">tasks</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#onbatcherror-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Batch-level error hook.</p>
<p>This method is called when <strong>something goes wrong on the batch level</strong>, for example:</p>
<ul>
<li>an error is thrown inside <code>execute()</code> while processing a batch,</li>
<li>an error happens in <code>onReady()</code> (post-batch hook),</li>
<li>an unexpected error is thrown inside the main consumer loop.</li>
</ul>
<p>It is a good place to:</p>
<ul>
<li>log unexpected errors in one central place,</li>
<li>send alerts/notifications to monitoring,</li>
<li>decide whether to stop the worker (<code>this.abort.abort()</code>),</li>
<li>inspect which tasks were affected (when <code>tasks</code> is provided).</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>err</code> - the error object that was thrown (can be anything: Error, string, etc.).</li>
<li><code>tasks</code> - <strong>optional</strong> array of task tuples from the current batch:
<ul>
<li>Only passed when the error is related to a specific batch
(e.g. during <code>execute()</code> or <code>onReady()</code>).</li>
<li>May be <code>undefined</code> when the error happens before tasks are selected.</li>
</ul>
</li>
</ul>
<p>When present, each item in <code>tasks</code> has the structure:</p>
<ul>
<li><code>[0] id: string</code> - Redis stream entry ID.</li>
<li><code>[1] payload: any[]</code> - decoded payload passed later to <code>onExecute()</code>.</li>
<li><code>[2] createdAt: number</code> - creation time in ms since UNIX epoch.</li>
<li><code>[3] job: string</code> - job identifier for the batch.</li>
<li><code>[4] idemKey: string</code> - idempotency key (can be empty string).</li>
</ul>
<p>Important:</p>
<ul>
<li><strong>Do not rethrow</strong> from this method - the error is already caught.
If you throw again, it will only add noise and not help recovery.</li>
<li>Tasks from the batch may be in different states:
<ul>
<li>some may already be processed and ACKed,</li>
<li>some may still be pending in the stream and will be picked up later.</li>
</ul>
</li>
<li>Use this hook only for <strong>side effects</strong> (logging, metrics, alerts),
not for low-level queue control.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">err</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>The error that occurred during batch processing.</p>
</div></li><li><span><code class="tsd-tag">Optional</code><span class="tsd-kind-parameter">tasks</span>: <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Optional list of tasks related to this error (if available).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-31">Example<a href="#example-31" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: log batch error and stop worker on critical failures</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onBatchError</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">tasks</span><span class="hl-1">?: </span><span class="hl-5">Array</span><span class="hl-1">&lt;[</span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">any</span><span class="hl-1">[], </span><span class="hl-5">number</span><span class="hl-1">, </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">string</span><span class="hl-1">]&gt;,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">message</span><span class="hl-1"> = </span><span class="hl-5">err</span><span class="hl-1"> </span><span class="hl-3">instanceof</span><span class="hl-1"> </span><span class="hl-8">Error</span><span class="hl-1"> ? </span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1"> : </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 1. Basic logging</span><br/><span class="hl-1">  </span><span class="hl-9">// console.error(&#39;[queue] batch error&#39;, { message, tasksCount: tasks?.length ?? 0 });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 2. Send error to monitoring/alerting system</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.alerts.notify(&#39;queue.batch_error&#39;, {</span><br/><span class="hl-1">  </span><span class="hl-9">//   message,</span><br/><span class="hl-1">  </span><span class="hl-9">//   tasksCount: tasks?.length ?? 0,</span><br/><span class="hl-1">  </span><span class="hl-9">// });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 3. Optional: stop worker on very serious errors</span><br/><span class="hl-1">  </span><span class="hl-9">// if (message.includes(&#39;OutOfMemory&#39;)) {</span><br/><span class="hl-1">  </span><span class="hl-9">//   this.abort.abort();</span><br/><span class="hl-1">  </span><span class="hl-9">// }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1260">PowerQueues.ts:1260</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onerror"><span>on<wbr/>Error</span><a href="#onerror" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onerror-1"><span class="tsd-kind-call-signature">onError</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">err</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#onerror-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Hook that runs when a <strong>single task fails</strong> during execution.</p>
<p>This method is called <strong>after</strong>:</p>
<ul>
<li><code>onExecute()</code> throws an error,</li>
<li>the attempt counter is increased,</li>
<li><code>onRetry()</code> is called,</li>
<li><strong>but before</strong> the queue decides whether the task will be retried again
or moved to DLQ (dead-letter queue).</li>
</ul>
<p>You can use this hook for:</p>
<ul>
<li>logging a failure of an individual task,</li>
<li>sending alerts/metrics for failed attempts,</li>
<li>storing error details in your system,</li>
<li>instrumenting monitoring dashboards,</li>
<li>collecting statistics for debugging or analytics.</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>err</code> - Error thrown from <code>onExecute()</code> (may be any type: Error instance, string, etc.).</li>
<li><code>id</code> - Redis stream entry ID of the failed task.</li>
<li><code>payload</code> - Decoded payload object used in <code>onExecute()</code>.</li>
<li><code>createdAt</code> - Creation timestamp of the task in milliseconds.</li>
<li><code>job</code> - Job identifier that groups tasks added in the same batch.</li>
<li><code>key</code> - Idempotency key (empty if not used).</li>
<li><code>attempt</code> - Attempt number <strong>after incrementing</strong>, so:
<ul>
<li><code>1</code> = first retry,</li>
<li><code>2</code> = second retry, etc.</li>
</ul>
</li>
</ul>
<p>Notes:</p>
<ul>
<li>Do <strong>not</strong> rethrow errors from this method - the queue has already handled the failure.</li>
<li>The task may still be retried after this hook if <code>attempt &lt; workerMaxRetries</code>.</li>
<li>When <code>attempt &gt;= workerMaxRetries</code>:
<ul>
<li>The queue moves the task to DLQ (<code>&lt;stream&gt;:dlq</code>),</li>
<li><code>onError()</code> is still called before that happens.</li>
</ul>
</li>
<li>Do <strong>not</strong> ACK/Delete or requeue messages here - the queue will handle that.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">err</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>The error that occurred during execution.</p>
</div></li><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Decoded payload originally passed to <code>onExecute()</code>.</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation time in milliseconds.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Batch/job identifier for the task.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key (or empty string).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-32">Example<a href="#example-32" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: basic logging + metrics</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onError</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">key</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">attempt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">msg</span><span class="hl-1"> = </span><span class="hl-5">err</span><span class="hl-1"> </span><span class="hl-3">instanceof</span><span class="hl-1"> </span><span class="hl-8">Error</span><span class="hl-1"> ? </span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1"> : </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 1. Log failure</span><br/><span class="hl-1">  </span><span class="hl-9">// console.warn(&#39;[queue] task failed&#39;, {</span><br/><span class="hl-1">  </span><span class="hl-9">//   id, job, key, attempt, error: msg, payload,</span><br/><span class="hl-1">  </span><span class="hl-9">// });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 2. Send failure metric</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.metrics.inc(&#39;queue_task_fail_total&#39;, { job, attempt });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 3. Optional: store failure details for debugging</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.audit.save({</span><br/><span class="hl-1">  </span><span class="hl-9">//   id, job, attempt, error: msg, payload, createdAt,</span><br/><span class="hl-1">  </span><span class="hl-9">// });</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1333">PowerQueues.ts:1333</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onexecute"><span>on<wbr/>Execute</span><a href="#onexecute" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onexecute-1"><span class="tsd-kind-call-signature">onExecute</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">attempt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#onexecute-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Main <strong>task handler</strong> - this is where you put your business logic.</p>
<p>The worker calls <code>onExecute()</code> <strong>for every task that should be processed</strong>:</p>
<ul>
<li>For normal tasks (without idempotency key) it is invoked directly from <code>executeProcess()</code>.</li>
<li>For idempotent tasks it is invoked inside the idempotency flow (<code>idempotency()</code>).</li>
</ul>
<p>If this method:</p>
<ul>
<li><strong>resolves successfully</strong> (no error thrown) - the task is considered <strong>done</strong>:
<ul>
<li><code>onSuccess()</code> will be called,</li>
<li>the task will be <strong>ACKed</strong> and optionally <strong>removed</strong> from the stream,</li>
<li>attempts counter is <strong>not</strong> increased.</li>
</ul>
</li>
<li><strong>throws an error</strong> - the task is considered <strong>failed</strong>:
<ul>
<li>the attempts counter is incremented,</li>
<li><code>onRetry()</code> and <code>onError()</code> are called,</li>
<li>if attempts exceed <code>workerMaxRetries</code>, the task is moved to <strong>DLQ</strong> (<code>&lt;stream&gt;:dlq</code>).</li>
</ul>
</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>id</code> - Redis stream ID of this entry (e.g. <code>&quot;1719935620000-0&quot;</code>).</li>
<li><code>payload</code> - task payload already decoded by the queue:
<ul>
<li>If you pushed an object <code>{ foo: 'bar' }</code> - here you usually get the same object.</li>
<li>If JSON decode failed, you may get a raw string or other value.</li>
</ul>
</li>
<li><code>createdAt</code> - UNIX timestamp in milliseconds when the task was originally created.</li>
<li><code>job</code> - job identifier for the batch this task was added with (used for grouping/statistics).</li>
<li><code>key</code> - idempotency key (empty string if idempotency is not used for this task).</li>
<li><code>attempt</code> - current attempt number <strong>before</strong> this execution:
<ul>
<li><code>0</code> - first try,</li>
<li><code>1</code> - second try, etc.</li>
</ul>
</li>
</ul>
<p>Important:</p>
<ul>
<li>Always treat this method as <strong>async and potentially retried</strong>:
<ul>
<li>Write idempotent business logic where possible (safe to run twice).</li>
<li>Use <code>key</code> + <code>id</code> if you need extra deduplication on your side.</li>
</ul>
</li>
<li>Do <strong>not</strong> manually ACK or delete messages in Redis here - the queue
does this for you via <code>Approve</code> script.</li>
<li>Long-running tasks are supported - the worker periodically updates
lock/start keys via the heartbeat mechanism while this method runs.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID of the task.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Decoded task payload (business data to process).</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation time in milliseconds since UNIX epoch.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job identifier used to group tasks added in one batch.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key for this task (empty string if not used).</p>
</div></li><li><span><span class="tsd-kind-parameter">attempt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Current attempt number (0 for first execution).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-33">Example<a href="#example-33" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: simple HTTP call with retry-friendly error handling</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onExecute</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">key</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">attempt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-9">// 1. Validate payload shape</span><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-5">payload</span><span class="hl-1"> || </span><span class="hl-3">typeof</span><span class="hl-1"> </span><span class="hl-5">payload</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1"> !== </span><span class="hl-2">&#39;string&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-9">// Throwing will mark this attempt as failed and trigger retry/DLQ logic</span><br/><span class="hl-1">    </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&#39;Invalid payload: &quot;url&quot; is required&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 2. Add some logging/metrics (optional)</span><br/><span class="hl-1">  </span><span class="hl-9">// console.log(&#39;[queue] executing task&#39;, { id, job, attempt, url: payload.url });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 3. Execute business logic (can be any async operation)</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">response</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-0">fetch</span><span class="hl-1">(</span><span class="hl-5">payload</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-5">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;POST&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">body:</span><span class="hl-1"> </span><span class="hl-4">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-5">payload</span><span class="hl-1">.</span><span class="hl-5">body</span><span class="hl-1"> ?? {}),</span><br/><span class="hl-1">    </span><span class="hl-5">headers:</span><span class="hl-1"> { </span><span class="hl-2">&#39;Content-Type&#39;</span><span class="hl-5">:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-5">response</span><span class="hl-1">.</span><span class="hl-5">ok</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-9">// Non-2xx status: let the queue retry this task</span><br/><span class="hl-1">    </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">`Request failed with status </span><span class="hl-3">${</span><span class="hl-5">response</span><span class="hl-11">.</span><span class="hl-5">status</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 4. Optionally process response or update other systems</span><br/><span class="hl-1">  </span><span class="hl-9">// const data = await response.json();</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.someService.saveResult(id, data);</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// No return value is required - resolving without error means &quot;success&quot;.</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1076">PowerQueues.ts:1076</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onready"><span>on<wbr/>Ready</span><a href="#onready" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onready-1"><span class="tsd-kind-call-signature">onReady</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">data</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#onready-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Hook that runs <strong>after the batch of tasks has been executed</strong>, but <strong>before ACK</strong>.</p>
<p>Call order inside the worker loop:</p>
<ol>
<li>Tasks are selected from Redis (<code>select()</code> / <code>selectStuck()</code> / <code>selectFresh()</code>).</li>
<li><code>onSelected()</code> is called (you can filter/reorder tasks there).</li>
<li>Each task is processed via <code>executeProcess()</code> → <code>onExecute()</code>, idempotency, retries, DLQ, etc.</li>
<li><strong><code>onReady()</code> is called with the same <code>tasks</code> array used for execution.</strong></li>
<li>Successfully processed task IDs are ACKed via <code>approve()</code> (XACK + optional XDEL).</li>
</ol>
<p>Use this method for <strong>post-batch actions</strong>, for example:</p>
<ul>
<li>logging summary of the batch,</li>
<li>updating metrics (processed count, errors, latency),</li>
<li>emitting events/notifications,</li>
<li>flushing any in-memory buffers used during <code>onExecute()</code>.</li>
</ul>
<p>Each item in <code>data</code> is a tuple with this structure:</p>
<ul>
<li><code>[0] id: string</code> - Redis stream entry ID (e.g. <code>&quot;1719935620000-0&quot;</code>).</li>
<li><code>[1] payload: any[]</code> - decoded and normalized payload used by <code>onExecute()</code>.</li>
<li><code>[2] createdAt: number</code> - UNIX timestamp in milliseconds when the task was created.</li>
<li><code>[3] job: string</code> - job identifier that groups tasks added in one batch.</li>
<li><code>[4] idemKey: string</code> - idempotency key (can be an empty string).</li>
</ul>
<p>Important:</p>
<ul>
<li>This method is called <strong>even if some tasks failed</strong> inside the batch:
<ul>
<li>failures are already handled (retries, DLQ) by the time <code>onReady()</code> runs.</li>
</ul>
</li>
<li>If <code>onReady()</code> throws, the error is caught and passed to <code>onBatchError()</code>.</li>
<li>Do <strong>not</strong> modify Redis stream directly here (no manual XACK/XDEL) -
the queue will ACK successful IDs right after this hook.</li>
</ul>
<p>Keep this method <strong>fast and side-effect friendly</strong>: it should not block
the worker for a long time, but it is a good place for final &quot;batch-level&quot;
operations.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">data</span>: <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Array of task tuples that were just processed in this batch.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-34">Example<a href="#example-34" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: simple batch logging</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onReady</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">data</span><span class="hl-1">: </span><span class="hl-5">Array</span><span class="hl-1">&lt;[</span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">any</span><span class="hl-1">[], </span><span class="hl-5">number</span><span class="hl-1">, </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">string</span><span class="hl-1">]&gt;,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">total</span><span class="hl-1"> = </span><span class="hl-5">data</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">jobs</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Set</span><span class="hl-1">&lt;</span><span class="hl-8">string</span><span class="hl-1">&gt;();</span><br/><br/><span class="hl-1">  </span><span class="hl-6">for</span><span class="hl-1"> (</span><span class="hl-3">const</span><span class="hl-1"> [, , , </span><span class="hl-4">job</span><span class="hl-1">] </span><span class="hl-3">of</span><span class="hl-1"> </span><span class="hl-5">data</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">job</span><span class="hl-1">) </span><span class="hl-5">jobs</span><span class="hl-1">.</span><span class="hl-0">add</span><span class="hl-1">(</span><span class="hl-5">job</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// You can send this to your logger / metrics system</span><br/><span class="hl-1">  </span><span class="hl-9">// console.log(&#39;[queue] batch ready&#39;, { total, jobs: Array.from(jobs) });</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1131">PowerQueues.ts:1131</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onretry"><span>on<wbr/>Retry</span><a href="#onretry" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onretry-1"><span class="tsd-kind-call-signature">onRetry</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">err</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">attempt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#onretry-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Hook that runs when a <strong>task fails but will be retried</strong>.</p>
<p>This method is called immediately after:</p>
<ul>
<li><code>onExecute()</code> throws an error,</li>
<li>the internal attempt counter is incremented,</li>
<li><strong>before</strong> <code>onError()</code> and before deciding whether the task goes to DLQ.</li>
</ul>
<p>Use this hook for logic that is <strong>specifically about retries</strong>, such as:</p>
<ul>
<li>logging retry attempts separately from final failures,</li>
<li>applying exponential backoff logic (if you want custom behavior),</li>
<li>collecting retry metrics,</li>
<li>tracking repeated failures,</li>
<li>triggering &quot;early warning&quot; alerts when retry counts start increasing.</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>err</code> - The error thrown by <code>onExecute()</code> (any type).</li>
<li><code>id</code> - Redis stream entry ID of the task.</li>
<li><code>payload</code> - Decoded payload passed to <code>onExecute()</code>.</li>
<li><code>createdAt</code> - Timestamp (ms) when the task was originally created.</li>
<li><code>job</code> - Job identifier grouping tasks from the same batch.</li>
<li><code>key</code> - Idempotency key (empty string if not used).</li>
<li><code>attempt</code> - Current retry index <strong>after incrementing</strong>, so:
<ul>
<li><code>1</code> = first retry,</li>
<li><code>2</code> = second retry,</li>
<li>etc.</li>
</ul>
</li>
</ul>
<p>Notes:</p>
<ul>
<li>This method is only called for tasks that <strong>will be retried</strong>.
(If <code>attempt &gt;= workerMaxRetries</code>, the queue still calls <code>onRetry()</code>,
but the next step is DLQ transfer.)</li>
<li>Do <strong>not throw</strong> errors here. The retry process is already ongoing.</li>
<li>Do <strong>not</strong> ACK, delete, or requeue tasks manually - the queue handles everything.</li>
<li>Keep this hook fast - the worker often processes dozens/hundreds of tasks per batch.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">err</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>The error that triggered a retry.</p>
</div></li><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Decoded payload for the task.</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Creation timestamp of the task in ms.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job identifier for this task.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key used for this task (or empty).</p>
</div></li><li><span><span class="tsd-kind-parameter">attempt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Attempt number after incrementing.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-35">Example<a href="#example-35" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: logging retries with exponential backoff info</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onRetry</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">key</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">attempt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">errorMsg</span><span class="hl-1"> = </span><span class="hl-5">err</span><span class="hl-1"> </span><span class="hl-3">instanceof</span><span class="hl-1"> </span><span class="hl-8">Error</span><span class="hl-1"> ? </span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1"> : </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 1. Log retry attempt</span><br/><span class="hl-1">  </span><span class="hl-9">// console.log(&#39;[queue] retrying task&#39;, {</span><br/><span class="hl-1">  </span><span class="hl-9">//   id, job, key, attempt, error: errorMsg,</span><br/><span class="hl-1">  </span><span class="hl-9">// });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 2. Track metrics for retries</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.metrics.inc(&#39;queue_task_retry_total&#39;, { job, attempt });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 3. Optional: custom backoff hints or adaptive behavior</span><br/><span class="hl-1">  </span><span class="hl-9">// const backoffMs = Math.min(5000, attempt * 250);</span><br/><span class="hl-1">  </span><span class="hl-9">// console.log(`Next retry scheduled in about ~${backoffMs}ms`);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1405">PowerQueues.ts:1405</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onselected"><span>on<wbr/>Selected</span><a href="#onselected" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onselected-1"><span class="tsd-kind-call-signature">onSelected</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">data</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#onselected-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Hook that runs <strong>after tasks are read from Redis</strong> but <strong>before they are executed</strong>.</p>
<p>You can override this method to:</p>
<ul>
<li>filter tasks (drop some of them),</li>
<li>reorder tasks (change processing order),</li>
<li>enrich/normalize payloads,</li>
<li>add logging/metrics.</li>
</ul>
<p>Each item in <code>data</code> is a tuple with the following structure:</p>
<ul>
<li><code>[0] id: string</code> - Redis stream entry ID (e.g. <code>&quot;1719935620000-0&quot;</code>).</li>
<li><code>[1] payload: any[]</code> - decoded task payload.
<ul>
<li>For JSON payloads this is usually the parsed object or its fields.</li>
</ul>
</li>
<li><code>[2] createdAt: number</code> - UNIX timestamp in milliseconds when the task was created.</li>
<li><code>[3] job: string</code> - job identifier used to group tasks added in one batch.</li>
<li><code>[4] idemKey: string</code> - idempotency key used by the worker to avoid duplicate execution.</li>
</ul>
<p>Important notes:</p>
<ul>
<li>If you <strong>return a non-empty array</strong>, it will be passed to the internal <code>execute()</code> method.</li>
<li>If you <strong>return <code>undefined</code>, <code>null</code> or an empty array</strong>, the original <code>data</code> array
will be used instead.</li>
<li>If you want to <strong>remove only some tasks</strong>, return a filtered array with the
remaining tuples.</li>
<li>If you need to change a task, you can either:
<ul>
<li>mutate the objects inside <code>data</code> in place, or</li>
<li>return a new array with modified tuples.</li>
</ul>
</li>
</ul>
<p>Keep this method fast and non-blocking: it is called on every worker loop
iteration before executing tasks.</p>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">data</span>: <span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Array of raw task tuples selected from the stream for this iteration.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><ul>
<li>The array of tasks to execute (filtered/reordered/modified), or</li>
<li><code>undefined</code> / <code>null</code> / empty array to use the original <code>data</code> as-is.</li>
</ul>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-36">Example<a href="#example-36" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: filter out tasks with invalid payloads and log them</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onSelected</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">data</span><span class="hl-1">: </span><span class="hl-5">Array</span><span class="hl-1">&lt;[</span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">any</span><span class="hl-1">[], </span><span class="hl-5">number</span><span class="hl-1">, </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">string</span><span class="hl-1">]&gt;,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">valid</span><span class="hl-1">: </span><span class="hl-8">Array</span><span class="hl-1">&lt;[</span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-8">any</span><span class="hl-1">[], </span><span class="hl-8">number</span><span class="hl-1">, </span><span class="hl-8">string</span><span class="hl-1">, </span><span class="hl-8">string</span><span class="hl-1">]&gt; = [];</span><br/><br/><span class="hl-1">  </span><span class="hl-6">for</span><span class="hl-1"> (</span><span class="hl-3">const</span><span class="hl-1"> [</span><span class="hl-4">id</span><span class="hl-1">, </span><span class="hl-4">payload</span><span class="hl-1">, </span><span class="hl-4">createdAt</span><span class="hl-1">, </span><span class="hl-4">job</span><span class="hl-1">, </span><span class="hl-4">idemKey</span><span class="hl-1">] </span><span class="hl-3">of</span><span class="hl-1"> </span><span class="hl-5">data</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">isOk</span><span class="hl-1"> = </span><span class="hl-5">payload</span><span class="hl-1"> &amp;&amp; </span><span class="hl-3">typeof</span><span class="hl-1"> </span><span class="hl-5">payload</span><span class="hl-1"> === </span><span class="hl-2">&#39;object&#39;</span><span class="hl-1"> &amp;&amp; </span><span class="hl-5">payload</span><span class="hl-1">[</span><span class="hl-2">&#39;type&#39;</span><span class="hl-1">];</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">isOk</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">valid</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">([</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">idemKey</span><span class="hl-1">]);</span><br/><span class="hl-1">    } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-9">// you can send invalid tasks to DLQ / log / metrics here</span><br/><span class="hl-1">      </span><span class="hl-9">// await this.addTasks(`${this.stream}:invalid`, [{ payload: { id, payload, createdAt, job, idemKey } }]);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-5">valid</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L989">PowerQueues.ts:989</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="onsuccess"><span>on<wbr/>Success</span><a href="#onsuccess" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="onsuccess-1"><span class="tsd-kind-call-signature">onSuccess</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#onsuccess-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Hook that runs <strong>after a task has been executed successfully</strong>, but <strong>before it is ACKed</strong>.</p>
<p>Call order for a successful task (simplified):</p>
<ol>
<li>Task is selected from Redis (<code>select()</code>).</li>
<li><code>onExecute()</code> runs your main business logic.</li>
<li>If <code>onExecute()</code> finishes without throwing:
<ul>
<li>internal <code>success()</code> is called,</li>
<li>job-level counters may be updated,</li>
<li><strong><code>onSuccess()</code> is called (this method).</strong></li>
</ul>
</li>
<li>The task ID is added to the list of successfully processed IDs.</li>
<li>Later, the batch of IDs is ACKed (and optionally deleted) by <code>approve()</code>.</li>
</ol>
<p>Use this method when you want to:</p>
<ul>
<li>log successful executions,</li>
<li>send events/notifications (e.g. WebSocket, message bus),</li>
<li>update external metrics / audit logs,</li>
<li>trigger follow-up actions that should only happen <strong>if the task really succeeded</strong>.</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>id</code> - Redis stream entry ID (e.g. <code>&quot;1719935620000-0&quot;</code>).</li>
<li><code>payload</code> - the same decoded payload that was passed to <code>onExecute()</code>.</li>
<li><code>createdAt</code> - UNIX timestamp in milliseconds when the task was created.</li>
<li><code>job</code> - job identifier used to group tasks added in one batch.</li>
<li><code>key</code> - idempotency key (empty string if idempotency was not used).</li>
</ul>
<p>Notes:</p>
<ul>
<li>This hook is <strong>not</strong> retried: if it throws, the error is handled via <code>onBatchError()</code>,
but the main task is still considered successful (it already passed <code>onExecute()</code>).</li>
<li>Keep this method <strong>side-effect safe</strong>: avoid throwing unless it is really necessary.</li>
<li>Do <strong>not</strong> ACK, delete, or requeue messages here - the queue handles that automatically.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID of the successfully processed task.</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Decoded payload that was handled in <code>onExecute()</code>.</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation time in milliseconds since UNIX epoch.</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job identifier for this task batch.</p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key used for this task (or empty string).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-37">Example<a href="#example-37" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: log success and send a simple metric</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onSuccess</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">key</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">durationMs</span><span class="hl-1"> = </span><span class="hl-5">Date</span><span class="hl-1">.</span><span class="hl-0">now</span><span class="hl-1">() - </span><span class="hl-5">createdAt</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 1. Log success (to console, logger, etc.)</span><br/><span class="hl-1">  </span><span class="hl-9">// console.log(&#39;[queue] success&#39;, { id, job, key, durationMs });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 2. Update metrics / monitoring</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.metrics.inc(&#39;queue_task_success_total&#39;, { job });</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.metrics.observe(&#39;queue_task_duration_ms&#39;, durationMs, { job });</span><br/><br/><span class="hl-1">  </span><span class="hl-9">// 3. Optionally notify other services</span><br/><span class="hl-1">  </span><span class="hl-9">// await this.events.emit(&#39;task.success&#39;, { id, job, payload });</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1194">PowerQueues.ts:1194</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="payload"><code class="tsd-tag">Private</code><span>payload</span><a href="#payload" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="payload-1"><span class="tsd-kind-call-signature">payload</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">data</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><a href="#payload-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Attempts to decode the <code>&quot;payload&quot;</code> field of a Redis stream entry.</p>
<p>The <code>payload</code> stored in Redis is usually a JSON string created by
<a href="#addtasks" class="tsd-kind-method">addTasks</a>, but depending on user input or malformed data,
it may also be plain text. This helper ensures that downstream code
always receives a <strong>safe and predictable JavaScript value</strong>.</p>
<h3 id="behaviour-1" class="tsd-anchor-link">Behaviour<a href="#behaviour-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>Tries to <code>JSON.parse</code> the provided value using jsonDecode.</p>
<ul>
<li>If decoding succeeds, the parsed object is returned.</li>
<li>If decoding fails (invalid JSON), the raw input value is returned.</li>
</ul>
</li>
<li>
<p>Any unexpected error encountered while decoding is swallowed:</p>
<ul>
<li>The method falls back to returning the raw data unchanged.</li>
</ul>
</li>
</ol>
<h3 id="why-this-method-exists-1" class="tsd-anchor-link">Why this method exists<a href="#why-this-method-exists-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Redis stream values are always stored as plain strings.<br>
Without decoding:</p>
<ul>
<li>Workers would have to manually <code>JSON.parse</code> payloads everywhere,</li>
<li>Errors could leak or crash the worker loop,</li>
<li>The queue would be more fragile to malformed data.</li>
</ul>
<p>By using this method, the worker pipeline receives:</p>
<ul>
<li>Valid JS objects when the payload is proper JSON,</li>
<li>Safe fallback values when payloads are not JSON,</li>
<li>A consistent interface for all messages.</li>
</ul>
<h3 id="example-38" class="tsd-anchor-link">Example<a href="#example-38" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Input (string from Redis):</p>
<pre><code class="ts"><span class="hl-2">&quot;{</span><span class="hl-12">\&quot;</span><span class="hl-2">x</span><span class="hl-12">\&quot;</span><span class="hl-2">: 42 }&quot;</span>
</code><button type="button">Copy</button></pre>

<p>Output:</p>
<pre><code class="ts"><span class="hl-1">{ </span><span class="hl-10">x</span><span class="hl-1">: </span><span class="hl-7">42</span><span class="hl-1"> }</span>
</code><button type="button">Copy</button></pre>

<p>Invalid input:</p>
<pre><code class="ts"><span class="hl-2">&quot;{not json}&quot;</span>
</code><button type="button">Copy</button></pre>

<p>Output:</p>
<pre><code class="ts"><span class="hl-2">&quot;{not json}&quot;</span>
</code><button type="button">Copy</button></pre>

<h3 id="usage" class="tsd-anchor-link">Usage<a href="#usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Normally used only inside <a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> { </span><span class="hl-4">payload</span><span class="hl-1"> } = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">values</span><span class="hl-1">(</span><span class="hl-5">kv</span><span class="hl-1">);</span><br/><span class="hl-6">return</span><span class="hl-1"> [ </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">payload</span><span class="hl-1">(</span><span class="hl-5">payload</span><span class="hl-1">), </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">idemKey</span><span class="hl-1"> ];</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">data</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>The raw <code>&quot;payload&quot;</code> value taken from Redis (typically a string).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">any</span></h4><p>A parsed JS object if <code>data</code> contains valid JSON, otherwise the raw value.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4918">PowerQueues.ts:4918</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="payloadbatch"><code class="tsd-tag">Private</code><span>payload<wbr/>Batch</span><a href="#payloadbatch" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="payloadbatch-1"><span class="tsd-kind-call-signature">payloadBatch</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">data</span><span class="tsd-signature-symbol">:</span> <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-kind-parameter">opts</span><span class="tsd-signature-symbol">:</span> <a href="../types/AddTasksOptions.html" class="tsd-signature-type tsd-kind-type-alias">AddTasksOptions</a><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><a href="#payloadbatch-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Builds the <strong>argument vector (<code>ARGV</code>) payload</strong> for the <code>XAddBulk</code> Lua script.</p>
<p>This method converts a batch of logical <code>Task</code> objects into a <strong>flat string array</strong>
that is later passed to Redis as <code>...ARGV</code> for <code>EVALSHA</code> of <code>XAddBulk</code>.</p>
<p>It does <strong>not</strong> talk to Redis directly - it only prepares data.
The resulting array is consumed by <a href="#xaddbatch" class="tsd-kind-method">xaddBatch</a>.</p>
<h3 id="how-it-works-3" class="tsd-anchor-link">How it works<a href="#how-it-works-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>Adds global stream trim options (MAXLEN / MINID / NOMKSTREAM / LIMIT) to the header:
<ul>
<li><code>maxlen</code> → <code>XADD ... MAXLEN ~= maxlen</code></li>
<li><code>approx</code> / <code>exact</code> → choose between <code>~</code> (approximate) or <code>=</code> (exact) trim</li>
<li><code>nomkstream</code> → <code>NOMKSTREAM</code> flag</li>
<li><code>trimLimit</code> → <code>LIMIT &lt;trimLimit&gt;</code> for trimming</li>
<li><code>minidWindowMs</code> + <code>minidExact</code> → <code>MINID</code> based trimming (time-based retention)</li>
</ul>
</li>
<li>Encodes each task as:
<ul>
<li><code>id</code> - stream entry ID (e.g. <code>&quot;*&quot;</code>, or a specific ID string);</li>
<li><code>num_pairs</code> - number of field/value pairs;</li>
<li>then <code>field1, value1, field2, value2, ...</code> as strings.</li>
</ul>
</li>
</ol>
<h3 id="task-input-rules" class="tsd-anchor-link">Task input rules<a href="#task-input-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Each <code>Task</code> must be in one of two shapes:</p>
<ul>
<li>
<p><strong>Object payload form</strong>:</p>
<pre><code class="ts"><span class="hl-1">{ </span><span class="hl-10">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">; </span><span class="hl-10">payload</span><span class="hl-1">: </span><span class="hl-5">Record</span><span class="hl-1">&lt;</span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">JsonPrimitiveOrUndefined</span><span class="hl-1">&gt;; ... }</span>
</code><button type="button">Copy</button></pre>

<p>In this case, all <code>payload</code> entries are flattened into <code>[field, value, ...]</code>.</p>
</li>
<li>
<p><strong>Flat array form</strong>:</p>
<pre><code class="ts"><span class="hl-1">{ </span><span class="hl-10">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">; </span><span class="hl-10">flat</span><span class="hl-1">: </span><span class="hl-5">JsonPrimitiveOrUndefined</span><span class="hl-1">[]; ... }</span>
</code><button type="button">Copy</button></pre>

<p>Here <code>flat</code> is assumed to already contain interleaved field/value pairs.</p>
</li>
</ul>
<p>For <code>flat</code>:</p>
<ul>
<li>Its length <strong>must be even</strong>, otherwise an error is thrown:
<code>&quot;Property &quot;flat&quot; must contain an even number of realKeysLength (field/value pairs).&quot;</code></li>
<li>It must contain <strong>at least one pair</strong> - otherwise an error is thrown:
<code>&quot;Task &quot;flat&quot; must contain at least one field/value pair.&quot;</code></li>
</ul>
<p>If a task has neither a valid <code>payload</code> object nor a valid <code>flat</code> array,
an error is thrown:</p>
<ul>
<li><code>&quot;Task must have &quot;payload&quot; or &quot;flat&quot;.&quot;</code></li>
</ul>
<h3 id="id-and-value-encoding" class="tsd-anchor-link">ID and value encoding<a href="#id-and-value-encoding" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><code>entry.id</code> is used if present; otherwise <code>&quot;*&quot;</code> (server-generated ID).</li>
<li>All field values are converted to strings:
<ul>
<li><code>null</code> / <code>undefined</code> → <code>&quot;&quot;</code> (empty string),</li>
<li>non-string primitives (numbers, booleans, etc.) → <code>String(value)</code>.</li>
</ul>
</li>
</ul>
<h3 id="batching-behaviour" class="tsd-anchor-link">Batching behaviour<a href="#batching-behaviour" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>This method assumes that <code>data</code> is a <strong>single batch</strong> (typically produced by <code>buildBatches</code>),
so it only encodes that batch into the <code>ARGV</code> format.</li>
<li>It <strong>does not mutate</strong> the input tasks (only reads from them).</li>
</ul>
<h3 id="options-" class="tsd-anchor-link">Options (<code>AddTasksOptions</code>)<a href="#options-" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><code>maxlen</code>        - Maximum allowed stream length (used with <code>MAXLEN</code>).</li>
<li><code>approx</code>        - If <code>true</code> or <code>undefined</code>, use <code>~</code> (approximate) trimming (default);
if <code>false</code> and <code>exact</code> is not set, no trim operator is sent.</li>
<li><code>exact</code>         - If <code>true</code>, use <code>=</code> (exact) trimming and ignore <code>approx</code>.</li>
<li><code>nomkstream</code>    - If <code>true</code>, pass <code>NOMKSTREAM</code> to avoid creating the stream automatically.</li>
<li><code>trimLimit</code>     - Optional <code>LIMIT</code> for trimming operations; <code>0</code> means &quot;no limit&quot;.</li>
<li><code>minidWindowMs</code> - If &gt; 0, switch from <code>MAXLEN</code> to <strong>time-based retention</strong> with <code>MINID</code>
(keep entries newer than <code>&lt;now - minidWindowMs&gt;</code>).</li>
<li><code>minidExact</code>    - When using <code>MINID</code>, if <code>true</code> use <code>=</code>, otherwise <code>~</code>.</li>
</ul>
<p>Note: <code>minidWindowMs</code> has higher priority than <code>maxlen</code>. If <code>minidWindowMs &gt; 0</code>,
the header will use <code>MINID</code> and <strong>ignore</strong> <code>MAXLEN</code>.</p>
<h3 id="return-value-3" class="tsd-anchor-link">Return value<a href="#return-value-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Returns a string array representing <code>ARGV</code> for the <code>XAddBulk</code> Lua script:</p>
<pre><code class="text">[
  maxlen, approxFlag, n, exactFlag, nomkstreamFlag, trimLimit,
  minidWindowMs, minidExactFlag,
  id1, pairs1, field1_1, value1_1, field1_2, value1_2, ...,
  id2, pairs2, field2_1, value2_1, ...
]
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">data</span>: <a href="../types/Task.html" class="tsd-signature-type tsd-kind-type-alias">Task</a><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Batch of tasks to be encoded into the Redis <code>XADD</code> payload.
Usually this is a single batch from <a href="#buildbatches" class="tsd-kind-method">buildBatches</a>.</p>
</div></li><li><span><span class="tsd-kind-parameter">opts</span>: <a href="../types/AddTasksOptions.html" class="tsd-signature-type tsd-kind-type-alias">AddTasksOptions</a></span><div class="tsd-comment tsd-typography"><p>Stream trimming and behaviour options (MAXLEN / MINID / NOMKSTREAM / LIMIT).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span></h4><p>String array that will be spread as <code>...ARGV</code> for the <code>XAddBulk</code> Lua script.</p>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-throws"><h4 class="tsd-anchor-link" id="throws-1">Throws<a href="#throws-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>If a task has invalid <code>flat</code> length, no <code>payload</code>/<code>flat</code>, or contains 0 pairs.</p>
</div><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-39">Example<a href="#example-39" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Minimal batch with object payloads</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">argv</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">payloadBatch</span><span class="hl-1">([</span><br/><span class="hl-1">  { </span><span class="hl-5">job:</span><span class="hl-1"> </span><span class="hl-2">&#39;email&#39;</span><span class="hl-1">, </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">to:</span><span class="hl-1"> </span><span class="hl-2">&#39;user@example.com&#39;</span><span class="hl-1">, </span><span class="hl-5">subject:</span><span class="hl-1"> </span><span class="hl-2">&#39;Hi&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">  { </span><span class="hl-5">job:</span><span class="hl-1"> </span><span class="hl-2">&#39;email&#39;</span><span class="hl-1">, </span><span class="hl-5">payload:</span><span class="hl-1"> { </span><span class="hl-5">to:</span><span class="hl-1"> </span><span class="hl-2">&#39;admin@example.com&#39;</span><span class="hl-1">, </span><span class="hl-5">subject:</span><span class="hl-1"> </span><span class="hl-2">&#39;Report&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">], { </span><span class="hl-5">maxlen:</span><span class="hl-1"> </span><span class="hl-7">10000</span><span class="hl-1"> });</span><br/><br/><span class="hl-9">// Then:</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">xaddBatch</span><span class="hl-1">(</span><span class="hl-2">&#39;queues:emails&#39;</span><span class="hl-1">, ...</span><span class="hl-5">argv</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2133">PowerQueues.ts:2133</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member"><h3 class="tsd-anchor-link" id="runqueue"><span>run<wbr/>Queue</span><a href="#runqueue" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures"><li class=""><div class="tsd-signature tsd-anchor-link" id="runqueue-1"><span class="tsd-kind-call-signature">runQueue</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#runqueue-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Starts the queue worker: initializes the consumer group and begins the
infinite processing loop.</p>
<p>This is the <strong>entrypoint</strong> for running a worker instance.<br>
Calling <code>runQueue()</code>:</p>
<ol>
<li>Ensures the Redis consumer group exists (creates it if needed).</li>
<li>Starts the main worker loop via <code>consumerLoop()</code>.</li>
<li>The worker will continue running until <code>this.abort.abort()</code> is called.</li>
</ol>
<p>Typical usage:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">queue</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">MyQueue</span><span class="hl-1">(</span><span class="hl-5">redisClient</span><span class="hl-1">);</span><br/><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1"> = </span><span class="hl-2">&#39;events&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1"> = </span><span class="hl-2">&#39;worker-1&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-5">consumerHost</span><span class="hl-1"> = </span><span class="hl-2">&#39;api-server&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">queue</span><span class="hl-1">.</span><span class="hl-0">runQueue</span><span class="hl-1">(); </span><span class="hl-9">// begins processing</span>
</code><button type="button">Copy</button></pre>

<p>Internals and Flow:</p>
<ul>
<li>
<p><strong>createGroup('0-0')</strong><br>
Ensures the Redis Stream Group exists.<br>
<code>'0-0'</code> means the worker will handle all historical messages that
haven't been acknowledged yet.</p>
</li>
<li>
<p><strong>consumerLoop()</strong><br>
Starts the continuous polling loop:</p>
<ul>
<li>reads tasks using <code>select()</code> / <code>selectStuck()</code> / <code>selectFresh()</code>,</li>
<li>calls <code>onSelected()</code>,</li>
<li>executes tasks (idempotent, retries, DLQ),</li>
<li>calls <code>onReady()</code>,</li>
<li>ACKs completed tasks.</li>
</ul>
</li>
</ul>
<p>Stopping the worker:</p>
<ul>
<li>The worker responds to <code>this.abort</code> signal.</li>
<li>Calling <code>this.abort.abort()</code> will break the loop at the next safe point.</li>
</ul>
<p>Important Notes:</p>
<ul>
<li>This method should be called <strong>once per worker instance</strong>.</li>
<li>It never resolves unless the worker is stopped.</li>
<li>Safe to call in background processes, NestJS modules, or standalone runners.</li>
<li>Does not block the event loop - all work inside is asynchronous.</li>
</ul>
</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-40">Example<a href="#example-40" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Full example: running a queue worker</span><br/><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">redis</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">IORedis</span><span class="hl-1">(...);</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">q</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">MyQueue</span><span class="hl-1">(</span><span class="hl-5">redis</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-5">q</span><span class="hl-1">.</span><span class="hl-5">stream</span><span class="hl-1"> = </span><span class="hl-2">&#39;user:events&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">q</span><span class="hl-1">.</span><span class="hl-5">group</span><span class="hl-1"> = </span><span class="hl-2">&#39;analytics&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">q</span><span class="hl-1">.</span><span class="hl-5">consumerHost</span><span class="hl-1"> = </span><span class="hl-2">&#39;analytics-service&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;Worker starting...&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-5">q</span><span class="hl-1">.</span><span class="hl-0">runQueue</span><span class="hl-1">();       </span><span class="hl-9">// does not return unless aborted</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<pre><code>
</code><button>Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1467">PowerQueues.ts:1467</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="runscript"><code class="tsd-tag">Private</code><span>run<wbr/>Script</span><a href="#runscript" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="runscript-1"><span class="tsd-kind-call-signature">runScript</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">name</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">args</span><span class="tsd-signature-symbol">:</span> (<span class="tsd-signature-type">string</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">number</span>)<span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">defaultCode</span><span class="tsd-signature-symbol">?:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">&gt;</span><a href="#runscript-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Executes a previously registered Lua script by <strong>name</strong> using <code>EVALSHA</code>,
automatically loading or reloading it into Redis when needed.</p>
<p>This is an internal helper used by higher-level queue operations,
for example:</p>
<ul>
<li><code>xaddBatch()</code> → <code>&quot;XAddBulk&quot;</code></li>
<li><code>approve()</code> → <code>&quot;Approve&quot;</code></li>
<li>idempotency helpers → <code>&quot;IdempotencyAllow&quot;</code>, <code>&quot;IdempotencyStart&quot;</code>, etc.</li>
</ul>
<p>Behaviour:</p>
<ol>
<li>Looks up the script in <code>this.scripts[name]</code>.</li>
<li>If it is missing:
<ul>
<li>If <code>defaultCode</code> is provided and non-empty, it will:
<ul>
<li>call <code>saveScript(name, defaultCode)</code> to register it in memory.</li>
</ul>
</li>
<li>If <code>defaultCode</code> is not provided or empty, it throws:
<code>&quot;Undefined script &quot;&lt;name&gt;&quot;. Save it before executing.&quot;</code></li>
</ul>
</li>
<li>If <code>codeReady</code> (SHA1) is not available yet:
<ul>
<li>calls <code>loadScript(codeBody)</code> to load the script into Redis,</li>
<li>stores the SHA1 in <code>this.scripts[name].codeReady</code>.</li>
</ul>
</li>
<li>Calls <code>EVALSHA</code> with:
<ul>
<li>the cached SHA (<code>codeReady</code>),</li>
<li><code>keys.length</code> as the <code>numkeys</code> parameter,</li>
<li>all <code>keys</code> followed by all <code>args</code>.</li>
</ul>
</li>
<li>If Redis returns a <code>NOSCRIPT</code> error (e.g. after Redis restart):
<ul>
<li>reloads the script using <code>loadScript(codeBody)</code>,</li>
<li>retries <code>EVALSHA</code> once with the new SHA.</li>
</ul>
</li>
</ol>
<p>This makes script execution:</p>
<ul>
<li><strong>Fast</strong> (uses <code>EVALSHA</code> instead of <code>EVAL</code>),</li>
<li><strong>Safe</strong> (self-healing after Redis restart or flush),</li>
<li><strong>Convenient</strong> (call by logical name, not by SHA).</li>
</ul>
<p>Parameters:</p>
<ul>
<li><code>name</code> - Logical name of the script in <code>this.scripts</code> (e.g. <code>&quot;XAddBulk&quot;</code>).</li>
<li><code>keys</code> - Array of Redis keys passed to the script:
<ul>
<li>First argument to <code>EVALSHA</code> after <code>numkeys</code>,</li>
<li>The Lua script sees them via the global <code>KEYS</code> table.</li>
</ul>
</li>
<li><code>args</code> - Array of arguments (strings or numbers) passed <strong>after</strong> keys:
<ul>
<li>Lua script sees them via the global <code>ARGV</code> table.</li>
</ul>
</li>
<li><code>defaultCode</code> - Optional raw Lua source:
<ul>
<li>Used only when <code>this.scripts[name]</code> is not registered yet.</li>
<li>Allows one-line &quot;lazy&quot; definition and execution.</li>
</ul>
</li>
</ul>
<p>Return value:</p>
<ul>
<li>Whatever the Lua script returns (type depends on script logic).</li>
<li>The value is passed through from <code>evalsha</code> as-is.</li>
</ul>
<p>Notes:</p>
<ul>
<li>All numbers in <code>args</code> are passed to Redis as-is; Redis will convert them to strings.</li>
<li>For consistent behaviour, prefer passing <code>String(...)</code> yourself when in doubt.</li>
<li>This is a <strong>low-level</strong> method; public API usually calls it indirectly.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">name</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Name of the script in the local cache (<code>this.scripts</code>).</p>
</div></li><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Redis keys array, available as <code>KEYS</code> inside Lua.</p>
</div></li><li><span><span class="tsd-kind-parameter">args</span>: (<span class="tsd-signature-type">string</span> <span class="tsd-signature-symbol">|</span> <span class="tsd-signature-type">number</span>)<span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Arguments array (strings/numbers), available as <code>ARGV</code> inside Lua.</p>
</div></li><li><span><code class="tsd-tag">Optional</code><span class="tsd-kind-parameter">defaultCode</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Optional Lua source used if script is not yet registered.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise resolving to the result of the Lua script.</p>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-41">Example<a href="#example-41" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Example: calling XAddBulk indirectly (simplified)</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">res</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">runScript</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;XAddBulk&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  [</span><span class="hl-5">queueName</span><span class="hl-1">],                               </span><span class="hl-9">// KEYS</span><br/><span class="hl-1">  </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">payloadBatch</span><span class="hl-1">(</span><span class="hl-5">tasks</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">),           </span><span class="hl-9">// ARGV[]</span><br/><span class="hl-1">  </span><span class="hl-5">XAddBulk</span><span class="hl-1">,                                 </span><span class="hl-9">// default code if not yet saved</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1963">PowerQueues.ts:1963</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="savescript"><code class="tsd-tag">Private</code><span>save<wbr/>Script</span><a href="#savescript" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="savescript-1"><span class="tsd-kind-call-signature">saveScript</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">name</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-kind-parameter">codeBody</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><a href="#savescript-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Registers a script in the local in-memory cache and returns its body.</p>
<p>This method:</p>
<ul>
<li>Validates that the script body is not empty,</li>
<li>Saves the script under <code>this.scripts[name]</code>,
storing only its <strong>uncompiled source code</strong> (<code>codeBody</code>),</li>
<li>Does <strong>not</strong> load the script into Redis by itself,</li>
<li>Returns the raw script body so it can immediately be passed to
<code>loadScript()</code> which compiles and registers it inside Redis.</li>
</ul>
<p>Internal usage:</p>
<ul>
<li>Called by <code>loadScripts()</code>, where each script is:
<ol>
<li>saved locally via <code>saveScript(name, codeBody)</code>,</li>
<li>then passed to <code>loadScript(codeBody)</code> to load it into Redis,</li>
<li>and the resulting SHA is stored back into <code>this.scripts[name].codeReady</code>.</li>
</ol>
</li>
</ul>
<p>Why scripts are cached:</p>
<ul>
<li>Redis needs the script SHA to run the script via <code>EVALSHA</code>.</li>
<li>If Redis restarts and forgets the script,
the queue detects <code>NOSCRIPT</code> errors and reloads the script automatically.</li>
<li>Keeping the source in memory ensures we always know how to reload it.</li>
</ul>
<p>Validation:</p>
<ul>
<li>If <code>codeBody</code> is empty, undefined, or not a valid non-empty string,
an error <code>&quot;Script body is empty.&quot;</code> is thrown.</li>
</ul>
<p>Note:</p>
<ul>
<li>This does <em>not</em> compute or store <code>codeReady</code> (SHA1).<br>
That happens only when the script is actually loaded.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">name</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Unique script identifier (e.g., <code>&quot;XAddBulk&quot;</code>, <code>&quot;Approve&quot;</code>).</p>
</div></li><li><span><span class="tsd-kind-parameter">codeBody</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Raw Lua script source.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">string</span></h4><p>The same <code>codeBody</code> string so it can be passed directly to <code>loadScript()</code>.</p>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-42">Example<a href="#example-42" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Inside loadScripts():</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">scriptBody</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">saveScript</span><span class="hl-1">(</span><span class="hl-2">&#39;XAddBulk&#39;</span><span class="hl-1">, </span><span class="hl-5">XAddBulk</span><span class="hl-1">);</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">sha</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">loadScript</span><span class="hl-1">(</span><span class="hl-5">scriptBody</span><span class="hl-1">);</span><br/><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">scripts</span><span class="hl-1">[</span><span class="hl-2">&#39;XAddBulk&#39;</span><span class="hl-1">].</span><span class="hl-5">codeReady</span><span class="hl-1"> = </span><span class="hl-5">sha</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L1885">PowerQueues.ts:1885</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="select"><code class="tsd-tag">Private</code><span>select</span><a href="#select" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="select-1"><span class="tsd-kind-call-signature">select</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#select-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Fetches the <strong>next batch of tasks</strong> for the worker, combining:</p>
<ol>
<li><strong>Stuck (pending) tasks</strong> that should be recovered, and</li>
<li><strong>Fresh (new) tasks</strong> that have just arrived in the stream.</li>
</ol>
<p>This method is the main <strong>entry point for task selection</strong> in the worker
loop and is used directly by <a href="#consumerloop" class="tsd-kind-method">consumerLoop</a>. It hides the complexity
of dealing with pending vs new messages and always returns a normalized,
easy-to-use structure.</p>
<h3 id="how-it-works-4" class="tsd-anchor-link">How it works<a href="#how-it-works-4" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>It first calls <a href="#selectstuck" class="tsd-kind-method">selectStuck</a>:</p>
<ul>
<li>Tries to claim long-idle pending messages (using <code>XAUTOCLAIM</code> via Lua).</li>
<li>These are tasks that were delivered to some consumer but not acknowledged
for too long (e.g. worker crashed, timed out, or got stuck).</li>
<li>Recovering them first helps prevent tasks from being lost or blocked forever.</li>
</ul>
</li>
<li>
<p>If no stuck tasks are found (<code>entries</code> is empty):</p>
<ul>
<li>It calls <a href="#selectfresh" class="tsd-kind-method">selectFresh</a> to read <strong>new messages</strong> using <code>XREADGROUP</code>.</li>
<li>This returns tasks that have never been delivered to any consumer before.</li>
</ul>
</li>
<li>
<p>Regardless of where the raw entries came from, it passes them to
<a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a>, which:</p>
<ul>
<li>Converts raw Redis reply structures into a <strong>typed, consistent format</strong>.</li>
<li>Extracts and decodes the payload.</li>
<li>Pulls out metadata fields like <code>job</code>, <code>createdAt</code>, and <code>idemKey</code>.</li>
</ul>
</li>
</ol>
<h3 id="returned-structure" class="tsd-anchor-link">Returned structure<a href="#returned-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The final result is an array of tuples:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">payload</span><span class="hl-1">: </span><span class="hl-5">any</span><span class="hl-1">[],</span><br/><span class="hl-1">  </span><span class="hl-5">createdAt</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">job</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">idemKey</span><span class="hl-1">: </span><span class="hl-5">string</span><br/><span class="hl-1">][]</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><code>id</code>        - Redis stream entry ID (e.g. <code>&quot;1699780000000-0&quot;</code>).</li>
<li><code>payload</code>   - Parsed/decoded payload passed later into <a href="#onexecute" class="tsd-kind-method">onExecute</a>.</li>
<li><code>createdAt</code> - Unix timestamp (in ms) when the task was originally created.</li>
<li><code>job</code>       - Job/batch identifier used for grouping and metrics.</li>
<li><code>idemKey</code>   - Idempotency key (empty string if not set); used by
<a href="#idempotency" class="tsd-kind-method">idempotency</a> to ensure only one execution per key.</li>
</ul>
<h3 id="usage-1" class="tsd-anchor-link">Usage<a href="#usage-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You normally do <strong>not</strong> call this method directly. It is used internally by
<a href="#consumerloop" class="tsd-kind-method">consumerLoop</a>:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">tasks</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">select</span><span class="hl-1">();</span><br/><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-0">isArrFilled</span><span class="hl-1">(</span><span class="hl-5">tasks</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-0">wait</span><span class="hl-1">(</span><span class="hl-7">600</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-6">continue</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">ids</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-5">tasks</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-symbol">[</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">]</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise that resolves to a normalized list of tasks ready to be passed into
<a href="#execute" class="tsd-kind-method">execute</a>. If no tasks are available (neither stuck nor fresh), an
empty array is returned.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4100">PowerQueues.ts:4100</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="selectfresh"><code class="tsd-tag">Private</code><span>select<wbr/>Fresh</span><a href="#selectfresh" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="selectfresh-1"><span class="tsd-kind-call-signature">selectFresh</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#selectfresh-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Reads <strong>fresh (new) tasks</strong> from the Redis stream using <code>XREADGROUP</code>.</p>
<p>This method is called after <a href="#selectstuck" class="tsd-kind-method">selectStuck</a> when no stuck/pending
messages are available. It focuses only on messages that have <strong>never</strong>
been delivered to any consumer in the group before.</p>
<p>Internally it issues a blocking <code>XREADGROUP</code> command:</p>
<pre><code class="bash"><span class="hl-0">XREADGROUP</span><span class="hl-1"> </span><span class="hl-2">GROUP</span><span class="hl-1"> </span><span class="hl-2">{group}</span><span class="hl-1"> </span><span class="hl-2">{consumer}</span><br/><span class="hl-1">  </span><span class="hl-0">BLOCK</span><span class="hl-1"> </span><span class="hl-2">{blockMs}</span><br/><span class="hl-1">  </span><span class="hl-0">COUNT</span><span class="hl-1"> </span><span class="hl-2">{batchSize}</span><br/><span class="hl-1">  </span><span class="hl-0">STREAMS</span><span class="hl-1"> </span><span class="hl-2">{stream}</span><span class="hl-1"> &gt;</span>
</code><button type="button">Copy</button></pre>

<ul>
<li><code>GROUP {group} {consumer}</code> - reads messages on behalf of the current
consumer in the configured group.</li>
<li><code>BLOCK {blockMs}</code> - waits up to <code>blockMs</code> milliseconds for new messages.
<ul>
<li><code>blockMs</code> is derived from <code>workerLoopIntervalMs</code> (with a minimum of 2ms).</li>
</ul>
</li>
<li><code>COUNT {batchSize}</code> - at most <code>workerBatchTasksCount</code> messages will be
returned in a single call.</li>
<li><code>STREAMS {stream} &gt;</code> - the special ID <code>&gt;</code> means:
&quot;Give me only <strong>new</strong> messages that have not been delivered before&quot;.</li>
</ul>
<h3 id="returned-data" class="tsd-anchor-link">Returned data<a href="#returned-data" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The raw Redis response structure is simplified to:</p>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">res</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-0">xreadgroup</span><span class="hl-1">(...);</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">entries</span><span class="hl-1"> = </span><span class="hl-5">res</span><span class="hl-1">?.[</span><span class="hl-7">0</span><span class="hl-1">]?.[</span><span class="hl-7">1</span><span class="hl-1">] ?? [];</span>
</code><button type="button">Copy</button></pre>

<p>So this method returns:</p>
<pre><code class="ts"><span class="hl-1">[</span><br/><span class="hl-1">  [ </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1"> | </span><span class="hl-5">Buffer</span><span class="hl-1">, [ </span><span class="hl-5">field1</span><span class="hl-1">, </span><span class="hl-5">value1</span><span class="hl-1">, </span><span class="hl-5">field2</span><span class="hl-1">, </span><span class="hl-5">value2</span><span class="hl-1">, ... ] ],</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>These entries are later transformed into normalized task tuples by
<a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a> inside <a href="#select" class="tsd-kind-method">select</a>.</p>
<p>If Redis returns no messages within the blocking timeout, or the array
is empty, this method resolves to an empty array.</p>
<h3 id="error-handling-2" class="tsd-anchor-link">Error handling<a href="#error-handling-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>If Redis returns a <code>NOGROUP</code> error (consumer group does not exist yet):
<ul>
<li>It calls <a href="#creategroup" class="tsd-kind-method">createGroup</a> to create the group safely.</li>
<li>Returns an empty array so the worker can retry on the next loop.</li>
</ul>
</li>
<li>Other errors are not specially handled here and will bubble up in
the calling code if needed.</li>
</ul>
<h3 id="typical-usage-indirect" class="tsd-anchor-link">Typical usage (indirect)<a href="#typical-usage-indirect" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You usually do not call this directly. Instead, it is used from <a href="#select" class="tsd-kind-method">select</a>:</p>
<pre><code class="ts"><span class="hl-3">let</span><span class="hl-1"> </span><span class="hl-5">entries</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">selectStuck</span><span class="hl-1">();</span><br/><br/><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-0">isArrFilled</span><span class="hl-1">(</span><span class="hl-5">entries</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-5">entries</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">selectFresh</span><span class="hl-1">();</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">normalizeEntries</span><span class="hl-1">(</span><span class="hl-5">entries</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise that resolves to an array of raw Redis entries representing
<strong>newly delivered</strong> tasks for this consumer group.<br>
If there are no new messages or the group had to be created, an empty
array is returned.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4292">PowerQueues.ts:4292</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="selectstuck"><code class="tsd-tag">Private</code><span>select<wbr/>Stuck</span><a href="#selectstuck" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="selectstuck-1"><span class="tsd-kind-call-signature">selectStuck</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#selectstuck-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Attempts to recover <strong>stuck (pending) tasks</strong> from the Redis stream.</p>
<p>A &quot;stuck&quot; task is a message that:</p>
<ul>
<li>was previously delivered to some consumer in the group,</li>
<li>but was <strong>not acknowledged</strong> (XACK) within a reasonable time,</li>
<li>typically because a worker crashed, froze, or exceeded its processing time.</li>
</ul>
<p>This method uses the Lua script <a href="../variables/SelectStuck.html" class="tsd-kind-variable">SelectStuck</a> (via <a href="#runscript" class="tsd-kind-method">runScript</a>),
which combines:</p>
<ul>
<li><code>XAUTOCLAIM</code> to fetch pending messages that have been idle for too long<br>
(defined by <code>recoveryStuckTasksTimeoutMs</code>),</li>
<li>a <strong>time budget</strong> to avoid blocking the worker for too long,</li>
<li>a fallback <code>XREADGROUP</code> step inside the script to fill any remaining capacity.</li>
</ul>
<p>It returns raw Redis entries, which will later be normalized by
<a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a>.</p>
<hr>
<h3 id="what-the-lua-script-does-high-level" class="tsd-anchor-link">What the Lua script does (high-level)<a href="#what-the-lua-script-does-high-level" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ol>
<li>
<p>Uses <code>XAUTOCLAIM</code> in a loop:</p>
<ul>
<li>Claims pending messages whose idle time ≥ <code>pendingIdleMs</code>
(mapped from <code>this.recoveryStuckTasksTimeoutMs</code>).</li>
<li>Accumulates up to <code>count</code> entries (mapped from <code>workerBatchTasksCount</code>).</li>
<li>Stops when:
<ul>
<li>enough entries are collected, or</li>
<li>the internal <strong>time budget</strong> (<code>workerSelectionTimeoutMs</code>) is exceeded.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>If the script still has room to fetch more tasks:</p>
<ul>
<li>It calls <code>XREADGROUP</code> with <code>&gt;</code> to read <strong>new</strong> messages up to the remaining
slot count.</li>
<li>This ensures the worker always gets some work even if there are not
enough stuck tasks.</li>
</ul>
</li>
<li>
<p>Returns a plain Lua array of stream entries in the format Redis uses for
<code>XREADGROUP</code> / <code>XAUTOCLAIM</code>.</p>
</li>
</ol>
<hr>
<h3 id="why-recovering-stuck-tasks-first" class="tsd-anchor-link">Why recovering stuck tasks first?<a href="#why-recovering-stuck-tasks-first" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Processing stuck tasks before fresh tasks ensures:</p>
<ul>
<li><strong>At-least-once delivery</strong> is maintained,</li>
<li>No task stays in &quot;pending&quot; state forever,</li>
<li>The queue self-heals from worker crashes and unpredictable failures,</li>
<li>Dead letter queue (DLQ) fallback paths can be consistently enforced.</li>
</ul>
<hr>
<h3 id="error-handling-3" class="tsd-anchor-link">Error handling<a href="#error-handling-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If Redis responds with <code>NOGROUP</code> (meaning the consumer group does not exist),
the method:</p>
<ol>
<li>Calls <a href="#creategroup" class="tsd-kind-method">createGroup</a> to create the group safely,</li>
<li>Returns an empty list so the worker can retry on the next iteration.</li>
</ol>
<p>Any other error is swallowed only inside the Lua script execution; unexpected
errors from Redis outside of <code>NOGROUP</code> should be considered real failures.</p>
<hr>
<h3 id="return-format" class="tsd-anchor-link">Return format<a href="#return-format" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Returns an array of raw Redis entries:</p>
<pre><code class="ts"><span class="hl-1">[ [</span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">rawKeyValues</span><span class="hl-1">: (</span><span class="hl-5">string</span><span class="hl-1"> | </span><span class="hl-5">Buffer</span><span class="hl-1">)[]], ... ]</span>
</code><button type="button">Copy</button></pre>

<p>These entries will later be decoded into:</p>
<pre><code class="ts"><span class="hl-1">[ </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">idemKey</span><span class="hl-1"> ]</span>
</code><button type="button">Copy</button></pre>

<p>by <a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a>.</p>
<hr>
<h3 id="typical-usage-indirect-1" class="tsd-anchor-link">Typical usage (indirect)<a href="#typical-usage-indirect-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">stuck</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">selectStuck</span><span class="hl-1">();</span><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-0">isArrFilled</span><span class="hl-1">(</span><span class="hl-5">stuck</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">normalizeEntries</span><span class="hl-1">(</span><span class="hl-5">stuck</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-9">// otherwise selectFresh() will be used</span>
</code><button type="button">Copy</button></pre>

</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><p>Raw Redis entries representing reclaimed pending tasks.<br>
If no pending entries can be reclaimed, an empty array is returned.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4201">PowerQueues.ts:4201</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="sendheartbeat"><code class="tsd-tag">Private</code><span>send<wbr/>Heartbeat</span><a href="#sendheartbeat" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="sendheartbeat-1"><span class="tsd-kind-call-signature">sendHeartbeat</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">keys</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type external">IdempotencyKeys</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">&gt;</span><a href="#sendheartbeat-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Sends a single <strong>heartbeat</strong> to Redis for an idempotent task.</p>
<p>This method <strong>extends the TTL</strong> (time-to-live) of the idempotency keys
so that long-running jobs are not considered &quot;stuck&quot; and do not lose
their ownership while still actively processing.</p>
<p>Internally it calls <code>PEXPIRE</code> on:</p>
<ul>
<li><code>keys.lockKey</code>  - lock owner marker for the current worker.</li>
<li><code>keys.startKey</code> - marker that indicates processing has started.</li>
</ul>
<p>Both keys are extended by <code>workerExecuteLockTimeoutMs</code> milliseconds.</p>
<h3 id="why-this-matters-2" class="tsd-anchor-link">Why this matters<a href="#why-this-matters-2" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Without heartbeats, a long-running job could:</p>
<ul>
<li>Exceed the original lock TTL,</li>
<li>Have its lock key expire,</li>
<li>Allow another worker to acquire the same idempotency key,</li>
<li>Result in <strong>duplicate execution</strong> of the same logical operation.</li>
</ul>
<p>By periodically calling <a href="#sendheartbeat" class="tsd-kind-method">sendHeartbeat</a> (via <a href="#heartbeat" class="tsd-kind-method">heartbeat</a>):</p>
<ul>
<li>The lock and start markers stay alive as long as the worker is alive,</li>
<li>Other workers know that this task is still being processed,</li>
<li>The queue maintains <strong>stronger idempotency guarantees</strong> even for
slow operations.</li>
</ul>
<h3 id="return-value-4" class="tsd-anchor-link">Return value<a href="#return-value-4" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Returns <code>true</code> if <strong>at least one</strong> of the keys (<code>lockKey</code> or <code>startKey</code>)
had its TTL successfully updated (<code>PEXPIRE</code> returned <code>1</code>).</li>
<li>Returns <code>false</code> if:
<ul>
<li>Both keys failed to update (no key existed or Redis returned <code>0</code>), or</li>
<li>An error occurred while talking to Redis.</li>
</ul>
</li>
</ul>
<p>The <a href="#heartbeat" class="tsd-kind-method">heartbeat</a> loop uses this value to detect when heartbeats are
failing repeatedly and eventually stops sending them (considering the lock
effectively lost).</p>
<h3 id="typical-usage" class="tsd-anchor-link">Typical usage<a href="#typical-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>You do not call this directly in user code. It is used internally by
<a href="#heartbeat" class="tsd-kind-method">heartbeat</a>, which manages:</p>
<ul>
<li>The repeat interval,</li>
<li>Failure counting,</li>
<li>Stopping conditions when too many heartbeats fail.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">keys</span>: <span class="tsd-signature-type external">IdempotencyKeys</span></span><div class="tsd-comment tsd-typography"><p>A set of idempotency keys produced by <a href="#idempotencykeys" class="tsd-kind-method">idempotencyKeys</a>.<br>
Only <code>lockKey</code> and <code>startKey</code> are used here; both are refreshed with
<code>workerExecuteLockTimeoutMs</code> as their new TTL.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">boolean</span><span class="tsd-signature-symbol">&gt;</span></h4><p><code>true</code> if at least one key was successfully refreshed, otherwise <code>false</code>.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4486">PowerQueues.ts:4486</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="signal"><code class="tsd-tag">Private</code><span>signal</span><a href="#signal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="signal-1"><span class="tsd-kind-call-signature">signal</span><span class="tsd-signature-symbol">()</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">AbortSignal</span><a href="#signal-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Returns the <strong>AbortSignal</strong> associated with this queue instance.</p>
<p>The signal comes from the internal AbortController stored in
<code>this.abort</code>, and is used throughout the worker lifecycle to support
<strong>graceful shutdown</strong>, <strong>interruptible waits</strong>, and <strong>cleanup</strong> logic.</p>
<h3 id="why-this-exists" class="tsd-anchor-link">Why this exists<a href="#why-this-exists" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Many internal operations - such as <a href="#waitabortable" class="tsd-kind-method">waitAbortable</a>, <a href="#heartbeat" class="tsd-kind-method">heartbeat</a>,
and the main <a href="#consumerloop" class="tsd-kind-method">consumerLoop</a> - need a way to stop immediately when
the queue is shutting down. Using a shared abort signal allows:</p>
<ul>
<li>Breaking out of sleeps or backoff delays,</li>
<li>Cancelling heartbeat timers,</li>
<li>Stopping worker loops,</li>
<li>Cleaning up pending timers or event listeners.</li>
</ul>
<p>This avoids scenarios where the worker keeps retrying or waiting even after
shutdown has been requested.</p>
<h3 id="how-it-is-used-1" class="tsd-anchor-link">How it is used<a href="#how-it-is-used-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li><strong>waitAbortable</strong> subscribes to <code>signal.abort</code> to wake up early:</li>
</ul>
<pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">signal</span><span class="hl-1">();</span><br/><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-5">signal</span><span class="hl-1">.</span><span class="hl-5">aborted</span><span class="hl-1">) </span><span class="hl-6">return</span><span class="hl-1">;</span><br/><span class="hl-5">signal</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&#39;abort&#39;</span><span class="hl-1">, () </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-0">resolve</span><span class="hl-1">());</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>
<p><strong>heartbeat</strong> stops sending TTL-refreshing heartbeats when the signal fires.</p>
</li>
<li>
<p><strong>consumerLoop</strong> checks <code>signal.aborted</code> to know when to exit its main loop.</p>
</li>
<li>
<p>External code can trigger shutdown via:</p>
</li>
</ul>
<pre><code class="ts"><span class="hl-5">queues</span><span class="hl-1">.</span><span class="hl-5">abort</span><span class="hl-1">.</span><span class="hl-0">abort</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p>which immediately propagates to all internal listeners.</p>
<h3 id="example-43" class="tsd-anchor-link">Example<a href="#example-43" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">q</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">PowerQueues</span><span class="hl-1">();</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">signal</span><span class="hl-1"> = </span><span class="hl-5">q</span><span class="hl-1">.</span><span class="hl-0">signal</span><span class="hl-1">();</span><br/><br/><span class="hl-5">signal</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&#39;abort&#39;</span><span class="hl-1">, () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;Queue shutdown started&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-9">// Later…</span><br/><span class="hl-5">q</span><span class="hl-1">.</span><span class="hl-5">abort</span><span class="hl-1">.</span><span class="hl-0">abort</span><span class="hl-1">(); </span><span class="hl-9">// triggers all waiting operations to stop</span>
</code><button type="button">Copy</button></pre>

<h3 id="returns" class="tsd-anchor-link">Returns<a href="#returns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The active <code>AbortSignal</code> associated with this queue's lifecycle.</p>
</div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">AbortSignal</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4988">PowerQueues.ts:4988</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="success"><code class="tsd-tag">Private</code><span>success</span><a href="#success" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="success-1"><span class="tsd-kind-call-signature">success</span><span class="tsd-signature-symbol">(</span><br/>    <span class="tsd-kind-parameter">id</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">payload</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">createdAt</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">job</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/>    <span class="tsd-kind-parameter">key</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span><br/><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#success-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Marks a task as <strong>successfully executed</strong> and triggers success-related hooks
and optional execution-status bookkeeping.</p>
<p>This method is called <strong>after <code>onExecute</code> completes without throwing</strong>.
It is the final step in the normal (non-error) execution path for a task.</p>
<hr>
<h2 id="what-this-method-does-3" class="tsd-anchor-link">What this method does<a href="#what-this-method-does-3" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="1-updates-execution-status-counters-optional-1" class="tsd-anchor-link">1. Updates execution-status counters (optional)<a href="#1-updates-execution-status-counters-optional-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>If <a href="#executejobstatus" class="tsd-kind-property">executeJobStatus</a> is enabled, this method increments two counters:</p>
<ul>
<li>
<p><code>&lt;stream&gt;:&lt;job&gt;:ok</code><br>
→ number of successfully completed tasks for this job</p>
</li>
<li>
<p><code>&lt;stream&gt;:&lt;job&gt;:ready</code><br>
→ number of tasks that have finished (both success and failure)</p>
</li>
</ul>
<p>Both counters expire automatically based on:</p>
<ul>
<li><a href="#executejobstatusttlms" class="tsd-kind-property">executeJobStatusTtlMs</a> (default: 5 minutes)</li>
</ul>
<p>These counters allow users to:</p>
<ul>
<li>monitor job progress in real time,</li>
<li>implement dashboards,</li>
<li>detect stuck jobs where <code>ready</code> &lt; <code>total</code>.</li>
</ul>
<pre><code class="ts"><span class="hl-5">prefix</span><span class="hl-1"> = </span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-3">this</span><span class="hl-11">.</span><span class="hl-5">stream</span><span class="hl-3">}</span><span class="hl-2">:</span><span class="hl-3">${</span><span class="hl-5">job</span><span class="hl-3">}</span><span class="hl-2">:`</span><span class="hl-1">;</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">incr</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-5">prefix</span><span class="hl-3">}</span><span class="hl-2">ok`</span><span class="hl-1">,    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">executeJobStatusTtlMs</span><span class="hl-1">);</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">incr</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-3">${</span><span class="hl-5">prefix</span><span class="hl-3">}</span><span class="hl-2">ready`</span><span class="hl-1">, </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-5">executeJobStatusTtlMs</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="2-calls-the-user-hook-onsuccess" class="tsd-anchor-link">2. Calls the user hook <a href="#onsuccess" class="tsd-kind-method">onSuccess</a><a href="#2-calls-the-user-hook-onsuccess" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>This hook is intended for:</p>
<ul>
<li>logging,</li>
<li>emitting events,</li>
<li>performing follow-up actions (e.g., notifying external systems),</li>
<li>metrics.</li>
</ul>
<pre><code class="ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">onSuccess</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-5">key</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>The hook receives:</p>
<ul>
<li><code>id</code>        - Redis stream entry ID</li>
<li><code>payload</code>   - parsed payload</li>
<li><code>createdAt</code> - timestamp (ms) extracted from the stream</li>
<li><code>job</code>       - batch/job identifier</li>
<li><code>key</code>       - idempotency key (empty string if not used)</li>
</ul>
<hr>
<h2 id="when-this-method-is-triggered" class="tsd-anchor-link">When this method is triggered<a href="#when-this-method-is-triggered" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>After each successful execution inside <a href="#executeprocess" class="tsd-kind-method">executeProcess</a>.</li>
<li>Also used in the idempotent execution path inside <a href="#idempotency" class="tsd-kind-method">idempotency</a>.</li>
</ul>
<hr>
<h2 id="error-handling-4" class="tsd-anchor-link">Error handling<a href="#error-handling-4" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Errors inside <code>success()</code> <strong>do not block</strong> task acknowledgment.</li>
<li>Failures inside the user hook <code>onSuccess</code> are <em>not thrown upward</em> -
this method assumes success handling should not affect the queue's flow.</li>
</ul>
<hr>
<h2 id="example-44" class="tsd-anchor-link">Example<a href="#example-44" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-9">// Custom business logic</span><br/><span class="hl-5">async</span><span class="hl-1"> </span><span class="hl-0">onSuccess</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Task completed:&quot;</span><span class="hl-1">, </span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-9">// Internally, after onExecute succeeds:</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">success</span><span class="hl-1">(</span><span class="hl-5">id</span><span class="hl-1">, </span><span class="hl-5">payload</span><span class="hl-1">, </span><span class="hl-5">createdAt</span><span class="hl-1">, </span><span class="hl-5">job</span><span class="hl-1">, </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">id</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis stream entry ID</p>
</div></li><li><span><span class="tsd-kind-parameter">payload</span>: <span class="tsd-signature-type">any</span></span><div class="tsd-comment tsd-typography"><p>Task payload object (already decoded if JSON)</p>
</div></li><li><span><span class="tsd-kind-parameter">createdAt</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Task creation timestamp (ms)</p>
</div></li><li><span><span class="tsd-kind-parameter">job</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Job/batch ID assigned in <a href="#addtasks" class="tsd-kind-method">addTasks</a></p>
</div></li><li><span><span class="tsd-kind-parameter">key</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Idempotency key (empty string if not used)</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2801">PowerQueues.ts:2801</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="values"><code class="tsd-tag">Private</code><span>values</span><a href="#values" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="values-1"><span class="tsd-kind-call-signature">values</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">value</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">any</span><a href="#values-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Converts a flat Redis key/value array into a plain JavaScript object.</p>
<p>Redis stream entries store their fields as a flat array:</p>
<pre><code class="ts"><span class="hl-1">[</span><span class="hl-2">&quot;field1&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;value1&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;field2&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;value2&quot;</span><span class="hl-1">, ...]</span>
</code><button type="button">Copy</button></pre>

<p>This helper turns that into:</p>
<pre><code class="ts"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">field1</span><span class="hl-1">: </span><span class="hl-2">&quot;value1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">field2</span><span class="hl-1">: </span><span class="hl-2">&quot;value2&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  ...</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>It is intentionally minimal - no type conversion or parsing is performed
here. All values remain raw strings unless later processed by higher-level
methods such as:</p>
<ul>
<li><a href="#payload" class="tsd-kind-method">payload</a> - which tries to JSON-decode the <code>&quot;payload&quot;</code> field,</li>
<li><a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a> - which extracts <code>createdAt</code>, <code>job</code>, <code>idemKey</code>, etc.</li>
</ul>
<hr>
<h3 id="how-it-works-5" class="tsd-anchor-link">How it works<a href="#how-it-works-5" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Iterates through the array in steps of <strong>2</strong>.</li>
<li>Treats each pair <code>[key, value]</code> as a property on the resulting object.</li>
<li>If the array length is odd (should not happen in valid Redis entries),
the last dangling element is ignored.</li>
<li>Keys and values are used <strong>as-is</strong> (already converted to strings earlier).</li>
</ul>
<hr>
<h3 id="example-45" class="tsd-anchor-link">Example<a href="#example-45" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Input:</p>
<pre><code class="ts"><span class="hl-1">[</span><span class="hl-2">&quot;payload&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;{</span><span class="hl-12">\&quot;</span><span class="hl-2">x</span><span class="hl-12">\&quot;</span><span class="hl-2">:123}&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;createdAt&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;1700000000000&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;job&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;abc&quot;</span><span class="hl-1">]</span>
</code><button type="button">Copy</button></pre>

<p>Output:</p>
<pre><code class="ts"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">payload</span><span class="hl-1">: </span><span class="hl-2">&quot;{</span><span class="hl-12">\&quot;</span><span class="hl-2">x</span><span class="hl-12">\&quot;</span><span class="hl-2">:123}&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">createdAt</span><span class="hl-1">: </span><span class="hl-2">&quot;1700000000000&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">job</span><span class="hl-1">: </span><span class="hl-2">&quot;abc&quot;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The returned object is then passed to <a href="#normalizeentries" class="tsd-kind-method">normalizeEntries</a> which:</p>
<ul>
<li>Parses <code>payload</code>,</li>
<li>Converts <code>createdAt</code> to a number,</li>
<li>Extracts <code>job</code> and <code>idemKey</code>,</li>
<li>Builds a normalized worker task tuple.</li>
</ul>
<hr>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">value</span>: <span class="tsd-signature-type">any</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Flat array of alternating key/value items from Redis.
This is typically the <code>entry[1]</code> part of an <code>XREADGROUP</code> response.</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">any</span></h4><p>A simple object containing the extracted field/value mappings.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4838">PowerQueues.ts:4838</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="waitabortable"><code class="tsd-tag">Private</code><span>wait<wbr/>Abortable</span><a href="#waitabortable" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="waitabortable-1"><span class="tsd-kind-call-signature">waitAbortable</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">ttl</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">number</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span><a href="#waitabortable-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Sleeps for a short, <strong>abortable</strong> delay with a bit of random jitter.</p>
<p>This is a small helper used mainly when the worker needs to <strong>back off</strong>
for a while, but should also be able to stop quickly when the queue
is shutting down (via <a href="#abort" class="tsd-kind-property">abort</a> / <a href="#signal" class="tsd-kind-method">signal</a>).</p>
<p>The returned promise resolves in two cases:</p>
<ol>
<li><strong>Timeout finished</strong> - normal delay elapsed.</li>
<li><strong>Abort signal fired</strong> - if <code>this.abort.abort()</code> was called, the wait
is cancelled early and the promise resolves immediately.</li>
</ol>
<h3 id="how-the-delay-is-calculated" class="tsd-anchor-link">How the delay is calculated<a href="#how-the-delay-is-calculated" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>ttl</code> argument usually comes from Redis <code>PTTL</code> (remaining time-to-live
of some key) and is used to choose a reasonable wait duration:</p>
<ul>
<li>
<p>If <code>ttl &gt; 0</code>:</p>
<ul>
<li><code>base</code> = <code>clamp(ttl, 25ms, 5000ms)</code> - so we never sleep less than 25ms
and never longer than 5s in one call.</li>
<li><code>jitter</code> = random number between <code>0</code> and <code>min(base, 200ms)</code>.</li>
<li><code>delay</code> = <code>base + jitter</code>.</li>
<li>This avoids a &quot;thundering herd&quot; effect where many workers wake up at exactly
the same time, spreading their retries slightly.</li>
</ul>
</li>
<li>
<p>If <code>ttl &lt;= 0</code>:</p>
<ul>
<li><code>delay</code> is a small random value between <strong>5ms and 20ms</strong>.</li>
<li>This is a generic short backoff when we do not have a meaningful TTL.</li>
</ul>
</li>
</ul>
<p>The timer handle is <code>unref()</code>-ed when available (Node.js), which means:</p>
<ul>
<li>The presence of this timeout <strong>will not keep the process alive</strong> if
there is nothing else preventing it from exiting.</li>
</ul>
<h3 id="abort-behaviour" class="tsd-anchor-link">Abort behaviour<a href="#abort-behaviour" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>
<ul>
<li>The method subscribes to the current AbortController signal via
<a href="#signal" class="tsd-kind-method">signal</a>.</li>
</ul>
</li>
</ul>
<ul>
<li>If the signal is already aborted, it resolves <strong>immediately</strong>.</li>
<li>If the signal is aborted during the delay:
<ul>
<li>It clears the timeout,</li>
<li>Removes the event listener,</li>
<li>Resolves the promise.</li>
</ul>
</li>
</ul>
<p>This allows the worker loop to stop quickly even if it is currently
in a waiting period.</p>
<h3 id="typical-usage-1" class="tsd-anchor-link">Typical usage<a href="#typical-usage-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>After detecting idempotency contention (<code>allow === 0</code> in <a href="#idempotency" class="tsd-kind-method">idempotency</a>),
to wait until another worker finishes:</li>
</ul>
<pre><code class="ts"><span class="hl-9">// ttl comes from PTTL(startKey) or a similar source</span><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">waitAbortable</span><span class="hl-1">(</span><span class="hl-5">ttl</span><span class="hl-1">);</span><br/><span class="hl-6">return</span><span class="hl-1"> { </span><span class="hl-5">contended:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1"> };</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>After seeing many contended tasks in <a href="#execute" class="tsd-kind-method">execute</a>, to briefly pause
before polling again:</li>
</ul>
<pre><code class="ts"><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-0">isArrFilled</span><span class="hl-1">(</span><span class="hl-5">result</span><span class="hl-1">) &amp;&amp; </span><span class="hl-5">contended</span><span class="hl-1"> &gt; (</span><span class="hl-5">tasks</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> &gt;&gt; </span><span class="hl-7">1</span><span class="hl-1">)) {</span><br/><span class="hl-1">  </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">waitAbortable</span><span class="hl-1">(</span><span class="hl-5">dynamicDelay</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">ttl</span>: <span class="tsd-signature-type">number</span></span><div class="tsd-comment tsd-typography"><p>Suggested time-to-wait in milliseconds:</p>
<ul>
<li>If <code>ttl &gt; 0</code>, it is used to derive the base delay (clamped between 25ms and 5000ms)
plus some jitter.</li>
<li>If <code>ttl &lt;= 0</code>, a small default delay (5-20ms) is used instead.</li>
</ul>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">void</span><span class="tsd-signature-symbol">&gt;</span></h4><p>A promise that resolves when the delay has elapsed or when the
current abort signal is triggered.</p>
<aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L4393">PowerQueues.ts:4393</a></li></ul></aside></div></li></ul></section><section class="tsd-panel tsd-member tsd-is-private"><h3 class="tsd-anchor-link" id="xaddbatch"><code class="tsd-tag">Private</code><span>xadd<wbr/>Batch</span><a href="#xaddbatch" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><ul class="tsd-signatures tsd-is-private"><li class=""><div class="tsd-signature tsd-anchor-link" id="xaddbatch-1"><span class="tsd-kind-call-signature">xaddBatch</span><span class="tsd-signature-symbol">(</span><span class="tsd-kind-parameter">queueName</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">,</span> <span class="tsd-signature-symbol">...</span><span class="tsd-kind-parameter">batches</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">)</span><span class="tsd-signature-symbol">:</span> <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span><a href="#xaddbatch-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></div><div class="tsd-description"><div class="tsd-comment tsd-typography"><p>Low-level helper that sends a <strong>single batch</strong> of tasks to Redis Stream
using the <code>XAddBulk</code> Lua script.</p>
<p>In most cases you do <strong>not</strong> call this method directly.<br>
Instead, you use the higher-level <code>addTasks()</code> API, which:</p>
<ul>
<li>builds <code>Task</code> objects,</li>
<li>splits them into batches (<code>buildBatches()</code>),</li>
<li>converts each batch into <code>batches</code> arguments via <code>payloadBatch()</code>,</li>
<li>and finally calls <code>xaddBatch()</code> for each batch.</li>
</ul>
<p>Behaviour:</p>
<ul>
<li>Calls <code>runScript('XAddBulk', [queueName], batches, XAddBulk)</code>.</li>
<li><code>queueName</code> becomes <code>KEYS[1]</code> inside the Lua script.</li>
<li><code>batches</code> array is passed as <code>ARGV</code> (already prepared by <code>payloadBatch()</code>).</li>
<li>Returns the array of created Stream entry IDs for this batch.</li>
</ul>
<p>Expected <code>batches</code> format (simplified):</p>
<ul>
<li><code>payloadBatch()</code> produces a flat list of strings:
<ul>
<li>global options (maxlen, approx/exact, minidWindowMs, etc.),</li>
<li>followed by repeated blocks:
<ul>
<li><code>&lt;id&gt;</code>, <code>&lt;num_pairs&gt;</code>, <code>&lt;field1&gt;</code>, <code>&lt;value1&gt;</code>, ..., <code>&lt;fieldN&gt;</code>, <code>&lt;valueN&gt;</code>.</li>
</ul>
</li>
</ul>
</li>
<li>The <code>XAddBulk</code> script interprets these values and performs multiple <code>XADD</code>
operations in a tight loop, optionally with trimming.</li>
</ul>
<p>Important:</p>
<ul>
<li><code>queueName</code> must be the <strong>Redis Stream key</strong> where tasks should be added.</li>
<li><code>batches</code> must be generated by <code>payloadBatch()</code> or follow the same contract.</li>
<li>If you pass an incorrect ARGV format, the Lua script may fail or behave
unexpectedly.</li>
</ul>
</div><div class="tsd-parameters"><h4 class="tsd-parameters-title">Parameters</h4><ul class="tsd-parameter-list"><li><span><span class="tsd-kind-parameter">queueName</span>: <span class="tsd-signature-type">string</span></span><div class="tsd-comment tsd-typography"><p>Redis Stream key used as the queue name.</p>
</div></li><li><span><span class="tsd-signature-symbol">...</span><span class="tsd-kind-parameter">batches</span>: <span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span></span><div class="tsd-comment tsd-typography"><p>Flat list of arguments for the <code>XAddBulk</code> Lua script
(usually produced by <code>payloadBatch()</code>).</p>
</div></li></ul></div><h4 class="tsd-returns-title">Returns <span class="tsd-signature-type">Promise</span><span class="tsd-signature-symbol">&lt;</span><span class="tsd-signature-type">string</span><span class="tsd-signature-symbol">[]</span><span class="tsd-signature-symbol">&gt;</span></h4><p>Promise resolving to an array of Redis Stream IDs created by this batch.</p>
<div class="tsd-comment tsd-typography"><div class="tsd-tag-example"><h4 class="tsd-anchor-link" id="example-46">Example<a href="#example-46" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="ts"><span class="hl-9">// Typical internal usage (simplified from addTasks):</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">argv</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">payloadBatch</span><span class="hl-1">(</span><span class="hl-5">batchTasks</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">);</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-4">ids</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">xaddBatch</span><span class="hl-1">(</span><span class="hl-2">&#39;my:stream&#39;</span><span class="hl-1">, ...</span><span class="hl-5">argv</span><span class="hl-1">);</span><br/><span class="hl-9">// &quot;ids&quot; now contains one XADD ID per task in this batch</span>
</code><button type="button">Copy</button></pre>

</div></div><aside class="tsd-sources"><ul><li>Defined in <a href="https://github.com/ihor-bielchenko/power-queues/blob/042b7622524484447243ddf0e3aa381cdbb4ef41/src/PowerQueues.ts#L2029">PowerQueues.ts:2029</a></li></ul></aside></div></li></ul></section></section></details></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-private" name="private" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Private</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><details open class="tsd-accordion tsd-page-navigation-section"><summary class="tsd-accordion-summary" data-key="section-Constructors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Constructors</summary><div><a href="#constructor"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Constructor"><use href="../assets/icons.svg#icon-512"></use></svg><span>constructor</span></a></div></details><details open class="tsd-accordion tsd-page-navigation-section"><summary class="tsd-accordion-summary" data-key="section-Properties"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Properties</summary><div><a href="#abort"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>abort</span></a><a href="#addingbatchkeyslimit"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>adding<wbr/>Batch<wbr/>Keys<wbr/>Limit</span></a><a href="#addingbatchtaskscount"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>adding<wbr/>Batch<wbr/>Tasks<wbr/>Count</span></a><a href="#approvebatchtaskscount"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>approve<wbr/>Batch<wbr/>Tasks<wbr/>Count</span></a><a href="#consumerhost"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>consumer<wbr/>Host</span></a><a href="#executebatchatonce"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>execute<wbr/>Batch<wbr/>At<wbr/>Once</span></a><a href="#executejobstatus"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>execute<wbr/>Job<wbr/>Status</span></a><a href="#executejobstatusttlms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>execute<wbr/>Job<wbr/>Status<wbr/>Ttl<wbr/>Ms</span></a><a href="#group"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>group</span></a><a href="#recoverystucktaskstimeoutms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>recovery<wbr/>Stuck<wbr/>Tasks<wbr/>Timeout<wbr/>Ms</span></a><a href="#redis"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>redis</span></a><a href="#removeonexecuted"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>remove<wbr/>On<wbr/>Executed</span></a><a href="#scripts"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>scripts</span></a><a href="#stream"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>stream</span></a><a href="#workerbatchtaskscount"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Batch<wbr/>Tasks<wbr/>Count</span></a><a href="#workercachetasktimeoutms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Cache<wbr/>Task<wbr/>Timeout<wbr/>Ms</span></a><ul><li><ul><li><ul><li><a href="#what-this-timeout-does"><span>What this timeout does</span></a></li><li><a href="#why-it-exists"><span>Why it exists</span></a></li><li><a href="#best-practices"><span>Best practices</span></a></li></ul></li></ul></li></ul><a href="#workerclearattemptstimeoutms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Clear<wbr/>Attempts<wbr/>Timeout<wbr/>Ms</span></a><a href="#workerexecutelocktimeoutms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Execute<wbr/>Lock<wbr/>Timeout<wbr/>Ms</span></a><a href="#workerloopintervalms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Loop<wbr/>Interval<wbr/>Ms</span></a><a href="#workermaxretries"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Max<wbr/>Retries</span></a><a href="#workerselectiontimeoutms"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Property"><use href="../assets/icons.svg#icon-1024"></use></svg><span>worker<wbr/>Selection<wbr/>Timeout<wbr/>Ms</span></a></div></details><details open class="tsd-accordion tsd-page-navigation-section"><summary class="tsd-accordion-summary" data-key="section-Methods"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Methods</summary><div><a href="#addtasks"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>add<wbr/>Tasks</span></a><ul><li><ul><li><ul><li><a href="#input-data-format"><span>Input data format</span></a></li><li><a href="#trimming-stream-options-"><span>Trimming &amp; stream options ()</span></a></li><li><a href="#status-tracking-"><span>Status tracking ()</span></a></li><li><a href="#idempotency-helper-"><span>Idempotency helper ()</span></a></li></ul></li></ul></li></ul><a href="#approve" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>approve</span></a><ul><li><ul><li><a href="#what-this-method-does"><span>What this method does</span></a></li><li><a href="#behaviour"><span> behaviour</span></a></li><li><a href="#error-handling"><span>Error handling</span></a></li><li><a href="#when-it-is-used"><span>When it is used</span></a></li></ul></li></ul><a href="#attempt" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>attempt</span></a><ul><li><ul><li><a href="#when-this-method-is-called"><span>When this method is called</span></a></li><li><a href="#what-you-can-do-in"><span>What you can do in </span></a></li><li><a href="#parameters"><span>Parameters</span></a></li></ul></li></ul><a href="#attemptskey" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>attempts<wbr/>Key</span></a><ul><li><ul><li><ul><li><a href="#example-key"><span>Example key</span></a></li></ul></li></ul></li></ul><a href="#batcherror" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>batch<wbr/>Error</span></a><ul><li><ul><li><ul><li><a href="#parameters-1"><span>Parameters</span></a></li><li><a href="#typical-usage-override-example"><span>Typical usage (override example)</span></a></li></ul></li></ul></li></ul><a href="#buildbatches" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>build<wbr/>Batches</span></a><ul><li><ul><li><ul><li><a href="#why-batching-is-needed"><span>Why batching is needed</span></a></li><li><a href="#what-this-method-does-to-each-task"><span>What this method does to each task</span></a></li><li><a href="#batch-splitting-logic"><span>Batch splitting logic</span></a></li><li><a href="#return-value"><span>Return value</span></a></li><li><a href="#when-to-use"><span>When to use</span></a></li></ul></li></ul></li></ul><a href="#clearattempts" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>clear<wbr/>Attempts</span></a><ul><li><ul><li><ul><li><a href="#how-it-works"><span>How it works</span></a></li><li><a href="#when-it-is-invoked"><span>When it is invoked</span></a></li><li><a href="#example-23"><span>Example</span></a></li></ul></li></ul></li></ul><a href="#consumer" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>consumer</span></a><ul><li><ul><li><ul><li><a href="#format"><span>Format</span></a></li><li><a href="#why-this-matters"><span>Why this matters</span></a></li><li><a href="#how-it-is-used"><span>How it is used</span></a></li><li><a href="#customization"><span>Customization</span></a></li></ul></li></ul></li></ul><a href="#consumerloop"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>consumer<wbr/>Loop</span></a><a href="#creategroup" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>create<wbr/>Group</span></a><ul><li><ul><li><ul><li><a href="#where-it-is-used"><span>Where it is used</span></a></li></ul></li></ul></li></ul><a href="#error" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>error</span></a><ul><li><ul><li><a href="#what-this-method-does-1"><span>What this method does</span></a></li><li><ul><li><a href="#1-updates-execution-status-counters-optional"><span>1. <wbr/>Updates execution-<wbr/>status counters (optional)</span></a></li><li><a href="#2-forwards-the-error-to-the-user-hook-onerror"><span>2. <wbr/>Forwards the error to the user hook on<wbr/>Error</span></a></li><li><a href="#3-earlier-in-the-flow-the-retry-counter-has-already-been-incremented"><span>3. (<wbr/>Earlier in the flow) the retry counter has already been incremented</span></a></li></ul></li><li><a href="#error-behaviour"><span>Error behaviour</span></a></li><li><a href="#relation-to-other-methods"><span>Relation to other methods</span></a></li><li><a href="#parameters-2"><span>Parameters</span></a></li><li><a href="#example-override"><span>Example override</span></a></li></ul></li></ul><a href="#execute" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>execute</span></a><ul><li><ul><li><a href="#input-format"><span>Input format</span></a></li><li><a href="#execution-strategy"><span>Execution strategy</span></a></li><li><a href="#after-per-task-execution"><span>After per-<wbr/>task execution</span></a></li><li><a href="#error-handling-1"><span>Error handling</span></a></li><li><a href="#return-value-1"><span>Return value</span></a></li></ul></li></ul><a href="#executeprocess" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>execute<wbr/>Process</span></a><ul><li><ul><li><a href="#control-flow"><span>Control flow</span></a></li><li><ul><li><a href="#1-idempotent-path-when-is-non-empty"><span>1. <wbr/>Idempotent path (when  is non-<wbr/>empty)</span></a></li><li><a href="#2-non-idempotent-path-when-is-empty"><span>2. <wbr/>Non-<wbr/>idempotent path (when  is empty)</span></a></li></ul></li><li><a href="#return-value-2"><span>Return value</span></a></li><li><a href="#parameters-3"><span>Parameters</span></a></li></ul></li></ul><a href="#getattempts" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>get<wbr/>Attempts</span></a><ul><li><ul><li><ul><li><a href="#how-it-works-1"><span>How it works</span></a></li><li><a href="#when-it-is-used-1"><span>When it is used</span></a></li><li><a href="#error-behaviour-1"><span>Error behaviour</span></a></li><li><a href="#example-25"><span>Example</span></a></li></ul></li></ul></li></ul><a href="#heartbeat" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>heartbeat</span></a><ul><li><ul><li><ul><li><a href="#how-it-works-2"><span>How it works</span></a></li><li><a href="#returned-function"><span>Returned function</span></a></li></ul></li></ul></li></ul><a href="#idempotency" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency</span></a><ul><li><ul><li><ul><li><a href="#high-level-flow"><span>High-<wbr/>level flow</span></a></li><li><a href="#when-to-use-1"><span>When to use</span></a></li></ul></li></ul></li></ul><a href="#idempotencyallow" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Allow</span></a><ul><li><ul><li><ul><li><a href="#return-codes"><span>Return codes</span></a></li><li><a href="#example-usage-simplified"><span>Example usage (simplified)</span></a></li></ul></li></ul></li></ul><a href="#idempotencydone" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Done</span></a><ul><li><ul><li><ul><li><a href="#typical-call-site-inside-idempotency"><span>Typical call site (inside idempotency)</span></a></li></ul></li></ul></li></ul><a href="#idempotencyfree" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Free</span></a><ul><li><ul><li><ul><li><a href="#what-the-lua-script-does"><span>What the <wbr/>Lua script does</span></a></li><li><a href="#difference-from-idempotencydone"><span>Difference from idempotency<wbr/>Done</span></a></li><li><a href="#typical-usage-inside-idempotency"><span>Typical usage (inside idempotency)</span></a></li></ul></li></ul></li></ul><a href="#idempotencykeys" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Keys</span></a><ul><li><ul><li><ul><li><a href="#what-it-generates"><span>What it generates</span></a></li><li><a href="#example-key-layout"><span>Example key layout</span></a></li></ul></li></ul></li></ul><a href="#idempotencystart" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>idempotency<wbr/>Start</span></a><ul><li><ul><li><ul><li><a href="#what-the-script-does"><span>What the script does</span></a></li><li><a href="#why-this-step-exists"><span>Why this step exists</span></a></li><li><a href="#typical-usage-inside-idempotency-1"><span>Typical usage (inside idempotency)</span></a></li></ul></li></ul></li></ul><a href="#incrattempts" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>incr<wbr/>Attempts</span></a><ul><li><ul><li><ul><li><a href="#what-this-method-does-2"><span>What this method does</span></a></li><li><a href="#error-behaviour-2"><span>Error behaviour</span></a></li><li><a href="#when-it-is-used-2"><span>When it is used</span></a></li><li><a href="#example-26"><span>Example</span></a></li></ul></li></ul></li></ul><a href="#keyslength" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>keys<wbr/>Length</span></a><ul><li><ul><li><ul><li><a href="#how-the-count-is-computed"><span>How the count is computed</span></a></li><li><a href="#what-this-method-inspects"><span>What this method inspects</span></a></li><li><a href="#why-this-matters-1"><span>Why this matters</span></a></li><li><a href="#example-27"><span>Example</span></a></li></ul></li></ul></li></ul><a href="#loadscript" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>load<wbr/>Script</span></a><a href="#loadscripts"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>load<wbr/>Scripts</span></a><a href="#normalizeentries" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>normalize<wbr/>Entries</span></a><ul><li><ul><li><ul><li><a href="#steps-performed"><span>Steps performed</span></a></li><li><a href="#example-transformation"><span>Example transformation</span></a></li><li><a href="#why-this-method-exists"><span>Why this method exists</span></a></li></ul></li></ul></li></ul><a href="#onbatcherror"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Batch<wbr/>Error</span></a><a href="#onerror"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Error</span></a><a href="#onexecute"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Execute</span></a><a href="#onready"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Ready</span></a><a href="#onretry"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Retry</span></a><a href="#onselected"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Selected</span></a><a href="#onsuccess"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>on<wbr/>Success</span></a><a href="#payload" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>payload</span></a><ul><li><ul><li><ul><li><a href="#behaviour-1"><span>Behaviour</span></a></li><li><a href="#why-this-method-exists-1"><span>Why this method exists</span></a></li><li><a href="#example-38"><span>Example</span></a></li><li><a href="#usage"><span>Usage</span></a></li></ul></li></ul></li></ul><a href="#payloadbatch" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>payload<wbr/>Batch</span></a><ul><li><ul><li><ul><li><a href="#how-it-works-3"><span>How it works</span></a></li><li><a href="#task-input-rules"><span>Task input rules</span></a></li><li><a href="#id-and-value-encoding"><span>ID and value encoding</span></a></li><li><a href="#batching-behaviour"><span>Batching behaviour</span></a></li><li><a href="#options-"><span>Options ()</span></a></li><li><a href="#return-value-3"><span>Return value</span></a></li></ul></li></ul></li></ul><a href="#runqueue"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>run<wbr/>Queue</span></a><a href="#runscript" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>run<wbr/>Script</span></a><a href="#savescript" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>save<wbr/>Script</span></a><a href="#select" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>select</span></a><ul><li><ul><li><ul><li><a href="#how-it-works-4"><span>How it works</span></a></li><li><a href="#returned-structure"><span>Returned structure</span></a></li><li><a href="#usage-1"><span>Usage</span></a></li></ul></li></ul></li></ul><a href="#selectfresh" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>select<wbr/>Fresh</span></a><ul><li><ul><li><ul><li><a href="#returned-data"><span>Returned data</span></a></li><li><a href="#error-handling-2"><span>Error handling</span></a></li><li><a href="#typical-usage-indirect"><span>Typical usage (indirect)</span></a></li></ul></li></ul></li></ul><a href="#selectstuck" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>select<wbr/>Stuck</span></a><ul><li><ul><li><ul><li><a href="#what-the-lua-script-does-high-level"><span>What the <wbr/>Lua script does (high-<wbr/>level)</span></a></li><li><a href="#why-recovering-stuck-tasks-first"><span>Why recovering stuck tasks first?</span></a></li><li><a href="#error-handling-3"><span>Error handling</span></a></li><li><a href="#return-format"><span>Return format</span></a></li><li><a href="#typical-usage-indirect-1"><span>Typical usage (indirect)</span></a></li></ul></li></ul></li></ul><a href="#sendheartbeat" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>send<wbr/>Heartbeat</span></a><ul><li><ul><li><ul><li><a href="#why-this-matters-2"><span>Why this matters</span></a></li><li><a href="#return-value-4"><span>Return value</span></a></li><li><a href="#typical-usage"><span>Typical usage</span></a></li></ul></li></ul></li></ul><a href="#signal" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>signal</span></a><ul><li><ul><li><ul><li><a href="#why-this-exists"><span>Why this exists</span></a></li><li><a href="#how-it-is-used-1"><span>How it is used</span></a></li><li><a href="#example-43"><span>Example</span></a></li><li><a href="#returns"><span>Returns</span></a></li></ul></li></ul></li></ul><a href="#success" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>success</span></a><ul><li><ul><li><a href="#what-this-method-does-3"><span>What this method does</span></a></li><li><ul><li><a href="#1-updates-execution-status-counters-optional-1"><span>1. <wbr/>Updates execution-<wbr/>status counters (optional)</span></a></li><li><a href="#2-calls-the-user-hook-onsuccess"><span>2. <wbr/>Calls the user hook on<wbr/>Success</span></a></li></ul></li><li><a href="#when-this-method-is-triggered"><span>When this method is triggered</span></a></li><li><a href="#error-handling-4"><span>Error handling</span></a></li><li><a href="#example-44"><span>Example</span></a></li></ul></li></ul><a href="#values" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>values</span></a><ul><li><ul><li><ul><li><a href="#how-it-works-5"><span>How it works</span></a></li><li><a href="#example-45"><span>Example</span></a></li></ul></li></ul></li></ul><a href="#waitabortable" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>wait<wbr/>Abortable</span></a><ul><li><ul><li><ul><li><a href="#how-the-delay-is-calculated"><span>How the delay is calculated</span></a></li><li><a href="#abort-behaviour"><span>Abort behaviour</span></a></li><li><a href="#typical-usage-1"><span>Typical usage</span></a></li></ul></li></ul></li></ul><a href="#xaddbatch" class="tsd-is-private"><svg class="tsd-kind-icon" viewBox="0 0 24 24" aria-label="Method"><use href="../assets/icons.svg#icon-2048"></use></svg><span>xadd<wbr/>Batch</span></a></div></details></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html">power-queues API Docs - v2.0.16</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
